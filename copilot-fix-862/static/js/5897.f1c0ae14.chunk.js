"use strict";(self.webpackChunksgex_workbench=self.webpackChunksgex_workbench||[]).push([[5897],{55897:(e,a,n)=>{n.r(a),n.d(a,{default:()=>m});var o=n(89379),i=n(9950),t=n(85001),s=n(67818),r=n(29946),l=n(29473),c=n(42676),d=n(1932),u=n(63609);const h=e=>{if(!e)return!1;if(!0===e.isSAMLError)return!0;const a=e.message||"",n=a.toLowerCase();return 403===e.status&&(n.includes("saml enforcement")||n.includes("saml single sign-on")||n.includes("saml authorization required")||a.includes("must grant your Personal Access token access to this organization"))},g=e=>{const a=window.location.origin+window.location.pathname,n="".concat(a,"?saml_authorized=1&org=").concat(e);return"https://github.com/orgs/".concat(e,"/sso?return_to=").concat(encodeURIComponent(n))};var f=n(44414);const m=()=>{const{t:e}=(0,s.Bd)(),[a,n]=(0,i.useState)(null),[m,p]=(0,i.useState)([]),[A,v]=(0,i.useState)(!1),[z,x]=(0,i.useState)(!1),[S,b]=(0,i.useState)(null),[j,w]=(0,i.useState)({}),[L,O]=(0,i.useState)(null),[M,N]=(0,i.useState)({isOpen:!1,errorInfo:null}),k=(0,i.useRef)(!1),y=(0,t.Zp)(),C=(0,t.zy)(),H=(0,i.useCallback)((e,a)=>{if(!r.A.isAuth())return;const n={};if(e){const a=l.A.getCachedRepositories(e.login,"user");a&&a.repositories&&(n["user-".concat(e.login)]=a.repositories.length)}a.forEach(e=>{const a=l.A.getCachedRepositories(e.login,"org");a&&a.repositories&&(n["org-".concat(e.login)]=a.repositories.length)}),w(n)},[]),W=(0,i.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(k.current)return;k.current=!0,x(!0),b(null);const a=r.A.isAuth();console.log("fetchUserData: Current authentication state:",a,"forceRefresh:",e);try{const s=e?null:l.A.getCachedProfile(a);var i;if(s&&!e)return console.log("Using cached profile data",{organizationCount:(null===(i=s.organizations)||void 0===i?void 0:i.length)||0,hasUser:!!s.user,cacheAge:Date.now()-s.timestamp}),n(s.user),p(s.organizations),a&&H(s.user,s.organizations),x(!1),void(k.current=!1);console.log("No cached profile data found or forcing refresh, fetching fresh data");let c=null;a?(await r.A.checkTokenPermissions(),c=await r.A.getCurrentUser(),n(c)):(c=null,n(null));let d=[];if(a)try{d=await r.A.getUserOrganizations()}catch(S){console.error("Error fetching organizations:",S),d=[]}try{const e=await r.A.getWHOOrganization(),a=d.findIndex(e=>"WorldHealthOrganization"===e.login);a>=0?d[a]=(0,o.A)((0,o.A)((0,o.A)({},d[a]),e),{},{isWHO:!0}):d.unshift(e),console.log("WHO organization loaded successfully (no SAML needed)")}catch(t){console.warn("Could not fetch WHO organization data from API, using fallback:",t);const e=h(t);console.log("SAML Error Detection:",{isSAMLRequired:e,whoError:t.message,status:t.status,currentIsAuthenticated:a}),e&&(console.log("SAML authorization available for WHO organization"),O("SAML authorization available for WHO organization. Click the organization to authorize access."));const n={id:"who-organization",login:"WorldHealthOrganization",name:"World Health Organization",description:"The World Health Organization is a specialized agency of the United Nations responsible for international public health.",avatar_url:"https://avatars.githubusercontent.com/u/12261302?s=200&v=4",html_url:"https://github.com/WorldHealthOrganization",type:"Organization",isWHO:!0,needsSAMLAuth:e};console.log("Creating WHO fallback organization:",{login:n.login,needsSAMLAuth:n.needsSAMLAuth,isWHO:n.isWHO});d.some(e=>"WorldHealthOrganization"===e.login)?d=d.map(a=>"WorldHealthOrganization"===a.login?(0,o.A)((0,o.A)({},a),{},{isWHO:!0,needsSAMLAuth:e}):a):d.unshift(n)}p(d),l.A.setCachedProfile(c,d,a),console.log("Profile data cached for 5 minutes"),a&&H(c,d)}catch(S){console.error("Error fetching user data:",S),a?(b("Failed to fetch user data. Please check your connection and try again."),v(!1),r.A.logout()):b("Unable to fetch additional data. Some features may be limited.")}finally{x(!1),k.current=!1}},[H]),P=e=>{const a=function(e,a){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{isRequired:o=!1,context:i="access organization data"}=n;return{type:"saml_enforcement",organization:a,isRequired:o,context:i,authorizationURL:g(a),documentationURL:"https://docs.github.com/articles/authenticating-to-a-github-organization-with-saml-single-sign-on/",title:o?"SAML Authorization Required":"SAML Authorization Available",message:o?"Access to ".concat(a," requires SAML authorization to ").concat(i,"."):"Your Personal Access Token can be authorized for ".concat(a," to ").concat(i,"."),instructions:['Click the "Authorize SAML" button to navigate to GitHub\'s authorization page',"Sign in to your organization's SAML identity provider if prompted",'Click "Authorize" to grant your Personal Access Token access to '.concat(a),"You'll be automatically redirected back to SGEX Workbench after authorization"],severity:o?"error":"warning"}}(new Error("SAML authorization required"),e,{isRequired:!1,context:"access additional organization features"});N({isOpen:!0,errorInfo:a})};(0,i.useEffect)(()=>{(()=>{const e=r.A.initializeFromStoredToken();e!==A&&(l.A.clearAllProfileCaches(),console.log("Authentication state changed, cleared profile cache")),v(!!e)})()},[A]),(0,i.useEffect)(()=>{var e;null!==(e=C.state)&&void 0!==e&&e.warningMessage&&(O(C.state.warningMessage),y(C.pathname,{replace:!0,state:{}}))},[C.state,y,C.pathname]),(0,i.useEffect)(()=>{const e=new URLSearchParams(window.location.search),a=document.referrer,n=a&&a.includes("github.com"),o="1"===e.get("saml_authorized"),i=e.has("code")||e.has("state")||o;if((n||o||i)&&(console.log("Detected potential return from SAML authorization",{fromGitHub:n,samlAuthorized:o,hasAuthParams:i,organization:e.get("org")}),l.A.clearAllProfileCaches(),o&&O(null),A&&W(!0),i)){const e=new URL(window.location);e.search="",window.history.replaceState({},document.title,e.href)}},[A,W]),(0,i.useEffect)(()=>{W()},[W]);const R=(e,a)=>{if(a.needsSAMLAuth&&A)return e.preventDefault(),void P(a.login);const n={profile:a};(0,d.hX)(e,"/dak-action/".concat(a.login),y,n)};return(0,f.jsxs)(c.Mx,{pageName:"select-profile",children:[z&&!a?(0,f.jsxs)("div",{className:"loading-section",children:[(0,f.jsx)("div",{className:"spinner"}),(0,f.jsx)("p",{children:"Loading profile data..."})]}):(0,f.jsxs)("div",{className:"select-profile-content",children:[L&&(0,f.jsx)("div",{className:"warning-message",children:(0,f.jsxs)("div",{className:"warning-content",children:[(0,f.jsxs)("div",{className:"warning-header",children:[(0,f.jsx)("span",{className:"warning-icon",children:"\u26a0\ufe0f"}),(0,f.jsx)("span",{className:"warning-text",children:L})]}),(0,f.jsx)("button",{className:"warning-dismiss",onClick:()=>{O(null)},"aria-label":"Dismiss warning",children:"\xd7 Dismiss"})]})}),!A&&(0,f.jsx)("div",{className:"auth-status-message",children:(0,f.jsxs)("div",{className:"auth-status-content",children:[(0,f.jsx)("span",{className:"auth-status-icon",children:"\ud83d\udd13"}),(0,f.jsx)("span",{className:"auth-status-text",children:"You are browsing in unauthenticated mode. Some features like saving to GitHub will be disabled, but you can still explore and use local staging."})]})}),z?(0,f.jsxs)("div",{className:"loading-section",children:[(0,f.jsx)("div",{className:"spinner"}),(0,f.jsx)("p",{children:"Loading profile data..."})]}):(0,f.jsxs)("div",{className:"profile-selection",children:[(0,f.jsx)("h2",{children:e("organization.select")}),(0,f.jsxs)("p",{children:[e("organization.personal"),":"]}),S&&(0,f.jsx)("div",{className:"error-message",children:S}),(0,f.jsxs)("div",{className:"profile-grid-horizontal",children:[A&&a&&(0,f.jsxs)("div",{className:"profile-card",onClick:e=>R(e,(0,o.A)({type:"user"},a)),children:[(0,f.jsxs)("div",{className:"profile-card-header",children:[(0,f.jsx)("img",{src:null===a||void 0===a?void 0:a.avatar_url,alt:"Personal profile"}),j["user-".concat(null===a||void 0===a?void 0:a.login)]>0&&(0,f.jsx)("div",{className:"dak-count-badge",children:j["user-".concat(null===a||void 0===a?void 0:a.login)]})]}),(0,f.jsx)("h3",{children:(null===a||void 0===a?void 0:a.name)||(null===a||void 0===a?void 0:a.login)}),(0,f.jsx)("p",{children:"Personal repositories"}),(0,f.jsx)("div",{className:"profile-badges",children:(0,f.jsx)("span",{className:"profile-type",children:"Personal"})})]}),m.map(a=>("WorldHealthOrganization"===a.login&&console.log("WHO Organization Badge Debug (Render Time):",{orgLogin:a.login,needsSAMLAuth:a.needsSAMLAuth,isAuthenticated:A,githubServiceAuth:r.A.isAuth(),shouldShowBadge:a.needsSAMLAuth&&A,samlIndicatorCondition:a.needsSAMLAuth&&A,samlBadgeCondition:a.needsSAMLAuth&&A,orgObject:a}),(0,f.jsxs)("div",{className:"profile-card ".concat(a.isWHO?"who-org":""," ").concat(a.needsSAMLAuth?"needs-saml":""),onClick:e=>R(e,(0,o.A)({type:"org"},a)),children:[(0,f.jsxs)("div",{className:"profile-card-header",children:[(0,f.jsx)("img",{src:a.avatar_url||"https://github.com/".concat(a.login,".png"),alt:"".concat(a.name||a.login," organization")}),j["org-".concat(a.login)]>0&&(0,f.jsx)("div",{className:"dak-count-badge",children:j["org-".concat(a.login)]}),a.needsSAMLAuth&&A&&(0,f.jsx)("div",{className:"saml-indicator",title:"SAML authorization available",children:"\ud83d\udd10"})]}),(0,f.jsx)("h3",{children:a.name||a.login}),(0,f.jsxs)("p",{children:["@",a.login]}),(0,f.jsxs)("div",{className:"profile-badges",children:[(0,f.jsx)("span",{className:"profile-type",children:e("organization.organizations")}),a.isWHO&&(0,f.jsx)("span",{className:"who-badge",children:"WHO Official"}),a.needsSAMLAuth&&A&&(0,f.jsx)("span",{className:"saml-badge",children:"SAML Available"})]})]},a.login)))]})]})]}),(0,f.jsx)(u.A,{isOpen:M.isOpen,onClose:()=>N({isOpen:!1,errorInfo:null}),samlErrorInfo:M.errorInfo,onRetry:()=>{var e;return(async e=>{try{l.A.clearProfileCache(r.A.isAuth()),await W(!0),console.log("SAML authorization verification completed for ".concat(e)),O(null),N({isOpen:!1,errorInfo:null})}catch(S){if(h(S))return void console.log("SAML authorization still pending for ".concat(e,". This is normal - authorization may take a few moments to propagate."));console.error("Unexpected error during SAML authorization verification:",S),N({isOpen:!1,errorInfo:null})}})(null===(e=M.errorInfo)||void 0===e?void 0:e.organization)},onSkip:()=>{N({isOpen:!1,errorInfo:null}),O(null)}})]})}}}]);