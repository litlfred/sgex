"use strict";(self.webpackChunksgex_workbench=self.webpackChunksgex_workbench||[]).push([[5897],{55897:(e,o,a)=>{a.r(o),a.d(o,{default:()=>f});var t=a(89379),n=a(9950),r=a(85001),i=a(67818),s=a(29946),l=a(29473),c=a(42676),d=a(1932),u=a(63609);const g=e=>{if(!e)return!1;if(!0===e.isSAMLError)return!0;const o=e.message||"",a=o.toLowerCase();return 403===e.status&&(a.includes("saml enforcement")||a.includes("saml single sign-on")||a.includes("saml authorization required")||o.includes("must grant your Personal Access token access to this organization"))},h=e=>{const o=window.location.origin,a=window.location.pathname,t="".concat(o).concat(a,"?saml_authorized=1&org=").concat(e);try{localStorage.setItem("saml_return_url",t),localStorage.setItem("saml_org",e),localStorage.setItem("saml_timestamp",Date.now().toString()),console.log("Stored SAML return info in localStorage:",{returnUrl:t,organization:e})}catch(i){console.warn("Could not store SAML return info in localStorage:",i)}console.log("SAML Authorization URL Debug:",{origin:o,pathname:a,isGitHubPages:o.includes("github.io"),returnUrl:t,encodedReturnUrl:encodeURIComponent(t),organization:e});const n=encodeURIComponent(t),r="https://github.com/orgs/".concat(e,"/sso?return_to=").concat(n);return console.log("Final SAML authorization URL:",r),console.log("Expected return after SAML:",t),r};var m=a(44414);const f=()=>{const{t:e}=(0,i.Bd)(),[o,a]=(0,n.useState)(null),[f,A]=(0,n.useState)([]),[p,z]=(0,n.useState)(!1),[S,v]=(0,n.useState)(!1),[w,L]=(0,n.useState)(null),[x,b]=(0,n.useState)({}),[M,O]=(0,n.useState)(null),[j,y]=(0,n.useState)({isOpen:!1,errorInfo:null}),k=(0,n.useRef)(!1),N=(0,r.Zp)(),C=(0,r.zy)(),H=(0,n.useCallback)((e,o)=>{if(!s.A.isAuth())return;const a={};if(e){const o=l.A.getCachedRepositories(e.login,"user");o&&o.repositories&&(a["user-".concat(e.login)]=o.repositories.length)}o.forEach(e=>{const o=l.A.getCachedRepositories(e.login,"org");o&&o.repositories&&(a["org-".concat(e.login)]=o.repositories.length)}),b(a)},[]),I=(0,n.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(k.current)return;k.current=!0,v(!0),L(null);const n=s.A.isAuth();console.log("fetchUserData: Current authentication state:",n,"forceRefresh:",e,"samlAuthorizedOrg:",o);try{const c=e?null:l.A.getCachedProfile(n);var r;if(c&&!e)return console.log("Using cached profile data",{organizationCount:(null===(r=c.organizations)||void 0===r?void 0:r.length)||0,hasUser:!!c.user,cacheAge:Date.now()-c.timestamp}),a(c.user),A(c.organizations),n&&H(c.user,c.organizations),v(!1),void(k.current=!1);console.log("No cached profile data found or forcing refresh, fetching fresh data");let d=null;n?(await s.A.checkTokenPermissions(),d=await s.A.getCurrentUser(),a(d)):(d=null,a(null));let u=[];if(n)try{u=await s.A.getUserOrganizations()}catch(w){console.error("Error fetching organizations:",w),u=[]}try{const e=await s.A.getWHOOrganization(),o=u.findIndex(e=>"WorldHealthOrganization"===e.login);o>=0?u[o]=(0,t.A)((0,t.A)((0,t.A)({},u[o]),e),{},{isWHO:!0}):u.unshift(e),console.log("WHO organization loaded successfully (no SAML needed)")}catch(i){console.warn("Could not fetch WHO organization data from API, using fallback:",i);const e=g(i),a="WorldHealthOrganization"===o;console.log("SAML Error Detection:",{isSAMLRequired:e,whoError:i.message,status:i.status,currentIsAuthenticated:n,samlAuthorizedOrg:o,samlOverride:a}),e&&!a?(console.log("SAML authorization available for WHO organization"),O("SAML authorization available for WHO organization. Click the organization to authorize access.")):a&&console.log("SAML authorization recently completed for WHO organization, treating as authorized");const r={id:"who-organization",login:"WorldHealthOrganization",name:"World Health Organization",description:"The World Health Organization is a specialized agency of the United Nations responsible for international public health.",avatar_url:"https://avatars.githubusercontent.com/u/12261302?s=200&v=4",html_url:"https://github.com/WorldHealthOrganization",type:"Organization",isWHO:!0,needsSAMLAuth:!a&&e};console.log("Creating WHO fallback organization:",{login:r.login,needsSAMLAuth:r.needsSAMLAuth,isWHO:r.isWHO,samlOverride:a});u.some(e=>"WorldHealthOrganization"===e.login)?u=u.map(o=>"WorldHealthOrganization"===o.login?(0,t.A)((0,t.A)({},o),{},{isWHO:!0,needsSAMLAuth:!a&&e}):o):u.unshift(r)}A(u),l.A.setCachedProfile(d,u,n),console.log("Profile data cached for 5 minutes"),n&&H(d,u)}catch(w){console.error("Error fetching user data:",w),n?(L("Failed to fetch user data. Please check your connection and try again."),z(!1),s.A.logout()):L("Unable to fetch additional data. Some features may be limited.")}finally{v(!1),k.current=!1}},[H]),_=e=>{const o=function(e,o){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{isRequired:t=!1,context:n="access organization data"}=a;return{type:"saml_enforcement",organization:o,isRequired:t,context:n,authorizationURL:h(o),documentationURL:"https://docs.github.com/articles/authenticating-to-a-github-organization-with-saml-single-sign-on/",title:t?"SAML Authorization Required":"SAML Authorization Available",message:t?"Access to ".concat(o," requires SAML authorization to ").concat(n,"."):"Your Personal Access Token can be authorized for ".concat(o," to ").concat(n,"."),instructions:['Click the "Authorize SAML" button to navigate to GitHub\'s authorization page',"Sign in to your organization's SAML identity provider if prompted",'Click "Authorize" to grant your Personal Access Token access to '.concat(o),"You'll be automatically redirected back to SGEX Workbench after authorization"],severity:t?"error":"warning"}}(new Error("SAML authorization required"),e,{isRequired:!1,context:"access additional organization features"});y({isOpen:!0,errorInfo:o})};(0,n.useEffect)(()=>{(()=>{const e=s.A.initializeFromStoredToken();e!==p&&(l.A.clearAllProfileCaches(),console.log("Authentication state changed, cleared profile cache")),z(!!e)})()},[p]),(0,n.useEffect)(()=>{var e;null!==(e=C.state)&&void 0!==e&&e.warningMessage&&(O(C.state.warningMessage),N(C.pathname,{replace:!0,state:{}}))},[C.state,N,C.pathname]),(0,n.useEffect)(()=>{const e=(()=>{const e=new URLSearchParams(window.location.search),o="1"===e.get("saml_authorized"),a=e.get("org");if(o&&a)return console.log("SAML return detected via URL parameters"),{organization:a,method:"url_params"};const t=document.referrer;if(t&&t.includes("github.com"))try{const e=localStorage.getItem("saml_return_url"),o=localStorage.getItem("saml_org"),a=localStorage.getItem("saml_timestamp"),t=a&&Date.now()-parseInt(a)<6e5;if(o&&t){console.log("SAML return detected via localStorage fallback",{organization:o,storedReturnUrl:e,timestamp:new Date(parseInt(a))}),localStorage.removeItem("saml_return_url"),localStorage.removeItem("saml_org"),localStorage.removeItem("saml_timestamp");const t=new URL(window.location);return t.searchParams.set("saml_authorized","1"),t.searchParams.set("org",o),window.history.replaceState({},document.title,t.href),{organization:o,method:"localStorage_fallback"}}}catch(n){console.warn("Error checking localStorage for SAML return data:",n)}return null})(),o=new URLSearchParams(window.location.search),a=o.has("code")||o.has("state");if(console.log("SAML Return Detection Debug:",{currentUrl:window.location.href,referrer:document.referrer,samlReturnInfo:e,hasOAuthParams:a,urlParams:Array.from(o.entries())}),e||a){const n=null===e||void 0===e?void 0:e.organization;if(console.log("Detected return from SAML authorization",{method:null===e||void 0===e?void 0:e.method,organization:n,hasOAuthParams:a}),l.A.clearAllProfileCaches(),e&&(O(null),n&&p&&(console.log("SAML authorization completed for ".concat(n,", immediately clearing SAML requirements")),A(e=>e.map(e=>e.login===n?(0,t.A)((0,t.A)({},e),{},{needsSAMLAuth:!1}):e)))),p&&I(!0,n||null),a||o.has("saml_authorized")){const e=new URL(window.location);["code","state","saml_authorized","org"].forEach(o=>{e.searchParams.delete(o)}),window.history.replaceState({},document.title,e.href)}}},[p,I]),(0,n.useEffect)(()=>{I()},[I]);const R=(e,o)=>{if(o.needsSAMLAuth&&p)return e.preventDefault(),void _(o.login);const a={profile:o};(0,d.hX)(e,"/dak-action/".concat(o.login),N,a)};return(0,m.jsxs)(c.Mx,{pageName:"select-profile",children:[S&&!o?(0,m.jsxs)("div",{className:"loading-section",children:[(0,m.jsx)("div",{className:"spinner"}),(0,m.jsx)("p",{children:"Loading profile data..."})]}):(0,m.jsxs)("div",{className:"select-profile-content",children:[M&&(0,m.jsx)("div",{className:"warning-message",children:(0,m.jsxs)("div",{className:"warning-content",children:[(0,m.jsxs)("div",{className:"warning-header",children:[(0,m.jsx)("span",{className:"warning-icon",children:"\u26a0\ufe0f"}),(0,m.jsx)("span",{className:"warning-text",children:M})]}),(0,m.jsx)("button",{className:"warning-dismiss",onClick:()=>{O(null)},"aria-label":"Dismiss warning",children:"\xd7 Dismiss"})]})}),!p&&(0,m.jsx)("div",{className:"auth-status-message",children:(0,m.jsxs)("div",{className:"auth-status-content",children:[(0,m.jsx)("span",{className:"auth-status-icon",children:"\ud83d\udd13"}),(0,m.jsx)("span",{className:"auth-status-text",children:"You are browsing in unauthenticated mode. Some features like saving to GitHub will be disabled, but you can still explore and use local staging."})]})}),S?(0,m.jsxs)("div",{className:"loading-section",children:[(0,m.jsx)("div",{className:"spinner"}),(0,m.jsx)("p",{children:"Loading profile data..."})]}):(0,m.jsxs)("div",{className:"profile-selection",children:[(0,m.jsx)("h2",{children:e("organization.select")}),(0,m.jsxs)("p",{children:[e("organization.personal"),":"]}),w&&(0,m.jsx)("div",{className:"error-message",children:w}),(0,m.jsxs)("div",{className:"profile-grid-horizontal",children:[p&&o&&(0,m.jsxs)("div",{className:"profile-card",onClick:e=>R(e,(0,t.A)({type:"user"},o)),children:[(0,m.jsxs)("div",{className:"profile-card-header",children:[(0,m.jsx)("img",{src:null===o||void 0===o?void 0:o.avatar_url,alt:"Personal profile"}),x["user-".concat(null===o||void 0===o?void 0:o.login)]>0&&(0,m.jsx)("div",{className:"dak-count-badge",children:x["user-".concat(null===o||void 0===o?void 0:o.login)]})]}),(0,m.jsx)("h3",{children:(null===o||void 0===o?void 0:o.name)||(null===o||void 0===o?void 0:o.login)}),(0,m.jsx)("p",{children:"Personal repositories"}),(0,m.jsx)("div",{className:"profile-badges",children:(0,m.jsx)("span",{className:"profile-type",children:"Personal"})})]}),f.map(o=>("WorldHealthOrganization"===o.login&&console.log("WHO Organization Badge Debug (Render Time):",{orgLogin:o.login,needsSAMLAuth:o.needsSAMLAuth,isAuthenticated:p,githubServiceAuth:s.A.isAuth(),shouldShowBadge:o.needsSAMLAuth&&p,samlIndicatorCondition:o.needsSAMLAuth&&p,samlBadgeCondition:o.needsSAMLAuth&&p,orgObject:o}),(0,m.jsxs)("div",{className:"profile-card ".concat(o.isWHO?"who-org":""," ").concat(o.needsSAMLAuth?"needs-saml":""),onClick:e=>R(e,(0,t.A)({type:"org"},o)),children:[(0,m.jsxs)("div",{className:"profile-card-header",children:[(0,m.jsx)("img",{src:o.avatar_url||"https://github.com/".concat(o.login,".png"),alt:"".concat(o.name||o.login," organization")}),x["org-".concat(o.login)]>0&&(0,m.jsx)("div",{className:"dak-count-badge",children:x["org-".concat(o.login)]}),o.needsSAMLAuth&&p&&(0,m.jsx)("div",{className:"saml-indicator",title:"SAML authorization available",children:"\ud83d\udd10"})]}),(0,m.jsx)("h3",{children:o.name||o.login}),(0,m.jsxs)("p",{children:["@",o.login]}),(0,m.jsxs)("div",{className:"profile-badges",children:[(0,m.jsx)("span",{className:"profile-type",children:e("organization.organizations")}),o.isWHO&&(0,m.jsx)("span",{className:"who-badge",children:"WHO Official"}),o.needsSAMLAuth&&p&&(0,m.jsx)("span",{className:"saml-badge",children:"SAML Available"})]})]},o.login)))]})]})]}),(0,m.jsx)(u.A,{isOpen:j.isOpen,onClose:()=>y({isOpen:!1,errorInfo:null}),samlErrorInfo:j.errorInfo,onRetry:()=>{var e;return(async e=>{try{l.A.clearProfileCache(s.A.isAuth()),await I(!0),console.log("SAML authorization verification completed for ".concat(e)),O(null),y({isOpen:!1,errorInfo:null})}catch(w){if(g(w))return void console.log("SAML authorization still pending for ".concat(e,". This is normal - authorization may take a few moments to propagate."));console.error("Unexpected error during SAML authorization verification:",w),y({isOpen:!1,errorInfo:null})}})(null===(e=j.errorInfo)||void 0===e?void 0:e.organization)},onSkip:()=>{y({isOpen:!1,errorInfo:null}),O(null)}})]})}}}]);