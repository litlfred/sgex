name: PR Review Deployment

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  actions: write
  pull-requests: write

jobs:
  check-approval-and-deploy:
    runs-on: ubuntu-latest
    if: github.event.review.state == 'approved'
    
    steps:
      - name: Get PR information
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const branchName = pr.head.ref;
            const baseBranch = pr.base.ref;
            
            console.log(`PR #${pr.number}: ${branchName} -> ${baseBranch}`);
            console.log(`Review state: ${context.payload.review.state}`);
            
            // Filter out branches that should not be deployed
            const excludedBranches = ['gh-pages', 'deploy'];
            if (excludedBranches.includes(branchName)) {
              console.log(`Branch ${branchName} is excluded from automatic deployment`);
              core.setOutput('should_deploy', 'false');
              core.setOutput('reason', `Branch '${branchName}' is excluded from automatic deployment`);
            } else {
              console.log(`Branch ${branchName} is eligible for deployment`);
              core.setOutput('should_deploy', 'true');
              core.setOutput('branch_name', branchName);
              core.setOutput('pr_number', pr.number);
            }
            
            return {
              shouldDeploy: excludedBranches.includes(branchName) ? false : true,
              branchName: branchName,
              prNumber: pr.number,
              baseBranch: baseBranch
            };

      - name: Comment on PR with deployment option
        if: steps.pr_info.outputs.should_deploy == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.pr_info.outputs.branch_name }}';
            const prNumber = '${{ steps.pr_info.outputs.pr_number }}';
            const approvedAt = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
            
            // Check if deployment comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const deploymentComment = comments.find(comment => 
              comment.body.includes('üöÄ Deploy Feature Branch') && 
              comment.body.includes(`branch: ${branchName}`)
            );
            
            const commentBody = `## üöÄ Deploy Feature Branch
            
            **Branch:** \`${branchName}\` | **Approved:** ${approvedAt}
            
            **Deploy action:**
            - üöÄ [Deploy ${branchName}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/workflows/branch-deployment.yml?branch=${encodeURIComponent(branchName)})
            
            **Preview URL:** [https://litlfred.github.io/sgex/${branchName.replace(/\//g, '-')}/](https://litlfred.github.io/sgex/${branchName.replace(/\//g, '-')}/) üìã
            
            ---
            
            üí° *Click deploy link above, then "Run workflow". Branch name will be pre-filled.*`;
            
            if (deploymentComment) {
              // Update existing deployment comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: deploymentComment.id,
                body: commentBody
              });
              console.log(`‚úÖ Updated existing deployment comment on PR #${prNumber}`);
            } else {
              // Create new deployment comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log(`‚úÖ Created new deployment comment on PR #${prNumber}`);
            }

      - name: Comment on excluded branch
        if: steps.pr_info.outputs.should_deploy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.pr_info.outputs.branch_name }}';
            const prNumber = '${{ steps.pr_info.outputs.pr_number }}';
            const reason = '${{ steps.pr_info.outputs.reason }}';
            
            const commentBody = `## ‚ÑπÔ∏è Deployment Skipped
            
            **Branch:** \`${branchName}\` | **Reason:** ${reason}
            
            ---
            
            üí° *Branches \`gh-pages\` and \`deploy\` are excluded from feature deployments.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
            
            console.log(`‚ÑπÔ∏è Posted exclusion comment on PR #${prNumber}`);