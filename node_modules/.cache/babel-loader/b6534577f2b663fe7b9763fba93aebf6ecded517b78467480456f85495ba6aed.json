{"ast":null,"code":"import { forEach, filter } from 'min-dash';\nimport inherits from 'inherits-browser';\nvar LOW_PRIORITY = 250,\n  HIGH_PRIORITY = 1400;\nimport { add as collectionAdd, indexOf as collectionIdx } from '../../util/Collections';\nimport { saveClear } from '../../util/Removal';\nimport CommandInterceptor from '../../command/CommandInterceptor';\n\n/**\n * @typedef {import('../../model/Types').Element} Element\n *\n * @typedef {import('didi').Injector} Injector\n *\n * @typedef {import('../../core/EventBus').default} EventBus\n * @typedef {import('../modeling/Modeling').default} Modeling\n */\n\n/**\n * A handler that makes sure labels are properly moved with\n * their label targets.\n *\n * @param {Injector} injector\n * @param {EventBus} eventBus\n * @param {Modeling} modeling\n */\nexport default function LabelSupport(injector, eventBus, modeling) {\n  CommandInterceptor.call(this, eventBus);\n  var movePreview = injector.get('movePreview', false);\n\n  // remove labels from the collection that are being\n  // moved with other elements anyway\n  eventBus.on('shape.move.start', HIGH_PRIORITY, function (e) {\n    var context = e.context,\n      shapes = context.shapes,\n      validatedShapes = context.validatedShapes;\n    context.shapes = removeLabels(shapes);\n    context.validatedShapes = removeLabels(validatedShapes);\n  });\n\n  // add labels to visual's group\n  movePreview && eventBus.on('shape.move.start', LOW_PRIORITY, function (e) {\n    var context = e.context,\n      shapes = context.shapes;\n    var labels = [];\n    forEach(shapes, function (element) {\n      forEach(element.labels, function (label) {\n        if (!label.hidden && context.shapes.indexOf(label) === -1) {\n          labels.push(label);\n        }\n        if (element.labelTarget) {\n          labels.push(element);\n        }\n      });\n    });\n    forEach(labels, function (label) {\n      movePreview.makeDraggable(context, label, true);\n    });\n  });\n\n  // add all labels to move closure\n  this.preExecuted('elements.move', HIGH_PRIORITY, function (e) {\n    var context = e.context,\n      closure = context.closure,\n      enclosedElements = closure.enclosedElements;\n    var enclosedLabels = [];\n\n    // find labels that are not part of\n    // move closure yet and add them\n    forEach(enclosedElements, function (element) {\n      forEach(element.labels, function (label) {\n        if (!enclosedElements[label.id]) {\n          enclosedLabels.push(label);\n        }\n      });\n    });\n    closure.addAll(enclosedLabels);\n  });\n  this.preExecute(['connection.delete', 'shape.delete'], function (e) {\n    var context = e.context,\n      element = context.connection || context.shape;\n    saveClear(element.labels, function (label) {\n      modeling.removeShape(label, {\n        nested: true\n      });\n    });\n  });\n  this.execute('shape.delete', function (e) {\n    var context = e.context,\n      shape = context.shape,\n      labelTarget = shape.labelTarget;\n\n    // unset labelTarget\n    if (labelTarget) {\n      context.labelTargetIndex = collectionIdx(labelTarget.labels, shape);\n      context.labelTarget = labelTarget;\n      shape.labelTarget = null;\n    }\n  });\n  this.revert('shape.delete', function (e) {\n    var context = e.context,\n      shape = context.shape,\n      labelTarget = context.labelTarget,\n      labelTargetIndex = context.labelTargetIndex;\n\n    // restore labelTarget\n    if (labelTarget) {\n      collectionAdd(labelTarget.labels, shape, labelTargetIndex);\n      shape.labelTarget = labelTarget;\n    }\n  });\n}\ninherits(LabelSupport, CommandInterceptor);\nLabelSupport.$inject = ['injector', 'eventBus', 'modeling'];\n\n/**\n * Return a filtered list of elements that do not\n * contain attached elements with hosts being part\n * of the selection.\n *\n * @param {Element[]} elements\n *\n * @return {Element[]} filtered\n */\nfunction removeLabels(elements) {\n  return filter(elements, function (element) {\n    // filter out labels that are move together\n    // with their label targets\n    return elements.indexOf(element.labelTarget) === -1;\n  });\n}","map":{"version":3,"names":["forEach","filter","inherits","LOW_PRIORITY","HIGH_PRIORITY","add","collectionAdd","indexOf","collectionIdx","saveClear","CommandInterceptor","LabelSupport","injector","eventBus","modeling","call","movePreview","get","on","e","context","shapes","validatedShapes","removeLabels","labels","element","label","hidden","push","labelTarget","makeDraggable","preExecuted","closure","enclosedElements","enclosedLabels","id","addAll","preExecute","connection","shape","removeShape","nested","execute","labelTargetIndex","revert","$inject","elements"],"sources":["/home/runner/work/sgex/sgex/node_modules/diagram-js/lib/features/label-support/LabelSupport.js"],"sourcesContent":["import {\n  forEach,\n  filter\n} from 'min-dash';\n\nimport inherits from 'inherits-browser';\n\nvar LOW_PRIORITY = 250,\n    HIGH_PRIORITY = 1400;\n\nimport {\n  add as collectionAdd,\n  indexOf as collectionIdx\n} from '../../util/Collections';\n\nimport { saveClear } from '../../util/Removal';\n\nimport CommandInterceptor from '../../command/CommandInterceptor';\n\n/**\n * @typedef {import('../../model/Types').Element} Element\n *\n * @typedef {import('didi').Injector} Injector\n *\n * @typedef {import('../../core/EventBus').default} EventBus\n * @typedef {import('../modeling/Modeling').default} Modeling\n */\n\n/**\n * A handler that makes sure labels are properly moved with\n * their label targets.\n *\n * @param {Injector} injector\n * @param {EventBus} eventBus\n * @param {Modeling} modeling\n */\nexport default function LabelSupport(injector, eventBus, modeling) {\n\n  CommandInterceptor.call(this, eventBus);\n\n  var movePreview = injector.get('movePreview', false);\n\n  // remove labels from the collection that are being\n  // moved with other elements anyway\n  eventBus.on('shape.move.start', HIGH_PRIORITY, function(e) {\n\n    var context = e.context,\n        shapes = context.shapes,\n        validatedShapes = context.validatedShapes;\n\n    context.shapes = removeLabels(shapes);\n    context.validatedShapes = removeLabels(validatedShapes);\n  });\n\n  // add labels to visual's group\n  movePreview && eventBus.on('shape.move.start', LOW_PRIORITY, function(e) {\n\n    var context = e.context,\n        shapes = context.shapes;\n\n    var labels = [];\n\n    forEach(shapes, function(element) {\n\n      forEach(element.labels, function(label) {\n\n        if (!label.hidden && context.shapes.indexOf(label) === -1) {\n          labels.push(label);\n        }\n\n        if (element.labelTarget) {\n          labels.push(element);\n        }\n      });\n    });\n\n    forEach(labels, function(label) {\n      movePreview.makeDraggable(context, label, true);\n    });\n\n  });\n\n  // add all labels to move closure\n  this.preExecuted('elements.move', HIGH_PRIORITY, function(e) {\n    var context = e.context,\n        closure = context.closure,\n        enclosedElements = closure.enclosedElements;\n\n    var enclosedLabels = [];\n\n    // find labels that are not part of\n    // move closure yet and add them\n    forEach(enclosedElements, function(element) {\n      forEach(element.labels, function(label) {\n\n        if (!enclosedElements[label.id]) {\n          enclosedLabels.push(label);\n        }\n      });\n    });\n\n    closure.addAll(enclosedLabels);\n  });\n\n\n  this.preExecute([\n    'connection.delete',\n    'shape.delete'\n  ], function(e) {\n\n    var context = e.context,\n        element = context.connection || context.shape;\n\n    saveClear(element.labels, function(label) {\n      modeling.removeShape(label, { nested: true });\n    });\n  });\n\n\n  this.execute('shape.delete', function(e) {\n\n    var context = e.context,\n        shape = context.shape,\n        labelTarget = shape.labelTarget;\n\n    // unset labelTarget\n    if (labelTarget) {\n      context.labelTargetIndex = collectionIdx(labelTarget.labels, shape);\n      context.labelTarget = labelTarget;\n\n      shape.labelTarget = null;\n    }\n  });\n\n  this.revert('shape.delete', function(e) {\n\n    var context = e.context,\n        shape = context.shape,\n        labelTarget = context.labelTarget,\n        labelTargetIndex = context.labelTargetIndex;\n\n    // restore labelTarget\n    if (labelTarget) {\n      collectionAdd(labelTarget.labels, shape, labelTargetIndex);\n\n      shape.labelTarget = labelTarget;\n    }\n  });\n\n}\n\ninherits(LabelSupport, CommandInterceptor);\n\nLabelSupport.$inject = [\n  'injector',\n  'eventBus',\n  'modeling'\n];\n\n\n/**\n * Return a filtered list of elements that do not\n * contain attached elements with hosts being part\n * of the selection.\n *\n * @param {Element[]} elements\n *\n * @return {Element[]} filtered\n */\nfunction removeLabels(elements) {\n\n  return filter(elements, function(element) {\n\n    // filter out labels that are move together\n    // with their label targets\n    return elements.indexOf(element.labelTarget) === -1;\n  });\n}\n"],"mappings":"AAAA,SACEA,OAAO,EACPC,MAAM,QACD,UAAU;AAEjB,OAAOC,QAAQ,MAAM,kBAAkB;AAEvC,IAAIC,YAAY,GAAG,GAAG;EAClBC,aAAa,GAAG,IAAI;AAExB,SACEC,GAAG,IAAIC,aAAa,EACpBC,OAAO,IAAIC,aAAa,QACnB,wBAAwB;AAE/B,SAASC,SAAS,QAAQ,oBAAoB;AAE9C,OAAOC,kBAAkB,MAAM,kCAAkC;;AAEjE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,SAASC,YAAYA,CAACC,QAAQ,EAAEC,QAAQ,EAAEC,QAAQ,EAAE;EAEjEJ,kBAAkB,CAACK,IAAI,CAAC,IAAI,EAAEF,QAAQ,CAAC;EAEvC,IAAIG,WAAW,GAAGJ,QAAQ,CAACK,GAAG,CAAC,aAAa,EAAE,KAAK,CAAC;;EAEpD;EACA;EACAJ,QAAQ,CAACK,EAAE,CAAC,kBAAkB,EAAEd,aAAa,EAAE,UAASe,CAAC,EAAE;IAEzD,IAAIC,OAAO,GAAGD,CAAC,CAACC,OAAO;MACnBC,MAAM,GAAGD,OAAO,CAACC,MAAM;MACvBC,eAAe,GAAGF,OAAO,CAACE,eAAe;IAE7CF,OAAO,CAACC,MAAM,GAAGE,YAAY,CAACF,MAAM,CAAC;IACrCD,OAAO,CAACE,eAAe,GAAGC,YAAY,CAACD,eAAe,CAAC;EACzD,CAAC,CAAC;;EAEF;EACAN,WAAW,IAAIH,QAAQ,CAACK,EAAE,CAAC,kBAAkB,EAAEf,YAAY,EAAE,UAASgB,CAAC,EAAE;IAEvE,IAAIC,OAAO,GAAGD,CAAC,CAACC,OAAO;MACnBC,MAAM,GAAGD,OAAO,CAACC,MAAM;IAE3B,IAAIG,MAAM,GAAG,EAAE;IAEfxB,OAAO,CAACqB,MAAM,EAAE,UAASI,OAAO,EAAE;MAEhCzB,OAAO,CAACyB,OAAO,CAACD,MAAM,EAAE,UAASE,KAAK,EAAE;QAEtC,IAAI,CAACA,KAAK,CAACC,MAAM,IAAIP,OAAO,CAACC,MAAM,CAACd,OAAO,CAACmB,KAAK,CAAC,KAAK,CAAC,CAAC,EAAE;UACzDF,MAAM,CAACI,IAAI,CAACF,KAAK,CAAC;QACpB;QAEA,IAAID,OAAO,CAACI,WAAW,EAAE;UACvBL,MAAM,CAACI,IAAI,CAACH,OAAO,CAAC;QACtB;MACF,CAAC,CAAC;IACJ,CAAC,CAAC;IAEFzB,OAAO,CAACwB,MAAM,EAAE,UAASE,KAAK,EAAE;MAC9BV,WAAW,CAACc,aAAa,CAACV,OAAO,EAAEM,KAAK,EAAE,IAAI,CAAC;IACjD,CAAC,CAAC;EAEJ,CAAC,CAAC;;EAEF;EACA,IAAI,CAACK,WAAW,CAAC,eAAe,EAAE3B,aAAa,EAAE,UAASe,CAAC,EAAE;IAC3D,IAAIC,OAAO,GAAGD,CAAC,CAACC,OAAO;MACnBY,OAAO,GAAGZ,OAAO,CAACY,OAAO;MACzBC,gBAAgB,GAAGD,OAAO,CAACC,gBAAgB;IAE/C,IAAIC,cAAc,GAAG,EAAE;;IAEvB;IACA;IACAlC,OAAO,CAACiC,gBAAgB,EAAE,UAASR,OAAO,EAAE;MAC1CzB,OAAO,CAACyB,OAAO,CAACD,MAAM,EAAE,UAASE,KAAK,EAAE;QAEtC,IAAI,CAACO,gBAAgB,CAACP,KAAK,CAACS,EAAE,CAAC,EAAE;UAC/BD,cAAc,CAACN,IAAI,CAACF,KAAK,CAAC;QAC5B;MACF,CAAC,CAAC;IACJ,CAAC,CAAC;IAEFM,OAAO,CAACI,MAAM,CAACF,cAAc,CAAC;EAChC,CAAC,CAAC;EAGF,IAAI,CAACG,UAAU,CAAC,CACd,mBAAmB,EACnB,cAAc,CACf,EAAE,UAASlB,CAAC,EAAE;IAEb,IAAIC,OAAO,GAAGD,CAAC,CAACC,OAAO;MACnBK,OAAO,GAAGL,OAAO,CAACkB,UAAU,IAAIlB,OAAO,CAACmB,KAAK;IAEjD9B,SAAS,CAACgB,OAAO,CAACD,MAAM,EAAE,UAASE,KAAK,EAAE;MACxCZ,QAAQ,CAAC0B,WAAW,CAACd,KAAK,EAAE;QAAEe,MAAM,EAAE;MAAK,CAAC,CAAC;IAC/C,CAAC,CAAC;EACJ,CAAC,CAAC;EAGF,IAAI,CAACC,OAAO,CAAC,cAAc,EAAE,UAASvB,CAAC,EAAE;IAEvC,IAAIC,OAAO,GAAGD,CAAC,CAACC,OAAO;MACnBmB,KAAK,GAAGnB,OAAO,CAACmB,KAAK;MACrBV,WAAW,GAAGU,KAAK,CAACV,WAAW;;IAEnC;IACA,IAAIA,WAAW,EAAE;MACfT,OAAO,CAACuB,gBAAgB,GAAGnC,aAAa,CAACqB,WAAW,CAACL,MAAM,EAAEe,KAAK,CAAC;MACnEnB,OAAO,CAACS,WAAW,GAAGA,WAAW;MAEjCU,KAAK,CAACV,WAAW,GAAG,IAAI;IAC1B;EACF,CAAC,CAAC;EAEF,IAAI,CAACe,MAAM,CAAC,cAAc,EAAE,UAASzB,CAAC,EAAE;IAEtC,IAAIC,OAAO,GAAGD,CAAC,CAACC,OAAO;MACnBmB,KAAK,GAAGnB,OAAO,CAACmB,KAAK;MACrBV,WAAW,GAAGT,OAAO,CAACS,WAAW;MACjCc,gBAAgB,GAAGvB,OAAO,CAACuB,gBAAgB;;IAE/C;IACA,IAAId,WAAW,EAAE;MACfvB,aAAa,CAACuB,WAAW,CAACL,MAAM,EAAEe,KAAK,EAAEI,gBAAgB,CAAC;MAE1DJ,KAAK,CAACV,WAAW,GAAGA,WAAW;IACjC;EACF,CAAC,CAAC;AAEJ;AAEA3B,QAAQ,CAACS,YAAY,EAAED,kBAAkB,CAAC;AAE1CC,YAAY,CAACkC,OAAO,GAAG,CACrB,UAAU,EACV,UAAU,EACV,UAAU,CACX;;AAGD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAStB,YAAYA,CAACuB,QAAQ,EAAE;EAE9B,OAAO7C,MAAM,CAAC6C,QAAQ,EAAE,UAASrB,OAAO,EAAE;IAExC;IACA;IACA,OAAOqB,QAAQ,CAACvC,OAAO,CAACkB,OAAO,CAACI,WAAW,CAAC,KAAK,CAAC,CAAC;EACrD,CAAC,CAAC;AACJ","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}