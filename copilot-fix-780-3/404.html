<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SGEX Workbench</title>
    <!-- Load SGEX route configuration service -->
    <script>
      // Dynamically determine the correct path for routeConfig.js based on deployment context
      (function() {
        var basePath = '';
        var path = window.location.pathname;
        var pathSegments = path.split('/').filter(Boolean);
        
        // For GitHub Pages deployment (e.g., litlfred.github.io/sgex/)
        if (window.location.hostname.endsWith('.github.io')) {
          if (pathSegments.length > 0 && pathSegments[0] === 'sgex') {
            // Check if this is a branch deployment: /sgex/:branch/...
            if (pathSegments.length > 1) {
              // Potential branch deployment - include branch in base path
              basePath = '/sgex/' + pathSegments[1] + '/';
            } else {
              // Main deployment: /sgex/
              basePath = '/sgex/';
            }
          } else {
            basePath = '/';
          }
        } else {
          // For local development or other deployment types
          // Check if we have /sgex/ prefix for local testing of branch deployments
          if (pathSegments.length > 0 && pathSegments[0] === 'sgex') {
            if (pathSegments.length > 1) {
              // Local branch deployment simulation
              basePath = '/sgex/' + pathSegments[1] + '/';
            } else {
              basePath = '/sgex/';
            }
          } else {
            basePath = '/';
          }
        }
        
        // Load routeConfig.js from the correct base path using synchronous XHR
        // This ensures it loads before the main routing logic executes
        try {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', basePath + 'routeConfig.js', false); // Synchronous request
          xhr.send();
          
          if (xhr.status === 200) {
            // Execute the script content
            eval(xhr.responseText);
            console.log('SGEX route configuration loaded successfully from ' + basePath + 'routeConfig.js');
          } else {
            console.error('Failed to load SGEX route configuration from ' + basePath + 'routeConfig.js: HTTP ' + xhr.status);
            
            // Fallback: try loading from main deployment path
            if (basePath !== '/sgex/') {
              console.log('Attempting fallback to main deployment path...');
              var fallbackXhr = new XMLHttpRequest();
              fallbackXhr.open('GET', '/sgex/routeConfig.js', false);
              fallbackXhr.send();
              
              if (fallbackXhr.status === 200) {
                eval(fallbackXhr.responseText);
                console.log('SGEX route configuration loaded successfully from fallback path /sgex/routeConfig.js');
              } else {
                console.error('Fallback also failed: HTTP ' + fallbackXhr.status);
                loadViaScriptTag();
              }
            } else {
              loadViaScriptTag();
            }
          }
        } catch (error) {
          console.error('Error loading SGEX route configuration:', error);
          loadViaScriptTag();
        }
        
        function loadViaScriptTag() {
          // Fallback: try to load via script tag
          var script = document.createElement('script');
          script.src = basePath + 'routeConfig.js';
          script.onerror = function() {
            console.error('Script tag fallback: Failed to load SGEX route configuration from ' + script.src);
            
            // Final fallback: try main deployment path if not already tried
            if (basePath !== '/sgex/') {
              var fallbackScript = document.createElement('script');
              fallbackScript.src = '/sgex/routeConfig.js';
              fallbackScript.onerror = function() {
                console.error('Final fallback failed: ' + fallbackScript.src);
              };
              document.head.appendChild(fallbackScript);
            }
          };
          document.head.appendChild(script);
        }
      })();
    </script>
    <script type="text/javascript">
      // SGEX Dynamic URL Routing for GitHub Pages and Local Deployments
      // Supports branch-first URL patterns: /sgex/:branch/:component/:user/:repo/:branch/:asset
      // Uses dynamic route configuration instead of hardcoded component lists
      // Handles both GitHub Pages (/sgex/ prefixed) and local deployment patterns
      // Note: this 404.html file must be at least 512 bytes for it to work
      // with Internet Explorer (it is currently > 512 bytes)

      (function(l) {
        // Main routing function
        function performRouting() {
          // First check if this is an existing redirect to prevent infinite loops
          if (l.search && l.search.indexOf('?/') === 0) {
            console.error('SGEX 404.html: Detected existing redirect, stopping to prevent infinite loop');
            showErrorPage('Redirect Loop Detected', 
              'This URL has already been processed by the routing system but still resulted in a 404. This may indicate a configuration issue.',
              'routing-loop');
            return;
          }

          var pathSegments = l.pathname.split('/').filter(Boolean);
          
          // Check if this is GitHub Pages deployment
          var isGitHubPages = l.hostname === 'litlfred.github.io' || l.hostname.endsWith('.github.io');
          var routeConfig = getRouteConfiguration();

          if (isGitHubPages) {
            // GitHub Pages deployment - handle /sgex/ prefixed URLs
            handleGitHubPagesDeployment(pathSegments, l, routeConfig);
          } else {
            // Local deployment - handle both /sgex/ prefixed and root-level URLs
            handleLocalDeployment(pathSegments, l, routeConfig);
          }
        }

        // Ensure DOM is loaded before performing routing
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', performRouting);
        } else {
          // DOM already loaded, execute immediately
          performRouting();
        }

        function handleGitHubPagesDeployment(pathSegments, l, routeConfig) {
          // GitHub Pages deployment - check URL pattern
          if (pathSegments.length === 0 || pathSegments[0] !== 'sgex') {
            showErrorPage('Invalid URL Pattern', 
              'Expected URL to start with /sgex/ but got: ' + l.pathname,
              'invalid-base-path');
            return;
          }

          if (pathSegments.length === 1) {
            // Just /sgex/ - redirect to root
            redirectToSPA('/sgex/', '');
            return;
          }

          // Check if second segment is a deployed branch
          var secondSegment = pathSegments[1];
          
          if (routeConfig && routeConfig.isDeployedBranch && routeConfig.isDeployedBranch(secondSegment)) {
            // Branch deployment pattern: /sgex/:branch/:component/...
            handleBranchDeployment(pathSegments, l, routeConfig, '/sgex/');
          } else if (routeConfig && routeConfig.isValidComponent && routeConfig.isValidComponent(secondSegment)) {
            // Component-first pattern: /sgex/:component/:user/:repo/:branch
            handleComponentFirst(pathSegments, l, '/sgex/');
          } else if (pathSegments.length === 3 && pathSegments[2] === 'index.html') {
            // Branch deployment with index.html: /sgex/:branch/index.html
            // Redirect to the branch root which should load the welcome page
            var branchPath = '/sgex/' + secondSegment + '/';
            console.log('SGEX Branch Deployment Redirect (index.html):', {
              from: l.pathname,
              to: branchPath,
              branch: secondSegment
            });
            l.replace(l.protocol + '//' + l.host + branchPath);
          } else {
            // Handle unknown branch-only URLs by redirecting to branch root  
            if (pathSegments.length === 2) {
              // Just /sgex/:unknown-branch/ - redirect to branch root
              console.log('SGEX Branch Root Redirect (unknown branch):', {
                from: l.pathname,
                branch: secondSegment,
                note: 'Unknown branch name, redirecting to branch root'
              });
              var branchPath = '/sgex/' + secondSegment + '/';
              redirectToSPA(branchPath, '');
              return;
            }

            // Before showing error, check if this could be a branch-first pattern
            // If we have at least 3 segments and the third segment is a valid component,
            // treat the second segment as a branch name regardless of deployed status
            if (pathSegments.length >= 3 && 
                routeConfig && 
                routeConfig.isValidComponent && 
                routeConfig.isValidComponent(pathSegments[2])) {
              // Treat as branch deployment: /sgex/:branch/:component/...
              console.log('SGEX Branch Deployment (undeployed branch):', {
                from: l.pathname,
                branch: secondSegment,
                component: pathSegments[2],
                note: 'Branch not in deployedBranches list, but treating as valid branch'
              });
              handleBranchDeployment(pathSegments, l, routeConfig, '/sgex/');
            } else {
              // Unknown pattern - show error
              showErrorPage('Unknown URL Pattern', 
                'The URL pattern is not recognized. Expected either /sgex/:branch/:component or /sgex/:component/:user/:repo (with optional :branch/:asset) but got: ' + l.pathname,
                'unknown-pattern');
            }
          }
        }

        function handleLocalDeployment(pathSegments, l, routeConfig) {
          // Local deployment - support both /sgex/ prefixed and root-level URLs
          var hasStandardPrefix = pathSegments.length > 0 && pathSegments[0] === 'sgex';
          var basePath = hasStandardPrefix ? '/sgex/' : '/';
          var relevantSegments = hasStandardPrefix ? pathSegments : ['sgex'].concat(pathSegments);

          if (relevantSegments.length <= 1) {
            // Root path - redirect to SPA root
            redirectToSPA(basePath, '');
            return;
          }

          // Check if first meaningful segment is a deployed branch
          var firstSegment = relevantSegments[1];
          
          if (routeConfig && routeConfig.isDeployedBranch && routeConfig.isDeployedBranch(firstSegment)) {
            // Branch deployment pattern: /:branch/:component/... or /sgex/:branch/:component/...
            handleBranchDeployment(relevantSegments, l, routeConfig, basePath);
          } else if (routeConfig && routeConfig.isValidComponent && routeConfig.isValidComponent(firstSegment)) {
            // Component-first pattern: /:component/:user/:repo/... or /sgex/:component/:user/:repo/...
            handleComponentFirst(relevantSegments, l, basePath);
          } else {
            // Simple SPA routing for unknown patterns
            var routePath = hasStandardPrefix ? pathSegments.slice(1).join('/') : pathSegments.join('/');
            if (routePath) {
              redirectToSPA(basePath, routePath);
            } else {
              redirectToSPA(basePath, '');
            }
          }
        }

        function handleStandaloneDeployment(pathSegments, l) {
          // Legacy function - kept for backward compatibility
          var routePath = pathSegments.join('/');
          if (routePath) {
            redirectToSPA('/', routePath);
          }
        }

        function handleBranchDeployment(pathSegments, l, routeConfig, basePath) {
          if (pathSegments.length < 3) {
            // Just /:branch/ - redirect to branch root
            var branchPath = basePath + pathSegments[1] + '/';
            redirectToSPA(branchPath, '');
            return;
          }

          var branch = pathSegments[1];
          var component = pathSegments[2];
          
          // Validate component exists in the deployed branch
          if (!routeConfig.isValidComponent(component)) {
            showErrorPage('Invalid Component', 
              'Component "' + component + '" is not valid for branch "' + branch + '". Check the component name and try again.',
              'invalid-component-for-branch');
            return;
          }

          // Special handling for documentation and pages components
          // These components expect /:docId or /:pageId parameters, not DAK patterns
          if (component === 'docs' || component === 'pages') {
            var branchPath = basePath + pathSegments[1] + '/';
            var routePath = pathSegments.slice(2).join('/');
            
            // If there's no additional path after the component name, route to the base component
            if (pathSegments.length === 3) {
              redirectToSPA(branchPath, component);
            } else {
              // If there's an additional path segment, treat it as a document/page ID
              redirectToSPA(branchPath, routePath);
            }
            return;
          }

          // Route to branch SPA: basePath:branch/?/:component/...
          // This handles all DAK patterns including:
          // - /sgex/:branch/:component (basic component access)
          // - /sgex/:branch/:component/:user/:repo (DAK repository access)
          // - /sgex/:branch/:component/:user/:repo/:branch (specific branch access)
          // - /sgex/:branch/:component/:user/:repo/:branch/:asset (asset pages)
          var branchPath = basePath + pathSegments[1] + '/';
          var routePath = pathSegments.slice(2).join('/');
          redirectToSPA(branchPath, routePath);
        }

        function handleComponentFirst(pathSegments, l, basePath) {
          // Component-first pattern: /:component/:user/:repo/:branch
          // Also handles asset pages: /:component/:user/:repo/:branch/:asset
          // Route to main SPA: basePath?/:component/...
          // This preserves all path segments including asset identifiers
          var routePath = pathSegments.slice(1).join('/'); // Remove prefix
          redirectToSPA(basePath, routePath);
        }

        function redirectToSPA(basePath, routePath) {
          var newUrl = l.protocol + '//' + l.host + basePath;
          
          if (routePath) {
            newUrl += '?/' + routePath.replace(/&/g, '~and~');
          }
          
          if (l.search) {
            newUrl += (routePath ? '&' : '?') + l.search.slice(1).replace(/&/g, '~and~');
          }
          
          newUrl += l.hash;
          
          console.log('SGEX SPA Routing Redirect:', {
            from: l.pathname,
            to: newUrl,
            basePath: basePath,
            routePath: routePath
          });
          
          l.replace(newUrl);
        }

        function getRouteConfiguration() {
          if (typeof window.getSGEXRouteConfig === 'function') {
            return window.getSGEXRouteConfig();
          }
          
          // Enhanced logging to show which file was attempted and why it failed
          var deploymentType = 'main'; // default
          if (l.pathname === '/' || l.pathname === '/sgex/' || l.pathname.endsWith('/branch-listing')) {
            deploymentType = 'deploy';
          }
          
          var configFileName = deploymentType === 'deploy' ? './routes-config.deploy.json' : './routes-config.json';
          var attemptedUrl = l.protocol + '//' + l.host + l.pathname.replace(/[^/]*$/, '') + configFileName;
          
          console.warn('SGEX route configuration not available - falling back to basic routing', {
            attemptedConfigFile: configFileName,
            attemptedUrl: attemptedUrl,
            deploymentType: deploymentType,
            currentPath: l.pathname,
            reason: 'window.getSGEXRouteConfig function not available or routeConfig.js failed to load'
          });
          return null;
        }

        function showErrorPage(title, message, errorCode) {
          var bugReportUrl = 'https://github.com/litlfred/sgex/issues/new?' + 
            'title=' + encodeURIComponent('[URL Routing Error] ' + title) +
            '&body=' + encodeURIComponent(
              'Error Code: ' + errorCode + '\n\n' +
              'URL: ' + l.href + '\n' +
              'Hostname: ' + l.hostname + '\n' +
              'Path: ' + l.pathname + '\n' +
              'Search: ' + l.search + '\n' +
              'Hash: ' + l.hash + '\n\n' +
              'Message: ' + message + '\n\n' +
              'Please describe what you were trying to do when this error occurred:'
            ) +
            '&labels=' + encodeURIComponent('bug,routing');

          var errorHTML = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; text-align: center;">' +
              '<h1 style="color: #d73527;">SGEX URL Routing Error</h1>' +
              '<h2>' + title + '</h2>' +
              '<p style="background: #f5f5f5; padding: 15px; border-radius: 5px; text-align: left;">' + message + '</p>' +
              '<p><strong>Error Code:</strong> ' + errorCode + '</p>' +
              '<div style="margin: 30px 0;">' +
                '<a href="https://litlfred.github.io/sgex/" style="background: #0078d4; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">Go to SGEX Home</a>' +
                '<a href="' + bugReportUrl + '" target="_blank" style="background: #d73527; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">Report Bug</a>' +
              '</div>' +
              '<p style="color: #666; font-size: 12px;">If you think this is a bug, please use the "Report Bug" button to help us fix it.</p>' +
            '</div>';

          // Ensure DOM is ready before setting innerHTML
          function setErrorHTML() {
            if (document.body) {
              document.body.innerHTML = errorHTML;
            } else {
              // DOM not ready yet, wait for it
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                  document.body.innerHTML = errorHTML;
                });
              } else {
                // DOM should be ready, but body still doesn't exist - create it
                setTimeout(function() {
                  if (document.body) {
                    document.body.innerHTML = errorHTML;
                  } else {
                    // Last resort: create a basic error display
                    document.write('<body>' + errorHTML + '</body>');
                  }
                }, 10);
              }
            }
          }
          
          setErrorHTML();
        }

      })(window.location);
    </script>
  </head>
  <body>
    <!-- This 404.html handles dynamic SPA routing for SGEX -->
    <!-- Supports branch-first patterns: /sgex/:branch/:component/:user/:repo/:branch/:asset -->
    <!-- Works for both GitHub Pages and local deployments (npm install) -->
    <!-- Uses route configuration instead of hardcoded component lists -->
    <!-- Includes proper error handling and bug reporting -->
  </body>
</html>