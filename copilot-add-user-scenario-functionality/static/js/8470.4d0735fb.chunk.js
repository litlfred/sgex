"use strict";(self.webpackChunksgex_workbench=self.webpackChunksgex_workbench||[]).push([[8470],{41838:(e,a,t)=>{t.d(a,{A:()=>c});var s=t(89379),n=t(9950),r=t(57561),i=t(44414);const o=(0,n.lazy)(()=>Promise.all([t.e(3738),t.e(7845),t.e(2383),t.e(5743)]).then(t.bind(t,25743))),c=e=>{let{page:a,onClose:t,onSave:c,title:l,enablePreview:d=!1,variableHelper:h=null,additionalMetadata:p={},onContentChange:u=null}=e;const[m,g]=(0,n.useState)(null!==a&&void 0!==a&&a.content?atob(a.content.content):""),[v,x]=(0,n.useState)(!1),[j,b]=(0,n.useState)("edit");if(!a)return null;return(0,i.jsx)("div",{className:"page-edit-modal-overlay",onClick:e=>{e.target===e.currentTarget&&t()},children:(0,i.jsxs)("div",{className:"page-edit-modal",children:[(0,i.jsxs)("div",{className:"page-edit-modal-header",children:[(0,i.jsx)("h2",{children:l||"Edit ".concat(a.title)}),(0,i.jsxs)("div",{className:"header-actions",children:[d&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{className:"btn-toggle ".concat("edit"===j?"active":""),onClick:()=>b("edit"),disabled:v,title:"Edit mode",children:"\u270f\ufe0f Edit"}),(0,i.jsx)("button",{className:"btn-toggle ".concat("preview"===j?"active":""),onClick:()=>b("preview"),disabled:v,title:"Preview mode",children:"\ud83d\udc41\ufe0f Preview"}),(0,i.jsx)("div",{className:"toolbar-separator"})]}),(0,i.jsx)("button",{className:"btn-secondary",onClick:t,disabled:v,children:"Cancel"}),(0,i.jsx)("button",{className:"btn-primary",onClick:async()=>{x(!0);try{const e=(0,s.A)({title:a.title||l,filename:a.filename,tool:p.tool||"PageEditor",contentType:"markdown"},p);if(!r.A.updateFile(a.path,m,e))throw new Error("Failed to save to staging ground");c&&await c(a,m,"staged"),t()}catch(e){console.error("Failed to save page:",e),alert("Failed to save page to staging ground. Please try again.")}finally{x(!1)}},disabled:v,children:v?"Staging...":"Stage Changes"})]})]}),(0,i.jsxs)("div",{className:"page-edit-modal-content",children:[(0,i.jsxs)("div",{className:"page-info",children:[(0,i.jsx)("span",{className:"page-filename",children:a.filename}),(0,i.jsx)("span",{className:"page-path",children:a.path})]}),h&&(0,i.jsx)("div",{className:"variable-helper-toolbar",children:h}),(0,i.jsx)("div",{className:"md-editor-container",children:(0,i.jsx)(n.Suspense,{fallback:(0,i.jsx)("div",{className:"loading-spinner",children:"Loading editor..."}),children:(0,i.jsx)(o,{value:m,onChange:e=>{const a=e||"";g(a),u&&u(a)},preview:d?j:"edit",height:500,visibleDragBar:!1,"data-color-mode":"light",hideToolbar:v})})})]})]})})}},78470:(e,a,t)=>{t.r(a),t.d(a,{default:()=>u});var s=t(9950),n=t(69396),r=t(46901),i=t(57561),o=t(89379);const c=new class{constructor(){this.actorCache=new Map,this.cacheTimeout=3e5}async getActors(e,a,t){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const{useCache:n=!0,includeStaging:r=!0}=s,i="".concat(e,"/").concat(a,"/").concat(t);if(n&&this.actorCache.has(i)){const e=this.actorCache.get(i);if(Date.now()-e.timestamp<this.cacheTimeout)return e.actors}try{const s=[];if(r){const e=await this.loadActorsFromStagingGround();s.push(...e)}return(await this.loadActorsFromGitHub(e,a,t)).forEach(e=>{-1===s.findIndex(a=>a.id===e.id)&&s.push(e)}),this.actorCache.set(i,{actors:s,timestamp:Date.now()}),s}catch(o){return console.error("Error loading actors:",o),[]}}async loadActorsFromStagingGround(){try{const a=i.A.getStagingGround(),t=[],s=a.files.filter(e=>e.path.startsWith("input/fsh/actors/")&&e.path.endsWith(".fsh")||e.path.startsWith("input/actors/")&&e.path.endsWith(".json"));for(const n of s)try{if(n.path.endsWith(".fsh")){const e=await this.parseFSHActor(n.content);e&&t.push((0,o.A)((0,o.A)({},e),{},{source:"staging-fsh",staged:!0}))}else if(n.path.endsWith(".json")){const e=this.parseFHIRActor(n.content);e&&t.push((0,o.A)((0,o.A)({},e),{},{source:"staging-fhir",staged:!0}))}}catch(e){console.warn("Failed to parse staged actor from ".concat(n.path,":"),e)}return t}catch(e){return console.warn("Error loading actors from staging ground:",e),[]}}async loadActorsFromGitHub(e,a,t){const s=[];try{const i=await r.A.octokit.rest.repos.getContent({owner:e,repo:a,path:"input/fsh/actors",ref:t}),c=(Array.isArray(i.data)?i.data:[i.data]).filter(e=>e.name.endsWith(".fsh"));for(const l of c)try{const n=await r.A.octokit.rest.repos.getContent({owner:e,repo:a,path:l.path,ref:t}),i=atob(n.data.content),c=await this.parseFSHActor(i);c&&s.push((0,o.A)((0,o.A)({},c),{},{source:"github-fsh",staged:!1}))}catch(n){console.warn("Failed to load actor from ".concat(l.name,":"),n)}}catch(n){}try{const i=await r.A.octokit.rest.repos.getContent({owner:e,repo:a,path:"input/actors",ref:t}),c=(Array.isArray(i.data)?i.data:[i.data]).filter(e=>e.name.endsWith(".json"));for(const l of c)try{const n=await r.A.octokit.rest.repos.getContent({owner:e,repo:a,path:l.path,ref:t}),i=atob(n.data.content),c=this.parseFHIRActor(i);c&&s.push((0,o.A)((0,o.A)({},c),{},{source:"github-fhir",staged:!1}))}catch(n){console.warn("Failed to load actor from ".concat(l.name,":"),n)}}catch(n){}return s}async parseFSHActor(e){try{const a=e.match(/Profile:\s+([A-Za-z0-9-]+)/);if(!a)return null;const t=a[1],s=e.match(/Title:\s*"([^"]+)"/i),n=e.match(/Description:\s*"([^"]+)"/i);return{id:t,title:s?s[1]:t,description:n?n[1]:"",type:"actor"}}catch(a){return console.warn("Error parsing FSH actor:",a),null}}parseFHIRActor(e){try{const n="string"===typeof e?JSON.parse(e):e;var a,t,s;return"Person"===n.resourceType||"Practitioner"===n.resourceType?{id:n.id||"unknown",title:(null===(a=n.name)||void 0===a||null===(t=a[0])||void 0===t?void 0:t.text)||n.id||"Unknown",description:(null===(s=n.text)||void 0===s?void 0:s.div)||"",type:n.resourceType}:null}catch(n){return console.warn("Error parsing FHIR actor:",n),null}}clearCache(){this.actorCache.clear()}clearCacheForRepo(e,a,t){const s="".concat(e,"/").concat(a,"/").concat(t);this.actorCache.delete(s)}subscribeToStagingGroundChanges(){i.A.addListener(()=>{this.clearCache()})}};c.subscribeToStagingGroundChanges();const l=c;var d=t(41838),h=t(32675),p=t(44414);const u=()=>{var e,a;const{user:t,repo:o,branch:c}=(0,n.g)(),u=(0,n.zy)(),m=(0,n.Zp)(),{profile:g,repository:v,selectedBranch:x}=u.state||{},[j,b]=(0,s.useState)([]),[f,y]=(0,s.useState)([]),[w,N]=(0,s.useState)(!0),[A,S]=(0,s.useState)(null),[C,k]=(0,s.useState)(!1),[F,E]=(0,s.useState)(null),[I,D]=(0,s.useState)(!1),[H,T]=(0,s.useState)(""),[P,U]=(0,s.useState)(""),W=t||(null===v||void 0===v||null===(e=v.owner)||void 0===e?void 0:e.login)||(null===v||void 0===v||null===(a=v.full_name)||void 0===a?void 0:a.split("/")[0]),G=o||(null===v||void 0===v?void 0:v.name),R=c||x||"main";(0,s.useEffect)(()=>{(async()=>{if(!r.A.isAuth()){const e=sessionStorage.getItem("github_token")||localStorage.getItem("github_token");e&&r.A.authenticate(e)}})()},[]),(0,s.useEffect)(()=>{v&&R&&i.A.initialize(v,R)},[v,R]),(0,s.useEffect)(()=>{(async()=>{if(W&&G)try{const e=await r.A.checkRepositoryWritePermissions(W,G);k(e)}catch(A){console.warn("Could not check write permissions:",A),k(!1)}})()},[W,G]),(0,s.useEffect)(()=>{W&&G&&(async()=>{if(!W||!G)return S("Missing repository information"),void N(!1);try{N(!0),S(null);const e=await z(W,G,R);b(e);const a=await l.getActors(W,G,R);y(a)}catch(A){console.error("Error loading scenarios:",A),S(A.message)}finally{N(!1)}})()},[W,G,R]);const z=async(e,a,t)=>{try{const s=await r.A.octokit.rest.repos.getContent({owner:e,repo:a,path:"input/pagecontent",ref:t}),n=(Array.isArray(s.data)?s.data:[s.data]).filter(e=>"file"===e.type&&e.name.match(/^userscenario-[A-Za-z0-9-]+\.md$/)),i=await Promise.all(n.map(async s=>{try{const n=await r.A.octokit.rest.repos.getContent({owner:e,repo:a,path:s.path,ref:t});return{id:s.name.replace(".md","").replace("userscenario-",""),name:s.name,path:s.path,sha:s.sha,content:n.data}}catch(A){return console.warn("Failed to load content for ".concat(s.name,":"),A),{id:s.name.replace(".md","").replace("userscenario-",""),name:s.name,path:s.path,sha:s.sha,content:null}}}));return i}catch(A){if(404===A.status)return[];throw A}},_=async(e,a)=>{try{const t=[...a.matchAll(/\{\{persona\.([A-Za-z0-9-]+)\./g)].map(e=>e[1]),s=[...new Set(t)],n={id:e,title:e,description:{uri:"input/pagecontent/userscenario-".concat(e,".md")},personas:s.map(e=>{const a=f.find(a=>a.id===e);return{id:e,title:(null===a||void 0===a?void 0:a.title)||e}})};let o=null;try{const e=await r.A.octokit.rest.repos.getContent({owner:W,repo:G,path:"dak.json",ref:R});o=JSON.parse(atob(e.data.content))}catch(A){o={resourceType:"DAK",id:G,userScenarios:[]}}o.userScenarios||(o.userScenarios=[]);const c=o.userScenarios.findIndex(a=>a.id===e);c>=0?o.userScenarios[c]=n:o.userScenarios.push(n),i.A.updateFile("dak.json",JSON.stringify(o,null,2),{title:"DAK Configuration",filename:"dak.json",tool:"UserScenarioEditor",contentType:"json"})}catch(A){console.error("Failed to update DAK JSON:",A)}};return w?(0,p.jsx)("div",{className:"user-scenarios-manager",children:(0,p.jsxs)("div",{className:"loading-container",children:[(0,p.jsx)("div",{className:"loading-spinner"}),(0,p.jsx)("p",{children:"Loading user scenarios..."})]})}):A?(0,p.jsx)("div",{className:"user-scenarios-manager",children:(0,p.jsxs)("div",{className:"error-container",children:[(0,p.jsx)("h2",{children:"Error Loading User Scenarios"}),(0,p.jsx)("p",{children:A}),(0,p.jsx)("button",{onClick:()=>m(-1),children:"Go Back"})]})}):(0,p.jsxs)("div",{className:"user-scenarios-manager",children:[(0,p.jsxs)("div",{className:"user-scenarios-header",children:[(0,p.jsx)("h1",{children:"\ud83d\udc65 User Scenarios"}),(0,p.jsxs)("p",{className:"header-subtitle",children:[W,"/",G," on ",R]})]}),(0,p.jsxs)("div",{className:"user-scenarios-content",children:[(0,p.jsx)(h.A,{repository:{full_name:"".concat(W,"/").concat(G),name:G},selectedBranch:R}),(0,p.jsx)("div",{className:"scenarios-actions",children:(0,p.jsx)("button",{className:"btn-create-new",onClick:()=>{D(!0),T(""),U("")},disabled:!C,title:C?"":"You need write access to create scenarios",children:"\u2795 Create New Scenario"})}),(0,p.jsxs)("div",{className:"scenarios-list",children:[(0,p.jsxs)("h2",{children:["\ud83d\udcc4 Existing User Scenarios (",j.length,")"]}),0===j.length?(0,p.jsxs)("div",{className:"empty-state",children:[(0,p.jsx)("p",{children:"No user scenarios found in input/pagecontent/"}),(0,p.jsx)("p",{className:"empty-state-hint",children:"User scenario files should be named: userscenario-[ID].md"})]}):(0,p.jsx)("div",{className:"scenarios-grid",children:j.map(e=>(0,p.jsxs)("div",{className:"scenario-card",children:[(0,p.jsx)("div",{className:"scenario-card-header",children:(0,p.jsxs)("h3",{children:["\ud83d\udcdd ",e.name]})}),(0,p.jsxs)("div",{className:"scenario-card-body",children:[(0,p.jsxs)("p",{className:"scenario-id",children:["ID: ",e.id]}),(0,p.jsx)("p",{className:"scenario-path",children:e.path})]}),(0,p.jsx)("div",{className:"scenario-card-actions",children:(0,p.jsx)("button",{className:"btn-edit",onClick:()=>(e=>{E(e)})(e),disabled:!C,title:C?"":"You need write access to edit",children:"\u270f\ufe0f Edit"})})]},e.id))})]})]}),I&&(0,p.jsx)("div",{className:"modal-overlay",onClick:()=>D(!1),children:(0,p.jsxs)("div",{className:"modal-dialog",onClick:e=>e.stopPropagation(),children:[(0,p.jsx)("div",{className:"modal-header",children:(0,p.jsx)("h2",{children:"\u2795 Create New User Scenario"})}),(0,p.jsxs)("div",{className:"modal-body",children:[(0,p.jsxs)("div",{className:"form-group",children:[(0,p.jsx)("label",{htmlFor:"scenario-id",children:"Scenario ID"}),(0,p.jsx)("input",{type:"text",id:"scenario-id",className:"form-input ".concat(P?"error":""),value:H,onChange:e=>{T(e.target.value),U("")},placeholder:"e.g., Anc-registration-001",autoFocus:!0}),P&&(0,p.jsx)("div",{className:"error-message",children:P})]}),(0,p.jsxs)("div",{className:"id-requirements",children:[(0,p.jsx)("h4",{children:"\u2139\ufe0f ID Requirements:"}),(0,p.jsxs)("ul",{children:[(0,p.jsx)("li",{children:"\u2713 Must start with a capital letter"}),(0,p.jsx)("li",{children:"\u2713 Can contain letters, numbers, and hyphens"}),(0,p.jsx)("li",{children:"\u2717 Cannot contain underscores"}),(0,p.jsx)("li",{children:"\u2713 Must be unique"})]}),(0,p.jsxs)("p",{className:"id-examples",children:[(0,p.jsx)("strong",{children:"Examples:"}),(0,p.jsx)("br",{}),"\u2705 Anc-registration-001",(0,p.jsx)("br",{}),"\u2705 Health-check",(0,p.jsx)("br",{}),"\u2705 VaccinationRecord",(0,p.jsx)("br",{}),"\u274c anc-registration (must start with capital)",(0,p.jsx)("br",{}),"\u274c Health_check (no underscores)"]})]})]}),(0,p.jsxs)("div",{className:"modal-footer",children:[(0,p.jsx)("button",{className:"btn-secondary",onClick:()=>D(!1),children:"Cancel"}),(0,p.jsx)("button",{className:"btn-primary",onClick:async()=>{const e=(a=H)?/^[A-Z]/.test(a)?/^[A-Za-z0-9-]+$/.test(a)?j.some(e=>e.id.toLowerCase()===a.toLowerCase())?"A scenario with this ID already exists":"":"ID can only contain letters, numbers, and hyphens (no underscores)":"ID must start with a capital letter":"ID is required";var a;if(e)return void U(e);const t="userscenario-".concat(H,".md"),s="input/pagecontent/".concat(t),n={id:H,name:t,path:s,content:{content:btoa("# User Scenario: ".concat(H,"\n\n## Description\n\n[Describe the user scenario here]\n\n## Steps\n\n1. [Step 1]\n2. [Step 2]\n")),encoding:"base64"},filename:t,title:H,isNew:!0};E(n),D(!1)},disabled:!H,children:"Create & Edit"})]})]})}),F&&(0,p.jsx)(d.A,{page:F,title:"Edit User Scenario: ".concat(F.id),onClose:()=>E(null),onSave:async(e,a,t)=>{await _(e.id,a);const s=await z(W,G,R);b(s)},enablePreview:!0,variableHelper:0===f.length?(0,p.jsxs)("div",{className:"variable-helper",children:[(0,p.jsx)("span",{className:"variable-helper-label",children:"\ud83d\udcdd Insert Variable:"}),(0,p.jsx)("span",{className:"variable-helper-empty",children:"No personas found"})]}):(0,p.jsxs)("div",{className:"variable-helper",children:[(0,p.jsx)("span",{className:"variable-helper-label",children:"\ud83d\udcdd Insert Variable:"}),(0,p.jsxs)("select",{className:"variable-helper-select",onChange:e=>{e.target.value&&(navigator.clipboard.writeText(e.target.value),alert("Copied to clipboard: ".concat(e.target.value)),e.target.value="")},children:[(0,p.jsx)("option",{value:"",children:"Select persona property..."}),f.map(e=>(0,p.jsxs)("optgroup",{label:"".concat(e.title).concat(e.staged?" \ud83d\udcdd":""),children:[(0,p.jsxs)("option",{value:"{{persona.".concat(e.id,".title}}"),children:["Insert ",e.title," - title"]}),(0,p.jsxs)("option",{value:"{{persona.".concat(e.id,".description}}"),children:["Insert ",e.title," - description"]}),(0,p.jsxs)("option",{value:"{{persona.".concat(e.id,".id}}"),children:["Insert ",e.title," - id"]})]},e.id))]}),(0,p.jsx)("span",{className:"variable-helper-hint",children:"(Select a variable to copy to clipboard. \ud83d\udcdd = staged changes)"})]}),additionalMetadata:{tool:"UserScenarioEditor",scenarioId:F.id}})]})}}}]);