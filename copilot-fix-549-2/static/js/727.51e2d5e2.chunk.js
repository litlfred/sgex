"use strict";(self.webpackChunksgex_workbench=self.webpackChunksgex_workbench||[]).push([[727],{31727:(e,s,t)=>{t.r(s),t.d(s,{default:()=>c});var i=t(65043),n=t(73537),l=t(93071),a=t(22392);const o=new class{constructor(){this.initialized=!0,this.compilationResults=null,this.logs=[],this.listeners=new Set}async loadFSHFiles(e,s,t){this.log("info","Loading FSH files from ".concat(e.full_name,"/").concat(s));try{const i=await this.loadGitHubFSHFiles(e,s,t);this.log("info","Loaded ".concat(i.length," FSH files from GitHub"));const n=await this.loadStagingGroundFSHFiles();this.log("info","Loaded ".concat(n.length," FSH files from staging ground"));const l=this.mergeFSHFiles(i,n);return this.log("info","Total FSH files after merge: ".concat(l.length)),l}catch(i){throw this.log("error","Failed to load FSH files: ".concat(i.message)),i}}async loadGitHubFSHFiles(e,s,t){const i=[];try{const a=["input/fsh","fsh","input/fsh/profiles","input/fsh/extensions","input/fsh/valuesets","input/fsh/codesystems","input/fsh/examples","input/fsh/rules","input/fsh/aliases"];for(const o of a)try{const n=await l.A.getRepositoryContents(e.owner.login,e.name,o,s,t.token);if(Array.isArray(n))for(const a of n)if("file"===a.type&&a.name.endsWith(".fsh")){const n=await l.A.getFileContent(e.owner.login,e.name,a.path,s,t.token);i.push({path:a.path,name:a.name,content:n,source:"github",size:a.size})}}catch(n){this.log("debug","Directory ".concat(o," not found or inaccessible"))}try{const n=await l.A.getRepositoryContents(e.owner.login,e.name,"",s,t.token);if(Array.isArray(n))for(const a of n)if("file"===a.type&&a.name.endsWith(".fsh")){const n=await l.A.getFileContent(e.owner.login,e.name,a.path,s,t.token);i.push({path:a.path,name:a.name,content:n,source:"github",size:a.size})}}catch(n){this.log("debug","Root directory check failed: ".concat(n.message))}}catch(n){throw this.log("error","Failed to load GitHub FSH files: ".concat(n.message)),n}return i}async loadStagingGroundFSHFiles(){const e=[];try{const s=a.A.getStagingGround();if(s&&s.files)for(const t of s.files)t.path.endsWith(".fsh")&&e.push({path:t.path,name:t.path.split("/").pop(),content:t.content,source:"staging",metadata:t.metadata,timestamp:t.timestamp})}catch(s){throw this.log("error","Failed to load staging ground FSH files: ".concat(s.message)),s}return e}mergeFSHFiles(e,s){const t=[...e];for(const i of s){const e=t.findIndex(e=>e.path===i.path);e>=0?(t[e]=i,this.log("debug","Overriding ".concat(i.path," with staging ground version"))):(t.push(i),this.log("debug","Adding new file ".concat(i.path," from staging ground")))}return t}async loadSushiConfig(e,s,i){try{const n=await l.A.getFileContent(e.owner.login,e.name,"sushi-config.yaml",s,i.token),a=(await t.e(661).then(t.bind(t,55661))).load(n);return this.log("info","Loaded SUSHI configuration: ".concat(a.id||"unnamed")),a}catch(n){throw this.log("error","Failed to load sushi-config.yaml: ".concat(n.message)),n}}async runSUSHI(e,s,t){this.log("info","Starting FSH file loading and analysis..."),this.clearLogs();try{const i=await this.loadFSHFiles(e,s,t),n=await this.loadSushiConfig(e,s,t);if(0===i.length)return this.log("warn","No FSH files found to process"),{success:!1,message:"No FSH files found to process",files:[],logs:this.logs};const l=this.analyzeFSHFiles(i);return this.compilationResults={files:i,config:n,analysis:l},this.log("info","FSH file loading and analysis completed"),this.notifyListeners(),{success:!0,result:{files:i,config:n,analysis:l,message:"FSH files loaded successfully. Full SUSHI compilation will be available in future releases."},files:i,logs:this.logs,stats:this.getAnalysisStats(l)}}catch(i){return this.log("error","FSH processing failed: ".concat(i.message)),this.notifyListeners(),{success:!1,error:i.message,logs:this.logs}}}analyzeFSHFiles(e){const s={totalFiles:e.length,githubFiles:e.filter(e=>"github"===e.source).length,stagingFiles:e.filter(e=>"staging"===e.source).length,overrides:[],fileTypes:{},totalLines:0,profiles:0,extensions:0,valueSets:0,codeSystems:0,instances:0};return e.forEach(e=>{const t=e.content;s.totalLines+=t.split("\n").length,t.includes("Profile:")&&s.profiles++,t.includes("Extension:")&&s.extensions++,t.includes("ValueSet:")&&s.valueSets++,t.includes("CodeSystem:")&&s.codeSystems++,t.includes("Instance:")&&s.instances++,"staging"===e.source&&s.overrides.push(e.path);const i=e.path.split(".").pop();s.fileTypes[i]=(s.fileTypes[i]||0)+1}),s}getAnalysisStats(e){return{files:e.totalFiles,lines:e.totalLines,sources:{github:e.githubFiles,staging:e.stagingFiles},constructs:{profiles:e.profiles,extensions:e.extensions,valueSets:e.valueSets,codeSystems:e.codeSystems,instances:e.instances},overrides:e.overrides.length}}clearLogs(){this.logs=[]}log(e,s){const t={level:e,message:s,location:arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,timestamp:(new Date).toISOString()};this.logs.push(t),console[e]&&console[e]("[SUSHI] ".concat(s))}getLogs(){return this.logs}getLogsByLevel(e){return this.logs.filter(s=>s.level===e)}searchLogs(e){return this.logs.filter(s=>s.message.toLowerCase().includes(e.toLowerCase()))}exportLogsAsText(){return this.logs.map(e=>"[".concat(e.timestamp,"] [").concat(e.level.toUpperCase(),"] ").concat(e.message).concat(e.location?" (".concat(e.location,")"):"")).join("\n")}getCompilationResults(){return this.compilationResults}addListener(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(){this.listeners.forEach(e=>{try{e({logs:this.logs,results:this.compilationResults,stats:this.compilationResults?this.getAnalysisStats(this.compilationResults.analysis):null})}catch(s){console.error("Error notifying SUSHI service listener:",s)}})}isInitialized(){return this.initialized}async validateFSH(e){try{const s=[],t=[],i=e.split("\n");for(let e=0;e<i.length;e++){const s=i[e].trim();s.includes("Profile:")&&!s.includes("=")&&t.push("Line ".concat(e+1,": Profile declaration might be missing metadata")),!s.includes("*")||s.includes("=")||s.includes("//")||t.push("Line ".concat(e+1,": Rule might be missing assignment"))}return{valid:0===s.length,errors:s,warnings:t}}catch(s){return{valid:!1,errors:[s.message],warnings:[]}}}};var r=t(70579);const c=()=>{const{user:e,repo:s,branch:t}=(0,n.g)(),a=(0,n.zy)(),c=(0,n.Zp)(),[h,d]=(0,i.useState)(null),[g,u]=(0,i.useState)(t||"main"),[p,f]=(0,i.useState)(null),[m,S]=(0,i.useState)(!0),[y,x]=(0,i.useState)(null),[v,j]=(0,i.useState)(!1),[F,b]=(0,i.useState)(null),[w,N]=(0,i.useState)([]),[H,L]=(0,i.useState)("all"),[C,A]=(0,i.useState)(""),[k,z]=(0,i.useState)(new Set);(0,i.useEffect)(()=>{(async()=>{S(!0),x(null);try{var i;const n=localStorage.getItem("sgex-profile");if(!n)return void c("/select_profile");const o=JSON.parse(n);if(f(o),e&&s){const i=await l.A.getRepository(e,s,o.token);d(i),u(t||i.default_branch||"main")}else null!==(i=a.state)&&void 0!==i&&i.repository?(d(a.state.repository),u(a.state.selectedBranch||a.state.repository.default_branch||"main")):x("No repository context available. Please navigate from a DAK dashboard.")}catch(n){console.error("Error initializing SUSHI runner context:",n),x("Failed to load repository: ".concat(n.message))}finally{S(!1)}})()},[e,s,t,a.state,c]),(0,i.useEffect)(()=>o.addListener(e=>{N(e.logs||[]),b(e.results)}),[]);const I=w.filter(e=>{const s="all"===H||e.level===H,t=""===C||e.message.toLowerCase().includes(C.toLowerCase());return s&&t}),R=(0,i.useCallback)(async()=>{if(h&&g&&p){j(!0),b(null),N([]);try{const e=await o.runSUSHI(h,g,p,{logLevel:"info"});b(e)}catch(y){console.error("SUSHI compilation error:",y),b({success:!1,error:y.message,logs:o.getLogs()})}finally{j(!1)}}else alert("Missing required parameters for SUSHI compilation")},[h,g,p]),U=()=>{c(e&&s&&g?"/dashboard/".concat(e,"/").concat(s,"/").concat(g):"/dashboard")},E={error:w.filter(e=>"error"===e.level).length,warn:w.filter(e=>"warn"===e.level).length,info:w.filter(e=>"info"===e.level).length,debug:w.filter(e=>"debug"===e.level).length};return m?(0,r.jsxs)("div",{className:"sushi-runner",children:[(0,r.jsx)("div",{className:"sushi-runner-header",children:(0,r.jsx)("h2",{children:"FSH File Manager & Analyzer"})}),(0,r.jsxs)("div",{className:"loading-container",children:[(0,r.jsx)("div",{className:"loading-spinner"}),(0,r.jsx)("p",{children:"Loading repository context..."})]})]}):y?(0,r.jsxs)("div",{className:"sushi-runner",children:[(0,r.jsxs)("div",{className:"sushi-runner-header",children:[(0,r.jsx)("h2",{children:"FSH File Manager & Analyzer"}),(0,r.jsx)("button",{onClick:U,className:"close-button",children:"Back to Dashboard"})]}),(0,r.jsxs)("div",{className:"error-container",children:[(0,r.jsx)("h3",{children:"Error"}),(0,r.jsx)("p",{children:y}),(0,r.jsx)("button",{onClick:U,className:"back-button",children:"Go to Dashboard"})]})]}):(0,r.jsxs)("div",{className:"sushi-runner",children:[(0,r.jsxs)("div",{className:"sushi-runner-header",children:[(0,r.jsx)("h2",{children:"FSH File Manager & Analyzer"}),(0,r.jsxs)("div",{className:"sushi-runner-controls",children:[(0,r.jsx)("button",{onClick:R,disabled:v,className:"run-button",children:v?"Loading...":"Load & Analyze FSH Files"}),(0,r.jsx)("button",{onClick:U,className:"close-button",children:"Back to Dashboard"})]})]}),(0,r.jsxs)("div",{className:"sushi-runner-content",children:[(0,r.jsxs)("div",{className:"repository-info",children:[(0,r.jsxs)("h3",{children:["Repository: ",null===h||void 0===h?void 0:h.full_name," (",g,")"]}),(0,r.jsx)("p",{children:"This will load and analyze all FSH files from the repository and staging ground. Staging ground files will override repository files with the same path. Full SUSHI compilation will be available in future releases."})]}),F&&(0,r.jsxs)("div",{className:"results-summary ".concat(F.success?"success":"error"),children:[(0,r.jsx)("h3",{children:"Analysis Results"}),(0,r.jsxs)("p",{children:["Status: ",(0,r.jsx)("strong",{children:F.success?"Success":"Failed"})]}),F.files&&(0,r.jsxs)("p",{children:["FSH Files Processed: ",F.files.length]}),F.error&&(0,r.jsxs)("p",{className:"error-message",children:["Error: ",F.error]}),F.stats&&(0,r.jsxs)("div",{className:"compilation-stats",children:[(0,r.jsx)("p",{children:"Analysis Statistics:"}),(0,r.jsx)("pre",{children:JSON.stringify(F.stats,null,2)})]})]}),(0,r.jsxs)("div",{className:"logs-section",children:[(0,r.jsxs)("div",{className:"logs-header",children:[(0,r.jsx)("h3",{children:"Processing Logs"}),(0,r.jsxs)("div",{className:"logs-controls",children:[(0,r.jsxs)("select",{value:H,onChange:e=>L(e.target.value),className:"log-filter",children:[(0,r.jsxs)("option",{value:"all",children:["All Logs (",w.length,")"]}),(0,r.jsxs)("option",{value:"error",children:["Errors (",E.error,")"]}),(0,r.jsxs)("option",{value:"warn",children:["Warnings (",E.warn,")"]}),(0,r.jsxs)("option",{value:"info",children:["Info (",E.info,")"]}),(0,r.jsxs)("option",{value:"debug",children:["Debug (",E.debug,")"]})]}),(0,r.jsx)("input",{type:"text",placeholder:"Search logs...",value:C,onChange:e=>A(e.target.value),className:"log-search"}),(0,r.jsx)("button",{onClick:()=>{const e=o.exportLogsAsText();navigator.clipboard.writeText(e).then(()=>{alert("Logs copied to clipboard")}).catch(e=>{console.error("Failed to copy logs:",e)})},className:"copy-logs-button",children:"Copy All Logs"})]})]}),(0,r.jsx)("div",{className:"logs-container",children:0===I.length?(0,r.jsx)("p",{className:"no-logs",children:"No logs to display"}):I.map((e,s)=>(0,r.jsxs)("div",{className:"log-entry log-".concat(e.level),onClick:()=>(e=>{const s="[".concat(e.timestamp,"] [").concat(e.level.toUpperCase(),"] ").concat(e.message).concat(e.location?" (".concat(e.location,")"):"");navigator.clipboard.writeText(s).then(()=>{}).catch(e=>{console.error("Failed to copy log entry:",e)})})(e),title:"Click to copy to clipboard",children:[(0,r.jsx)("span",{className:"log-timestamp",children:new Date(e.timestamp).toLocaleTimeString()}),(0,r.jsx)("span",{className:"log-level level-".concat(e.level),children:e.level.toUpperCase()}),(0,r.jsx)("span",{className:"log-message",children:e.message}),e.location&&(0,r.jsxs)("span",{className:"log-location",children:["(",e.location,")"]})]},s))})]}),F&&F.files&&(0,r.jsxs)("div",{className:"processed-files",children:[(0,r.jsxs)("h3",{children:["Processed FSH Files (",F.files.length,")"]}),(0,r.jsx)("div",{className:"files-list",children:F.files.map((e,s)=>(0,r.jsxs)("div",{className:"file-item",children:[(0,r.jsxs)("div",{className:"file-header",onClick:()=>(e=>{const s=new Set(k);s.has(e)?s.delete(e):s.add(e),z(s)})(e.path),children:[(0,r.jsx)("span",{className:"file-path",children:e.path}),(0,r.jsx)("span",{className:"file-source source-".concat(e.source),children:e.source}),(0,r.jsx)("span",{className:"expand-icon",children:k.has(e.path)?"\u25bc":"\u25b6"})]}),k.has(e.path)&&(0,r.jsx)("div",{className:"file-content",children:(0,r.jsx)("pre",{children:e.content})})]},s))})]}),F&&F.result&&(0,r.jsxs)("div",{className:"fhir-output",children:[(0,r.jsx)("h3",{children:"FSH Analysis Results"}),(0,r.jsx)("div",{className:"fhir-resources",children:(0,r.jsx)("pre",{children:JSON.stringify(F.result,null,2)})})]})]})]})}}}]);
//# sourceMappingURL=727.51e2d5e2.chunk.js.map