"use strict";(self.webpackChunksgex_workbench=self.webpackChunksgex_workbench||[]).push([[7014],{87014:(e,t,n)=>{n.r(t),n.d(t,{default:()=>j});var i=n(89379),a=n(9950),s=n(10827),l=n(53782),c=n(96143);function o(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const t={type:"ApplicationLayer",name:"FHIR Logical Models Overview",description:"Strategic view of DAK Component 2: Core Data Dictionary logical models and relationships",elements:[],relationships:[],views:[]};return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((e,n)=>{const i={id:"lm-".concat(n),name:r(e)||"LogicalModel-".concat(n+1),type:"ApplicationComponent",description:d(e),properties:{source:"FHIR Logical Model",fshFile:e.path||e.name,elementCount:p(e)}};t.elements.push(i)}),e.forEach((e,n)=>{const i={id:"concept-".concat(n),name:e.display||e.code||"Concept-".concat(n+1),type:"DataObject",description:e.definition||"DAK concept definition",properties:{source:"DAK CodeSystem",code:e.code,system:"DAK.CodeSystem"}};t.elements.push(i)}),function(e){const t=e.elements.filter(e=>"ApplicationComponent"===e.type),n=e.elements.filter(e=>"DataObject"===e.type);t.forEach(t=>{n.forEach(n=>{const i="".concat(t.name," ").concat(t.description).toLowerCase(),a=n.name.toLowerCase();(i.includes(a)||a.includes(t.name.toLowerCase()))&&e.relationships.push({id:"rel-".concat(t.id,"-").concat(n.id),source:t.id,target:n.id,type:"Association",name:"uses concept"})})});for(let i=0;i<t.length;i++)for(let n=i+1;n<t.length;n++){const a=t[i],s=t[n];h(a.name,s.name)&&e.relationships.push({id:"rel-".concat(a.id,"-").concat(s.id),source:a.id,target:s.id,type:"Association",name:"related to"})}}(t),t.views.push({id:"strategic-overview",name:"Core Data Dictionary Strategic View",type:"ApplicationLayerView",elements:t.elements.map(e=>e.id),description:"High-level overview of logical models and concept relationships in the DAK"}),t}function r(e){if(!e)return null;if(e.content){const t=e.content.match(/Logical:\s*([^\r\n]+)/);if(t)return t[1].trim();const n=e.content.match(/Title:\s*"([^"]+)"/);if(n)return n[1]}return e.path?e.path.split("/").pop().replace(/\.(fsh|json)$/,""):e.name?e.name.replace(/\.(fsh|json)$/,""):null}function d(e){if(null===e||void 0===e||!e.content)return"FHIR Logical Model component";const t=e.content.match(/Description:\s*"([^"]+)"/);if(t)return t[1];const n=e.content.match(/\/\/\s*(.+)/);return n?n[1].trim():"FHIR Logical Model defining data structure and constraints"}function p(e){if(null===e||void 0===e||!e.content)return 0;const t=e.content.match(/^\s*\*\s+/gm);return t?t.length:0}function h(e,t){if(!e||!t)return!1;const n=e=>e.toLowerCase().replace(/[-_\s]/g,""),i=(n(e),n(t),e.toLowerCase().split(/[-_\s]+/)),a=t.toLowerCase().split(/[-_\s]+/);return i.filter(e=>a.includes(e)&&e.length>2).length>0}function m(e){var t;const n={content:e,elements:[],relationships:[],constraints:[],metadata:{}},i=e.match(/Title:\s*"([^"]+)"/),a=e.match(/Description:\s*"([^"]+)"/),s=e.match(/Logical:\s*([^\r\n]+)/);n.metadata={title:null===i||void 0===i?void 0:i[1],description:null===a||void 0===a?void 0:a[1],logical:null===s||void 0===s||null===(t=s[1])||void 0===t?void 0:t.trim()};return e.split("\n").forEach((e,t)=>{const i=e.trim().match(/^\*\s+([^\s]+)\s+([^\s]+)\s+([^\s"]+)(?:\s+"([^"]+)")?/);i&&n.elements.push({name:i[1],cardinality:i[2],type:i[3],description:i[4]||"",lineNumber:t+1})}),n}var u=n(29946),g=n(29166),f=n(44414);const v=()=>{const e=(0,s.Zp)(),{profile:t,repository:n,branch:r}=(0,l.N5)(),d=(0,s.g)(),p=d.user||(null===t||void 0===t?void 0:t.login),h=d.repo||(null===n||void 0===n?void 0:n.name),v=d.branch||r||(null===n||void 0===n?void 0:n.default_branch)||"main",[j,y]=(0,a.useState)(!0),[w,N]=(0,a.useState)(null),[b,C]=(0,a.useState)("strategic"),[M,L]=(0,a.useState)([]),[F,S]=(0,a.useState)([]),[D,A]=(0,a.useState)(null),[k,E]=(0,a.useState)(""),[_,P]=(0,a.useState)([]),[R,B]=(0,a.useState)(null),[z,H]=(0,a.useState)([]),[I,O]=(0,a.useState)("dot"),[T,V]=(0,a.useState)(null),[G,K]=(0,a.useState)({}),W=(0,a.useRef)(null),X=(0,a.useRef)(null),q=((0,a.useRef)(null),(0,a.useRef)(null)),Q=(0,a.useRef)(null),U=(0,a.useCallback)(async()=>{try{const t=await u.A.getDirectoryContents(p,h,"input/fsh",v);L(t);const n=[];for(const l of t)if(l.name.endsWith(".fsh"))try{const e=await u.A.getFileContent(p,h,l.path,v);if(e.includes("Logical:")){const t=m(e);n.push((0,i.A)((0,i.A)({},t),{},{fileName:l.name,path:l.path}))}}catch(e){console.warn("Failed to parse FSH file ".concat(l.name,":"),e)}P(n);const a=t.find(e=>"DAK.fsh"===e.name);if(a)try{const e=await u.A.getFileContent(p,h,a.path,v),t=Z(e);H(t)}catch(e){console.warn("Failed to load DAK concepts:",e)}const s=o(n,z);B(s)}catch(e){console.error("Error loading logical models:",e),N("Failed to load logical models from FSH files")}},[p,h,v,z]),$=(0,a.useCallback)(async()=>{try{const e=(await u.A.getDirectoryContents(p,h,"input/maps",v)).filter(e=>e.name.endsWith(".fml"));if(S(e),e.length>0){const t=e[0];A(t);const n=await u.A.getFileContent(p,h,t.path,v);E(n)}}catch(e){console.warn("No FML files found or error loading:",e)}},[p,h,v]),Z=e=>{const t=[],n=e.split("\n");for(let i=0;i<n.length;i++){const e=n[i].trim().match(/^\*\s*#([^\s"]+)\s*"([^"]+)"\s*"([^"]+)"/);e&&t.push({code:e[1],display:e[2],definition:e[3]})}return t};(0,a.useEffect)(()=>{(async()=>{if(p&&h){y(!0),N(null);try{const e=await(0,c.Hv)();V(e),await Promise.all([U(),$()])}catch(t){N(t.message||"Failed to initialize FML/StructureMap editor")}finally{y(!1)}}else e("/")})()},[p,h,v,e,U,$]),(0,a.useEffect)(()=>{(async()=>{if("strategic"===b&&q.current&&R&&!W.current)try{const e=await(0,c.Nc)({container:q.current});W.current=e,await e.importModel(R),console.log("ArchiMate viewer initialized successfully")}catch(e){console.error("Failed to initialize ArchiMate viewer:",e)}})()},[b,R]),(0,a.useEffect)(()=>{(async()=>{if("technical"===b&&Q.current&&!X.current)try{const e=await(0,c._Q)({container:Q.current});X.current=e;const t=J(_);await e.importXML(t),console.log("Mapping viewer initialized successfully")}catch(e){console.error("Failed to initialize mapping viewer:",e)}})()},[b,_]);const J=e=>{const t=e.map((e,t)=>{var n,i;const a=100+t%3*300,s=100+200*Math.floor(t/3);return'\n        <bpmn:task id="model_'.concat(t,'" name="').concat((null===(n=e.metadata)||void 0===n?void 0:n.title)||e.fileName,'">\n          <bpmn:documentation>Logical Model: ').concat((null===(i=e.metadata)||void 0===i?void 0:i.description)||"FHIR logical model",'</bpmn:documentation>\n        </bpmn:task>\n        <bpmndi:BPMNShape id="model_').concat(t,'_di" bpmnElement="model_').concat(t,'">\n          <dc:Bounds x="').concat(a,'" y="').concat(s,'" width="100" height="80" />\n        </bpmndi:BPMNShape>\n      ')}).join("\n");return'<?xml version="1.0" encoding="UTF-8"?>\n<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" \n                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" \n                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" \n                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI" \n                  id="Definitions_1" \n                  targetNamespace="http://fml.mapping.example">\n  <bpmn:process id="Process_1" isExecutable="false">\n    '.concat(t,'\n  </bpmn:process>\n  <bpmndi:BPMNDiagram id="BPMNDiagram_1">\n    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">\n      ').concat(t,"\n    </bpmndi:BPMNPlane>\n  </bpmndi:BPMNDiagram>\n</bpmn:definitions>")},Y=(0,a.useCallback)(async()=>{if(T&&R&&R.elements.length)try{console.log("Generating strategic layout with GraphViz...");const e=await T.generateArchimateLayout(R,{engine:I,showDataObjects:!0,groupByType:!0});e.success?(K(e.coordinates),console.log("Strategic layout generated successfully:",e.engine)):(console.warn("GraphViz layout failed, using fallback:",e.error),K(e.fallbackCoordinates||{}))}catch(w){console.error("Failed to generate strategic layout:",w)}},[T,R,I]),ee=(0,a.useCallback)(async()=>{if(T&&_.length)try{console.log("Generating technical mapping layout with GraphViz...");const e=te(_),t=await T.generateLogicalModelLayout(_,e,{engine:I,rankDir:"TB",nodeSpacing:150,rankSep:100});t.success?(K(t.coordinates),console.log("Technical layout generated successfully:",t.engine)):(console.warn("GraphViz layout failed, using fallback:",t.error),K(t.fallbackCoordinates||{}))}catch(w){console.error("Failed to generate technical layout:",w)}},[T,_,I]),te=e=>{const t=[];for(let a=0;a<e.length;a++)for(let s=a+1;s<e.length;s++){var n,i;const l=e[a],c=e[s];ne((null===(n=l.metadata)||void 0===n?void 0:n.title)||l.fileName,(null===(i=c.metadata)||void 0===i?void 0:i.title)||c.fileName)&&t.push({sourceIndex:a,targetIndex:s,type:"related to",description:"Models with related concepts"})}return t},ne=(e,t)=>{if(!e||!t)return!1;const n=e=>e.toLowerCase().replace(/[-_\s]/g,""),i=(n(e),n(t),e.toLowerCase().split(/[-_\s]+/)),a=t.toLowerCase().split(/[-_\s]+/);return i.filter(e=>a.includes(e)&&e.length>2).length>0};(0,a.useEffect)(()=>{"strategic"===b?Y():"technical"===b&&ee()},[b,R,_,I,Y,ee]);return t&&n?j?(0,f.jsx)("div",{className:"fml-editor loading-state",children:(0,f.jsxs)("div",{className:"loading-content",children:[(0,f.jsx)("h2",{children:"Loading FML/StructureMap Editor..."}),(0,f.jsx)("p",{children:"Initializing logical models and mapping capabilities..."})]})}):(0,f.jsxs)("div",{className:"fml-editor",children:[(0,f.jsxs)("div",{className:"fml-editor-header",children:[(0,f.jsxs)("div",{className:"who-branding",children:[(0,f.jsx)("h1",{onClick:()=>{t&&n?e("/dashboard",{state:{profile:t,repository:n,branch:v}}):e("/")},className:"clickable-title",children:"SGEX Workbench"}),(0,f.jsx)("p",{className:"subtitle",children:"WHO SMART Guidelines Exchange"})]}),(0,f.jsxs)("div",{className:"context-info",children:[(0,f.jsx)("img",{src:(null===t||void 0===t?void 0:t.avatar_url)||"https://github.com/".concat(p,".png"),alt:"Profile",className:"context-avatar"}),(0,f.jsxs)("div",{className:"context-details",children:[(0,f.jsx)("span",{className:"context-repo",children:h}),(0,f.jsx)("span",{className:"context-component",children:"FML/StructureMap Editor"})]})]})]}),(0,f.jsxs)("div",{className:"view-mode-selector",children:[(0,f.jsxs)("div",{className:"mode-buttons",children:[(0,f.jsx)("button",{className:"mode-btn ".concat("strategic"===b?"active":""),onClick:()=>C("strategic"),children:"\ud83d\udcca Strategic View (ArchiMate)"}),(0,f.jsx)("button",{className:"mode-btn ".concat("technical"===b?"active":""),onClick:()=>C("technical"),children:"\ud83d\udd27 Technical View (Mapping)"})]}),(0,f.jsxs)("div",{className:"layout-controls",children:[(0,f.jsx)("label",{htmlFor:"layout-engine",children:"Layout Engine:"}),(0,f.jsxs)("select",{id:"layout-engine",value:I,onChange:e=>{return t=e.target.value,void O(t);var t},className:"layout-engine-select",children:[(0,f.jsx)("option",{value:"dot",children:"Dot - Hierarchical (trees)"}),(0,f.jsx)("option",{value:"neato",children:"Neato - Spring model (networks)"}),(0,f.jsx)("option",{value:"fdp",children:"FDP - Force-directed (large graphs)"}),(0,f.jsx)("option",{value:"circo",children:"Circo - Circular (cycles)"}),(0,f.jsx)("option",{value:"twopi",children:"Twopi - Radial (hub-spoke)"})]}),(0,f.jsx)("button",{onClick:()=>"strategic"===b?Y():ee(),className:"regenerate-layout-btn",disabled:!T,children:"\ud83d\udd04 Regenerate Layout"})]})]}),w&&(0,f.jsxs)("div",{className:"error-banner",children:[(0,f.jsx)("strong",{children:"Error:"})," ",w]}),(0,f.jsx)("div",{className:"fml-editor-content",children:"strategic"===b?(0,f.jsxs)("div",{className:"strategic-view",children:[(0,f.jsxs)("div",{className:"strategic-header",children:[(0,f.jsx)("h2",{children:"Logical Models Strategic Overview"}),(0,f.jsx)("p",{children:"ArchiMate Application Layer visualization of FHIR Logical Models and relationships"})]}),(0,f.jsx)("div",{className:"archimate-section",children:(0,f.jsx)("div",{ref:q,className:"archimate-viewer-container",children:R?(0,f.jsxs)("div",{className:"archimate-fallback",children:[(0,f.jsxs)("h3",{children:["Logical Models (",R.elements.filter(e=>"ApplicationComponent"===e.type).length,")"]}),(0,f.jsx)("div",{className:"model-grid",children:R.elements.filter(e=>"ApplicationComponent"===e.type).map((e,t)=>{var n,i;return(0,f.jsxs)("div",{className:"model-card",children:[(0,f.jsx)("h4",{children:e.name}),(0,f.jsx)("p",{children:e.description}),(0,f.jsxs)("div",{className:"model-properties",children:[(0,f.jsxs)("span",{children:["Source: ",null===(n=e.properties)||void 0===n?void 0:n.fshFile]}),(0,f.jsxs)("span",{children:["Elements: ",(null===(i=e.properties)||void 0===i?void 0:i.elementCount)||0]})]})]},e.id)})}),(0,f.jsxs)("h3",{children:["DAK Concepts (",R.elements.filter(e=>"DataObject"===e.type).length,")"]}),(0,f.jsx)("div",{className:"concept-grid",children:R.elements.filter(e=>"DataObject"===e.type).map((e,t)=>{var n;return(0,f.jsxs)("div",{className:"concept-card",children:[(0,f.jsx)("h4",{children:e.name}),(0,f.jsx)("p",{children:e.description}),(0,f.jsx)("div",{className:"concept-properties",children:(0,f.jsxs)("span",{children:["Code: ",null===(n=e.properties)||void 0===n?void 0:n.code]})})]},e.id)})})]}):(0,f.jsxs)("div",{className:"no-models-message",children:[(0,f.jsx)("p",{children:"No logical models found in FSH files."}),(0,f.jsx)("p",{children:"Logical models are required for FML mapping visualization."})]})})})]}):(0,f.jsx)("div",{className:"technical-view",children:(0,f.jsxs)("div",{className:"technical-layout",children:[(0,f.jsxs)("div",{className:"fml-files-panel",children:[(0,f.jsx)("h3",{children:"FML Files"}),F.length>0?(0,f.jsx)("div",{className:"fml-file-list",children:F.map((e,t)=>(0,f.jsxs)("div",{className:"fml-file-item ".concat((null===D||void 0===D?void 0:D.path)===e.path?"selected":""),onClick:()=>(async e=>{try{A(e);const t=await u.A.getFileContent(p,h,e.path,v);E(t)}catch(t){console.error("Error loading FML file:",t),N("Failed to load FML file content")}})(e),children:[(0,f.jsx)("span",{className:"file-name",children:e.name}),(0,f.jsx)("span",{className:"file-path",children:e.path})]},t))}):(0,f.jsxs)("div",{className:"no-fml-files",children:[(0,f.jsx)("p",{children:"No FML files found in input/maps/"}),(0,f.jsx)("p",{children:"Create .fml files to define StructureMap transformations"})]})]}),(0,f.jsxs)("div",{className:"mapping-panel",children:[(0,f.jsx)("h3",{children:"Mapping Visualization"}),(0,f.jsx)("div",{ref:Q,className:"mapping-viewer-container",children:(0,f.jsxs)("div",{className:"mapping-placeholder",children:[(0,f.jsx)("p",{children:"Interactive mapping visualization"}),(0,f.jsx)("p",{children:"Powered by diagram-js"})]})})]}),(0,f.jsxs)("div",{className:"fml-code-panel",children:[(0,f.jsx)("h3",{children:"FML Code Editor"}),(0,f.jsx)("div",{className:"fml-editor-container",children:D?(0,f.jsx)(x,{content:k,fileName:D.name,onChange:E}):(0,f.jsx)("div",{className:"no-file-selected",children:(0,f.jsx)("p",{children:"Select an FML file to edit"})})})]})]})})}),(0,f.jsx)(g.A,{pageId:"fml-structuremap-editor",notificationBadge:0===_.length?"No logical models found":null})]}):(e("/"),(0,f.jsx)("div",{children:"Redirecting..."}))},x=e=>{let{content:t,fileName:n,onChange:i}=e;const[s,l]=(0,a.useState)(null);return(0,a.useEffect)(()=>{(async()=>{try{const e=await(0,c.fR)();l(()=>e)}catch(e){console.error("Failed to load Monaco Editor:",e)}})()},[]),s?(0,f.jsx)(s,{height:"400px",language:"fhir-fml",theme:"vs-light",value:t,onChange:i,options:{selectOnLineNumbers:!0,roundedSelection:!1,readOnly:!1,cursorStyle:"line",automaticLayout:!0,minimap:{enabled:!1},scrollBeyondLastLine:!1,wordWrap:"on"}}):(0,f.jsx)("div",{className:"editor-loading",children:(0,f.jsx)("p",{children:"Loading FML editor..."})})},j=()=>(0,f.jsx)(l.Mx,{pageName:"fml-structuremap-editor",children:(0,f.jsx)(v,{})})},96143:(e,t,n)=>{n.d(t,{Cq:()=>a,Hv:()=>r,Nc:()=>o,Ub:()=>s,_Q:()=>l,fR:()=>c});var i=n(57335);async function a(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new(await(0,i.sN)())(e)}async function s(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new(await(0,i.uW)())(e)}async function l(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new(await(0,i.M3)())(e)}async function c(){return await(0,i.Xr)()}async function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new(await(0,i.BC)())(e)}async function r(){return await(0,i.r1)()}}}]);