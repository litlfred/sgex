<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SGEX Workbench</title>
    <script type="text/javascript">
      // SGEX Simplified Dynamic URL Routing
      // Focuses on reliable URL preservation and basic pattern matching
      // Reduces complexity while maintaining all functionality
      // Supports: /{component}(/{user}(/{repo}(/{branch}(/{asset}*))))?

      (function(l) {
        // Prevent infinite redirects
        if (l.search && l.search.indexOf('?/') === 0) {
          console.error('SGEX 404.html: Redirect loop detected');
          return;
        }

        // Check for recent redirect attempts to prevent loops
        var redirectKey = 'sgex-redirect-attempts';
        var currentPath = l.pathname;
        var now = Date.now();
        var attempts = JSON.parse(sessionStorage.getItem(redirectKey) || '[]');
        
        // Clean old attempts (>30 seconds)
        attempts = attempts.filter(function(a) { return now - a.time < 30000; });
        
        // Count recent attempts for this path
        var recentCount = attempts.filter(function(a) { return a.path === currentPath; }).length;
        
        if (recentCount >= 3) {
          console.error('SGEX 404.html: Too many redirects for path:', currentPath);
          // Fallback to main SGEX page
          l.replace(l.protocol + '//' + l.host + '/sgex/');
          return;
        }
        
        // Record this attempt
        attempts.push({ path: currentPath, time: now });
        sessionStorage.setItem(redirectKey, JSON.stringify(attempts));

        var pathSegments = l.pathname.split('/').filter(Boolean);
        
        // Determine deployment context
        var isGitHubPages = l.hostname.endsWith('.github.io');
        var basePath = '/sgex/';
        
        // Handle different deployment scenarios
        if (isGitHubPages) {
          handleGitHubPagesRouting(pathSegments, l, basePath);
        } else {
          handleLocalRouting(pathSegments, l, basePath);
        }

        function handleGitHubPagesRouting(segments, location, base) {
          // GitHub Pages: URLs must start with /sgex/
          if (segments.length === 0 || segments[0] !== 'sgex') {
            console.warn('SGEX: Invalid GitHub Pages URL pattern');
            redirectToSPA(base, '');
            return;
          }

          if (segments.length === 1) {
            // /sgex/ -> main app
            redirectToSPA(base, '');
            return;
          }

          // Check for branch deployment pattern: /sgex/{branch}/...
          if (segments.length >= 2) {
            var secondSegment = segments[1];
            
            // Handle documentation routes specially
            if (secondSegment === 'docs') {
              var docRoute = segments.slice(1).join('/');
              redirectToSPA(base, docRoute);
              return;
            }
            
            // Check if this could be a branch deployment
            if (segments.length === 2) {
              // /sgex/{branch}/ -> branch root
              var branchPath = '/sgex/' + secondSegment + '/';
              redirectToSPA(branchPath, '');
              return;
            }
            
            // For longer paths, determine if it's branch-first or component-first
            if (segments.length >= 3) {
              var thirdSegment = segments[2];
              
              // Branch docs: /sgex/{branch}/docs/...
              if (thirdSegment === 'docs') {
                var branchPath = '/sgex/' + secondSegment + '/';
                var docRoute = segments.slice(2).join('/');
                redirectToSPA(branchPath, docRoute);
                return;
              }
              
              // For other patterns, try component-first: /sgex/{component}/{user}/{repo}/...
              if (segments.length >= 4) {
                var routePath = segments.slice(1).join('/');
                storeContextFromURL(segments);
                redirectToSPA(base, routePath);
                return;
              }
              
              // Branch with component: /sgex/{branch}/{component}/...
              var branchPath = '/sgex/' + secondSegment + '/';
              var routePath = segments.slice(2).join('/');
              storeContextFromURL(segments);
              redirectToSPA(branchPath, routePath);
              return;
            }
          }
          
          // Default fallback
          redirectToSPA(base, '');
        }

        function handleLocalRouting(segments, location, base) {
          // Local development: handle both /sgex/ prefixed and root URLs
          
          if (segments.length === 0) {
            redirectToSPA('/', '');
            return;
          }
          
          // If starts with sgex, treat as GitHub Pages pattern
          if (segments[0] === 'sgex') {
            handleGitHubPagesRouting(segments, location, base);
            return;
          }
          
          // Direct component access: /{component}/...
          var routePath = segments.join('/');
          storeContextFromURL(segments);
          redirectToSPA('/', routePath);
        }

        function storeContextFromURL(segments) {
          // Extract and store context for React app
          try {
            if (typeof Storage === 'undefined') return;
            
            // Look for patterns with user/repo context
            var userIndex = -1;
            var repoIndex = -1;
            var branchIndex = -1;
            
            // Find user/repo pattern in segments
            for (var i = 0; i < segments.length - 1; i++) {
              var segment = segments[i];
              var nextSegment = segments[i + 1];
              
              // Skip known non-user segments
              if (segment === 'sgex' || segment === 'docs') continue;
              
              // Look for user/repo pattern (simple heuristic)
              if (nextSegment && 
                  /^[a-zA-Z0-9._-]+$/.test(segment) && 
                  /^[a-zA-Z0-9._-]+$/.test(nextSegment) &&
                  userIndex === -1) {
                userIndex = i;
                repoIndex = i + 1;
                branchIndex = i + 2;
                break;
              }
            }
            
            if (userIndex >= 0 && repoIndex >= 0) {
              sessionStorage.setItem('sgex_selected_user', segments[userIndex]);
              sessionStorage.setItem('sgex_selected_repo', segments[repoIndex]);
              
              if (branchIndex < segments.length) {
                sessionStorage.setItem('sgex_selected_branch', segments[branchIndex]);
              }
            }
          } catch (error) {
            console.warn('Could not store URL context:', error);
          }
        }

        function redirectToSPA(basePath, routePath) {
          var newUrl = l.protocol + '//' + l.host + basePath;
          
          // Add route path as query parameter
          if (routePath) {
            newUrl += '?/' + encodeURIComponent(routePath);
          }
          
          // Preserve existing query parameters (except the routing one)
          if (l.search && !l.search.startsWith('?/')) {
            var searchParams = l.search.startsWith('?') ? l.search.substring(1) : l.search;
            if (routePath) {
              newUrl += '&' + searchParams;
            } else {
              newUrl += '?' + searchParams;
            }
          }
          
          // Preserve hash fragments
          if (l.hash) {
            newUrl += l.hash;
          }
          
          console.log('SGEX Routing:', {
            from: l.pathname + l.search + l.hash,
            to: newUrl,
            basePath: basePath,
            routePath: routePath
          });
          
          l.replace(newUrl);
        }

      })(window.location);
    </script>
  </head>
  <body>
    <!-- SGEX Simplified Routing Handler -->
    <!-- Preserves URL fragments, query parameters, and context -->
    <!-- Supports all deployment scenarios with minimal complexity -->
  </body>
</html>