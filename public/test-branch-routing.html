<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SGEX Branch-First URL Routing Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 50px auto; 
            padding: 20px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover { background: #005a9e; }
        .error-page {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>SGEX Branch-First URL Routing Test</h1>
    <p>This page tests the new dynamic branch-first URL routing system that addresses @litlfred's feedback.</p>
    
    <div class="test-section">
        <h2>Test 1: Branch-First URL Pattern</h2>
        <p>Tests URL pattern: <code>http://litlfred.github.io/sgex/:branch/:component/:user/:repo</code></p>
        <button onclick="testBranchFirstURL()">Test Branch-First Pattern</button>
        <div id="test1-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Component-First URL Pattern (Legacy)</h2>
        <p>Tests URL pattern: <code>http://litlfred.github.io/sgex/:component/:user/:repo/:branch</code></p>
        <button onclick="testComponentFirstURL()">Test Component-First Pattern</button>
        <div id="test2-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Error Handling - Invalid Branch</h2>
        <p>Tests invalid branch name in URL pattern</p>
        <button onclick="testInvalidBranch()">Test Invalid Branch</button>
        <div id="test3-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Error Handling - Invalid Component</h2>
        <p>Tests invalid component name in branch deployment</p>
        <button onclick="testInvalidComponent()">Test Invalid Component</button>
        <div id="test4-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: Route Configuration Loading</h2>
        <p>Tests that route configuration is properly loaded and accessible</p>
        <button onclick="testRouteConfig()">Test Route Configuration</button>
        <div id="test5-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 6: Redirect Loop Prevention</h2>
        <p>Tests detection and prevention of infinite redirect loops</p>
        <button onclick="testRedirectLoop()">Test Redirect Loop Prevention</button>
        <div id="test6-result" class="result"></div>
    </div>

    <!-- Load route configuration -->
    <script src="./routeConfig.js"></script>
    
    <script>
        // Mock route configuration for testing
        function createMockRouteConfig() {
            return {
                deployedBranches: ['main', 'develop', 'feature-test'],
                dakComponents: {
                    'dashboard': { component: 'DAKDashboard' },
                    'testing-viewer': { component: 'TestingViewer' },
                    'bpmn-editor': { component: 'BPMNEditor' }
                },
                standardComponents: {
                    'repositories': { routes: [{ path: '/repositories' }] },
                    'dak-selection': { routes: [{ path: '/dak-selection' }] }
                },
                isDeployedBranch: function(branch) {
                    return this.deployedBranches.includes(branch);
                },
                isValidComponent: function(component) {
                    return Object.keys(this.dakComponents).includes(component) ||
                           Object.keys(this.standardComponents).includes(component);
                }
            };
        }

        // Execute the 404.html routing logic with a mock location
        function executeRoutingLogic(hostname, pathname, search = '', hash = '') {
            const mockLocation = {
                hostname: hostname,
                pathname: pathname,
                search: search,
                hash: hash,
                host: hostname,
                protocol: 'https:',
                href: `https://${hostname}${pathname}${search}${hash}`,
                replace: function(url) {
                    this.redirectedTo = url;
                },
                errorShown: null
            };

            // Mock document.body for error display
            const mockDocument = {
                body: {
                    innerHTML: ''
                }
            };

            // Mock window.getSGEXRouteConfig
            window.getSGEXRouteConfig = function() {
                return createMockRouteConfig();
            };

            // Execute routing logic (copied from 404.html)
            try {
                const l = mockLocation;
                
                // First check if this is an existing redirect to prevent infinite loops
                if (l.search && l.search.indexOf('?/') === 0) {
                    l.errorShown = {
                        title: 'Redirect Loop Detected',
                        message: 'This URL has already been processed by the routing system but still resulted in a 404.',
                        code: 'routing-loop'
                    };
                    return l;
                }

                var pathSegments = l.pathname.split('/').filter(Boolean);
                
                // Check if this is GitHub Pages deployment
                var isGitHubPages = l.hostname === 'litlfred.github.io' || l.hostname.endsWith('.github.io');
                
                if (!isGitHubPages) {
                    // Standalone deployment - use simple SPA redirect
                    var routePath = pathSegments.join('/');
                    if (routePath) {
                        var newUrl = l.protocol + '//' + l.host + '/' +
                            '?/' + routePath.replace(/&/g, '~and~') +
                            (l.search ? '&' + l.search.slice(1).replace(/&/g, '~and~') : '') +
                            l.hash;
                        l.replace(newUrl);
                    }
                    return l;
                }

                // GitHub Pages deployment - check URL pattern
                if (pathSegments.length === 0 || pathSegments[0] !== 'sgex') {
                    l.errorShown = {
                        title: 'Invalid URL Pattern',
                        message: 'Expected URL to start with /sgex/ but got: ' + l.pathname,
                        code: 'invalid-base-path'
                    };
                    return l;
                }

                if (pathSegments.length === 1) {
                    // Just /sgex/ - redirect to root
                    var newUrl = l.protocol + '//' + l.host + '/sgex/' + l.hash;
                    l.replace(newUrl);
                    return l;
                }

                // Check if second segment is a deployed branch
                var secondSegment = pathSegments[1];
                var routeConfig = window.getSGEXRouteConfig();
                
                if (routeConfig && routeConfig.isDeployedBranch && routeConfig.isDeployedBranch(secondSegment)) {
                    // Branch deployment pattern: /sgex/:branch/:component/...
                    if (pathSegments.length < 3) {
                        // Just /sgex/:branch/ - redirect to branch root
                        var branchPath = '/' + pathSegments.slice(0, 2).join('/') + '/';
                        var newUrl = l.protocol + '//' + l.host + branchPath + l.hash;
                        l.replace(newUrl);
                        return l;
                    }

                    var branch = pathSegments[1];
                    var component = pathSegments[2];
                    
                    // Validate component exists in the deployed branch
                    if (!routeConfig.isValidComponent(component)) {
                        l.errorShown = {
                            title: 'Invalid Component',
                            message: 'Component "' + component + '" is not valid for branch "' + branch + '".',
                            code: 'invalid-component-for-branch'
                        };
                        return l;
                    }

                    // Route to branch SPA: /sgex/:branch/?/:component/...
                    var branchPath = '/' + pathSegments.slice(0, 2).join('/') + '/';
                    var routePath = pathSegments.slice(2).join('/');
                    var newUrl = l.protocol + '//' + l.host + branchPath;
                    
                    if (routePath) {
                        newUrl += '?/' + routePath.replace(/&/g, '~and~');
                    }
                    
                    if (l.search) {
                        newUrl += (routePath ? '&' : '?') + l.search.slice(1).replace(/&/g, '~and~');
                    }
                    
                    newUrl += l.hash;
                    l.replace(newUrl);
                    
                } else if (routeConfig && routeConfig.isValidComponent && routeConfig.isValidComponent(secondSegment)) {
                    // Component-first pattern: /sgex/:component/:user/:repo/:branch
                    // Route to main SPA: /sgex/?/:component/...
                    var routePath = pathSegments.slice(1).join('/'); // Remove 'sgex' prefix
                    var newUrl = l.protocol + '//' + l.host + '/sgex/';
                    
                    if (routePath) {
                        newUrl += '?/' + routePath.replace(/&/g, '~and~');
                    }
                    
                    if (l.search) {
                        newUrl += (routePath ? '&' : '?') + l.search.slice(1).replace(/&/g, '~and~');
                    }
                    
                    newUrl += l.hash;
                    l.replace(newUrl);
                    
                } else {
                    // Unknown pattern - show error
                    l.errorShown = {
                        title: 'Unknown URL Pattern',
                        message: 'The URL pattern is not recognized. Expected either /sgex/:branch/:component or /sgex/:component/:user/:repo but got: ' + l.pathname,
                        code: 'unknown-pattern'
                    };
                }

                return l;
                
            } catch (error) {
                mockLocation.error = error;
                return mockLocation;
            }
        }

        function testBranchFirstURL() {
            const result = executeRoutingLogic('litlfred.github.io', '/sgex/main/dashboard/demo-user/test-dak');
            const expected = 'https://litlfred.github.io/sgex/main/?/dashboard/demo-user/test-dak';
            const isCorrect = result.redirectedTo === expected;
            
            document.getElementById('test1-result').innerHTML = `
Result: ${isCorrect ? '<span class="pass">✅ PASS</span>' : '<span class="fail">❌ FAIL</span>'}
Input URL: /sgex/main/dashboard/demo-user/test-dak
Expected: ${expected}
Actual: ${result.redirectedTo || 'No redirect'}
Analysis: ${isCorrect ? 'Branch-first URL correctly routed to branch SPA' : 'Branch-first routing failed'}
${result.error ? 'Error: ' + result.error.message : ''}
            `;
        }

        function testComponentFirstURL() {
            const result = executeRoutingLogic('litlfred.github.io', '/sgex/dashboard/demo-user/test-dak/main');
            const expected = 'https://litlfred.github.io/sgex/?/dashboard/demo-user/test-dak/main';
            const isCorrect = result.redirectedTo === expected;
            
            document.getElementById('test2-result').innerHTML = `
Result: ${isCorrect ? '<span class="pass">✅ PASS</span>' : '<span class="fail">❌ FAIL</span>'}
Input URL: /sgex/dashboard/demo-user/test-dak/main
Expected: ${expected}
Actual: ${result.redirectedTo || 'No redirect'}
Analysis: ${isCorrect ? 'Component-first URL correctly routed to main SPA' : 'Component-first routing failed'}
${result.error ? 'Error: ' + result.error.message : ''}
            `;
        }

        function testInvalidBranch() {
            const result = executeRoutingLogic('litlfred.github.io', '/sgex/invalid-branch/dashboard/demo-user/test-dak');
            const hasError = result.errorShown && result.errorShown.code === 'unknown-pattern';
            
            document.getElementById('test3-result').innerHTML = `
Result: ${hasError ? '<span class="pass">✅ PASS</span>' : '<span class="fail">❌ FAIL</span>'}
Input URL: /sgex/invalid-branch/dashboard/demo-user/test-dak
Expected: Error message about unknown pattern
Actual: ${result.errorShown ? result.errorShown.title + ' - ' + result.errorShown.message : 'No error shown'}
Analysis: ${hasError ? 'Invalid branch correctly triggers error handling' : 'Invalid branch should trigger error'}
            `;
        }

        function testInvalidComponent() {
            const result = executeRoutingLogic('litlfred.github.io', '/sgex/main/invalid-component/demo-user/test-dak');
            const hasError = result.errorShown && result.errorShown.code === 'invalid-component-for-branch';
            
            document.getElementById('test4-result').innerHTML = `
Result: ${hasError ? '<span class="pass">✅ PASS</span>' : '<span class="fail">❌ FAIL</span>'}
Input URL: /sgex/main/invalid-component/demo-user/test-dak
Expected: Error about invalid component for branch
Actual: ${result.errorShown ? result.errorShown.title + ' - ' + result.errorShown.message : 'No error shown'}
Analysis: ${hasError ? 'Invalid component correctly triggers error handling' : 'Invalid component should trigger error'}
            `;
        }

        function testRouteConfig() {
            const config = window.getSGEXRouteConfig ? window.getSGEXRouteConfig() : null;
            const hasConfig = config && config.isValidComponent && config.isDeployedBranch;
            const testValid = hasConfig && config.isValidComponent('dashboard');
            const testBranch = hasConfig && config.isDeployedBranch('main');
            
            document.getElementById('test5-result').innerHTML = `
Result: ${hasConfig ? '<span class="pass">✅ PASS</span>' : '<span class="fail">❌ FAIL</span>'}
Route Config Available: ${config ? 'Yes' : 'No'}
Has Required Methods: ${hasConfig ? 'Yes' : 'No'}
Valid Component Test: ${testValid ? 'dashboard = valid ✓' : 'dashboard test failed ✗'}
Valid Branch Test: ${testBranch ? 'main = deployed ✓' : 'main test failed ✗'}
Analysis: ${hasConfig ? 'Route configuration system working correctly' : 'Route configuration not properly loaded'}
            `;
        }

        function testRedirectLoop() {
            const result = executeRoutingLogic('litlfred.github.io', '/sgex/dashboard/demo-user/test-dak', '?/already-redirected');
            const hasError = result.errorShown && result.errorShown.code === 'routing-loop';
            
            document.getElementById('test6-result').innerHTML = `
Result: ${hasError ? '<span class="pass">✅ PASS</span>' : '<span class="fail">❌ FAIL</span>'}
Input URL: /sgex/dashboard/demo-user/test-dak?/already-redirected
Expected: Redirect loop detection error
Actual: ${result.errorShown ? result.errorShown.title + ' - ' + result.errorShown.message : 'No error shown'}
Analysis: ${hasError ? 'Redirect loop correctly detected and prevented' : 'Redirect loop detection failed'}
            `;
        }
    </script>
</body>
</html>