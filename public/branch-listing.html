<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1976d2" />
    <meta name="description" content="SGEX Branch & PR Selector - View live previews of all branches and pull requests" />
    <title>SGEX Branch & PR Selector</title>
    <link rel="icon" href="favicon.ico" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --who-primary: #1976d2;
            --who-primary-dark: #1565c0;
            --who-primary-light: #42a5f5;
            --who-secondary: #ffc107;
            --who-secondary-dark: #ff8f00;
            --who-success: #4caf50;
            --who-success-dark: #388e3c;
            --who-warning: #ff9800;
            --who-warning-dark: #f57c00;
            --who-error: #f44336;
            --who-error-dark: #d32f2f;
            --who-info: #2196f3;
            --who-info-dark: #1976d2;
            --who-surface: #ffffff;
            --who-background: #f5f5f5;
            --who-text-primary: rgba(0, 0, 0, 0.87);
            --who-text-secondary: rgba(0, 0, 0, 0.54);
            --who-text-muted: rgba(0, 0, 0, 0.38);
            --who-border: rgba(0, 0, 0, 0.12);
            --who-hover-bg: rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--who-background);
            color: var(--who-text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: linear-gradient(135deg, var(--who-primary) 0%, var(--who-primary-dark) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 64px;
            height: 64px;
            border-radius: 12px;
        }

        .header-text h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header-text p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .auth-section {
            background: var(--who-surface);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--who-border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .auth-section h3 {
            color: var(--who-primary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .auth-form {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 300px;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--who-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--who-primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .btn-primary {
            background: var(--who-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--who-primary-dark);
        }

        .btn-success {
            background: var(--who-success);
            color: white;
        }

        .btn-success:hover {
            background: var(--who-success-dark);
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
        }

        .auth-status.authenticated {
            background: #dcfce7;
            color: #166534;
        }

        .auth-status.unauthenticated {
            background: #fee2e2;
            color: #991b1b;
        }

        .filters-section {
            background: var(--who-surface);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--who-border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filters-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--who-text-secondary);
            font-size: 0.9rem;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--who-border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--who-primary);
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 0.75rem 1rem;
            border: 2px solid var(--who-border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--who-primary);
        }

        .pr-cards {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .pr-card {
            background: var(--who-surface);
            border: 1px solid var(--who-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .pr-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .pr-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .pr-info {
            flex: 1;
        }

        .pr-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--who-text-primary);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .pr-meta {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: var(--who-text-secondary);
        }

        .pr-badges {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .state-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .state-badge.open {
            background: #dcfce7;
            color: #166534;
        }

        .state-badge.closed {
            background: #fee2e2;
            color: #991b1b;
        }

        .deployment-status {
            background: var(--who-hover-bg);
            color: var(--who-text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .deployment-status.success {
            background: #dcfce7;
            color: #166534;
        }

        .deployment-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .deployment-status.in-progress {
            background: #dbeafe;
            color: #1e40af;
        }

        .deployment-status.queued {
            background: #fef3c7;
            color: #92400e;
        }

        .deployment-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .deployment-status.unknown {
            background: var(--who-hover-bg);
            color: var(--who-text-muted);
        }

        .pr-description {
            margin-bottom: 1rem;
            color: var(--who-text-secondary);
            line-height: 1.5;
        }

        .pr-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .preview-link, .pr-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .preview-link {
            background: var(--who-primary);
            color: white;
        }

        .preview-link:hover {
            background: var(--who-primary-dark);
            color: white;
        }

        .pr-link {
            background: #6f42c1;
            color: white;
        }

        .pr-link:hover {
            background: #5a359a;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--who-border);
            background: var(--who-surface);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--who-hover-bg);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: var(--who-primary);
            color: white;
            border-color: var(--who-primary);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--who-text-secondary);
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--who-text-secondary);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--who-text-primary);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-text h1 {
                font-size: 2rem;
            }

            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }

            .pr-actions {
                flex-direction: column;
            }

            .preview-link, .pr-link {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <img src="sgex-mascot.png" alt="SGEX Icon" class="logo" />
            <div class="header-text">
                <h1>SGEX Workbench</h1>
                <p>Branch & PR Preview Selector</p>
            </div>
        </div>
    </header>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const ITEMS_PER_PAGE = 10;

        function App() {
            const [pullRequests, setPullRequests] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [page, setPage] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('updated');
            const [sortOrder, setSortOrder] = useState('desc');
            const [filter, setFilter] = useState('open');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [githubToken, setGithubToken] = useState(null);
            const [tokenInput, setTokenInput] = useState('');
            const [deploymentStatuses, setDeploymentStatuses] = useState({});

            // Check for stored token on load
            useEffect(() => {
                const storedToken = localStorage.getItem('github_token');
                if (storedToken) {
                    setTokenInput(storedToken);
                    setGithubToken(storedToken);
                    setIsAuthenticated(true);
                }
            }, []);

            // Function to check deployment status for a branch
            const checkDeploymentStatus = async (safeBranchName) => {
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/litlfred/sgex/actions/workflows/deploy.yml/runs?branch=${safeBranchName}&per_page=1`,
                        {
                            headers: githubToken ? {
                                'Authorization': `token ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            } : {
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch deployment status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.workflow_runs && data.workflow_runs.length > 0) {
                        const latestRun = data.workflow_runs[0];
                        return {
                            status: latestRun.status,
                            conclusion: latestRun.conclusion,
                            html_url: latestRun.html_url,
                            created_at: latestRun.created_at
                        };
                    }
                    
                    return { status: 'unknown', conclusion: null };
                } catch (error) {
                    console.error(`Error checking deployment status for ${safeBranchName}:`, error);
                    return { status: 'error', conclusion: 'error' };
                }
            };

            // Function to update deployment statuses for visible PRs
            const updateDeploymentStatuses = useCallback(async (prs) => {
                if (prs.length === 0) return;
                
                const statuses = {};
                for (const pr of prs) {
                    statuses[pr.safeBranchName] = await checkDeploymentStatus(pr.safeBranchName);
                }
                
                setDeploymentStatuses(prev => ({ ...prev, ...statuses }));
            }, [githubToken]);

            // Function to get deployment status display info
            const getDeploymentStatusInfo = (safeBranchName) => {
                const status = deploymentStatuses[safeBranchName];
                if (!status) return { text: 'Checking...', class: 'unknown' };
                
                if (status.status === 'completed' && status.conclusion === 'success') {
                    return { text: '✅ Deployed', class: 'success' };
                } else if (status.status === 'completed' && status.conclusion === 'failure') {
                    return { text: '❌ Failed', class: 'failed' };
                } else if (status.status === 'in_progress') {
                    return { text: '🔄 Deploying', class: 'in-progress' };
                } else if (status.status === 'queued') {
                    return { text: '⏳ Queued', class: 'queued' };
                } else if (status.status === 'error') {
                    return { text: '⚠️ Error', class: 'error' };
                } else {
                    return { text: '❓ Unknown', class: 'unknown' };
                }
            };

            // Authenticate with GitHub
            const handleAuth = () => {
                if (tokenInput.trim()) {
                    setGithubToken(tokenInput.trim());
                    setIsAuthenticated(true);
                    localStorage.setItem('github_token', tokenInput.trim());
                } else {
                    setGithubToken(null);
                    setIsAuthenticated(false);
                    localStorage.removeItem('github_token');
                }
            };

            // Logout
            const handleLogout = () => {
                setGithubToken(null);
                setIsAuthenticated(false);
                setTokenInput('');
                localStorage.removeItem('github_token');
            };

            // Sorting functions
            const sortPRs = (prs, sortBy, sortOrder = 'desc') => {
                return [...prs].sort((a, b) => {
                    let comparison = 0;
                    switch (sortBy) {
                        case 'number':
                            comparison = b.number - a.number;
                            break;
                        case 'alphabetical':
                            comparison = a.title.localeCompare(b.title);
                            break;
                        case 'updated':
                        default:
                            const dateA = new Date(a.updatedAt);
                            const dateB = new Date(b.updatedAt);
                            comparison = dateB - dateA;
                            break;
                    }
                    
                    // Reverse comparison for ascending order
                    return sortOrder === 'asc' ? -comparison : comparison;
                });
            };

            // Fetch pull requests
            const fetchPullRequests = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    const headers = {
                        'Accept': 'application/vnd.github.v3+json'
                    };

                    if (githubToken) {
                        headers['Authorization'] = `token ${githubToken}`;
                    }

                    const response = await fetch(
                        `https://api.github.com/repos/litlfred/sgex/pulls?state=${filter}&per_page=100`,
                        { headers }
                    );

                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                    }

                    const prs = await response.json();

                    const processedPRs = prs.map(pr => {
                        const safeBranchName = pr.head.ref.replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase();
                        return {
                            id: pr.id,
                            number: pr.number,
                            title: pr.title,
                            body: pr.body || '',
                            state: pr.state,
                            author: pr.user.login,
                            branchName: pr.head.ref,
                            safeBranchName: safeBranchName,
                            url: `./${safeBranchName}/index.html`,
                            prUrl: pr.html_url,
                            updatedAt: new Date(pr.updated_at).toLocaleDateString(),
                            createdAt: new Date(pr.created_at).toLocaleDateString()
                        };
                    });

                    setPullRequests(processedPRs);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // Initial load and refresh when filter/auth changes
            useEffect(() => {
                fetchPullRequests();
            }, [filter, githubToken]);

            // Poll deployment statuses every 7 seconds for visible PRs
            useEffect(() => {
                if (pullRequests.length === 0) return;
                
                const filtered = pullRequests.filter(pr => 
                    pr.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    pr.author.toLowerCase().includes(searchTerm.toLowerCase())
                );
                const sorted = sortPRs(filtered, sortBy, sortOrder);
                const paginated = sorted.slice((page - 1) * ITEMS_PER_PAGE, page * ITEMS_PER_PAGE);
                
                // Initial status check
                updateDeploymentStatuses(paginated);
                
                // Set up polling every 7 seconds
                const interval = setInterval(() => {
                    updateDeploymentStatuses(paginated);
                }, 7000);
                
                return () => clearInterval(interval);
            }, [pullRequests, searchTerm, sortBy, sortOrder, page, updateDeploymentStatuses]);

            // Filter and sort PRs
            const filteredPRs = pullRequests.filter(pr => 
                pr.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                pr.author.toLowerCase().includes(searchTerm.toLowerCase())
            );
            const sortedPRs = sortPRs(filteredPRs, sortBy, sortOrder);
            const paginatedPRs = sortedPRs.slice((page - 1) * ITEMS_PER_PAGE, page * ITEMS_PER_PAGE);
            const totalPages = Math.ceil(sortedPRs.length / ITEMS_PER_PAGE);

            return (
                <div className="container">
                    {/* Authentication Section */}
                    <div className="auth-section">
                        <h3>🔐 GitHub Authentication</h3>
                        <div className="auth-form">
                            {!isAuthenticated ? (
                                <>
                                    <div className="input-group">
                                        <input
                                            type="password"
                                            className="form-input"
                                            placeholder="Enter GitHub Personal Access Token (optional)"
                                            value={tokenInput}
                                            onChange={(e) => setTokenInput(e.target.value)}
                                        />
                                    </div>
                                    <button className="btn btn-primary" onClick={handleAuth}>
                                        🔑 Authenticate
                                    </button>
                                </>
                            ) : (
                                <>
                                    <div className="auth-status authenticated">
                                        ✅ Authenticated - Full access to private repos and higher rate limits
                                    </div>
                                    <button className="btn btn-primary" onClick={handleLogout}>
                                        🚪 Logout
                                    </button>
                                </>
                            )}
                        </div>
                        {!isAuthenticated && (
                            <p style={{ marginTop: '1rem', fontSize: '0.9rem', color: 'var(--who-text-secondary)' }}>
                                Authentication is optional but recommended for higher API rate limits and access to private repositories.
                            </p>
                        )}
                    </div>

                    {/* Filters and Search */}
                    <div className="filters-section">
                        <div className="filters-row">
                            <div className="filter-group">
                                <label>Filter:</label>
                                <select
                                    value={filter}
                                    onChange={(e) => {
                                        setFilter(e.target.value);
                                        setPage(1);
                                    }}
                                    className="filter-select"
                                >
                                    <option value="open">Open PRs</option>
                                    <option value="closed">Closed PRs</option>
                                    <option value="all">All PRs</option>
                                </select>
                            </div>
                            
                            <div className="filter-group">
                                <label>Sort by:</label>
                                <select
                                    value={sortBy}
                                    onChange={(e) => {
                                        setSortBy(e.target.value);
                                        setPage(1);
                                    }}
                                    className="filter-select"
                                >
                                    <option value="updated">Last Updated</option>
                                    <option value="number">PR Number</option>
                                    <option value="alphabetical">Alphabetical</option>
                                </select>
                            </div>
                            
                            <div className="filter-group">
                                <label>Order:</label>
                                <select
                                    value={sortOrder}
                                    onChange={(e) => {
                                        setSortOrder(e.target.value);
                                        setPage(1);
                                    }}
                                    className="filter-select"
                                >
                                    <option value="desc">Descending</option>
                                    <option value="asc">Ascending</option>
                                </select>
                            </div>
                            
                            <input
                                type="text"
                                className="search-input"
                                placeholder="Search pull requests..."
                                value={searchTerm}
                                onChange={(e) => {
                                    setSearchTerm(e.target.value);
                                    setPage(1);
                                }}
                            />
                        </div>
                    </div>

                    {/* Content */}
                    {loading && (
                        <div className="loading">
                            <p>🔄 Loading pull requests...</p>
                        </div>
                    )}

                    {error && (
                        <div className="error">
                            <strong>Error:</strong> {error}
                        </div>
                    )}

                    {!loading && !error && sortedPRs.length === 0 && (
                        <div className="empty-state">
                            <h3>🔍 No pull requests found</h3>
                            <p>Try adjusting your search terms or filters.</p>
                        </div>
                    )}

                    {!loading && !error && paginatedPRs.length > 0 && (
                        <>
                            <div className="pr-cards">
                                {paginatedPRs.map(pr => (
                                    <div key={pr.id} className="pr-card">
                                        <div className="pr-header">
                                            <div className="pr-info">
                                                <h3 className="pr-title">#{pr.number}: {pr.title}</h3>
                                                <div className="pr-meta">
                                                    <span>👤 {pr.author}</span>
                                                    <span>🌿 {pr.branchName}</span>
                                                    <span>📅 Updated {pr.updatedAt}</span>
                                                </div>
                                                <div className="pr-badges">
                                                    <span className={`state-badge ${pr.state}`}>
                                                        {pr.state === 'open' ? '🟢' : '🔴'} {pr.state}
                                                    </span>
                                                    <span className={`deployment-status ${getDeploymentStatusInfo(pr.safeBranchName).class}`}>
                                                        {getDeploymentStatusInfo(pr.safeBranchName).text}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {pr.body && (
                                            <div className="pr-description">
                                                {pr.body.length > 200 ? pr.body.substring(0, 200) + '...' : pr.body}
                                            </div>
                                        )}
                                        
                                        <div className="pr-actions">
                                            <a 
                                                href={pr.url} 
                                                className="preview-link"
                                                target="_blank"
                                                rel="noopener noreferrer"
                                            >
                                                <span>🚀 View Preview</span>
                                            </a>
                                            
                                            <a 
                                                href={pr.prUrl} 
                                                className="pr-link"
                                                target="_blank"
                                                rel="noopener noreferrer"
                                            >
                                                <span>📋 View PR</span>
                                            </a>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Pagination */}
                            {totalPages > 1 && (
                                <div className="pagination">
                                    <button 
                                        onClick={() => setPage(page - 1)} 
                                        disabled={page === 1}
                                    >
                                        ← Previous
                                    </button>
                                    
                                    <span>Page {page} of {totalPages}</span>
                                    
                                    <button 
                                        onClick={() => setPage(page + 1)} 
                                        disabled={page === totalPages}
                                    >
                                        Next →
                                    </button>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>