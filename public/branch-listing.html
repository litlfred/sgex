<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGEX Branch & PR Previews</title>
    <script src="https://unpkg.com/react@19/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@19/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --who-blue: #0366d6;
            --who-text-primary: #333;
            --who-text-secondary: #586069;
            --who-text-muted: #6a737d;
            --who-border-color: #e1e5e9;
            --who-card-bg: #ffffff;
            --who-secondary-bg: #f8f9fa;
            --who-tertiary-bg: #f8f9fa;
            --who-hover-bg: #f1f3f4;
            --who-selected-bg: #e1e7fd;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: #f5f5f5;
            color: var(--who-text-primary);
        }

        /* Basic styles for the branch listing */
        .branch-listing {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .branch-listing-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .branch-listing-header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .sgex-icon {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #666;
            margin: 0 0 1rem 0;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6a737d;
            font-size: 1.2rem;
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: #d73a49;
        }

        .prominent-info {
            background: var(--who-secondary-bg);
            border: 2px solid var(--who-blue);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .info-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--who-text-primary);
            margin: 0;
        }

        /* Authentication section */
        .auth-section {
            background: var(--who-tertiary-bg);
            border: 1px solid var(--who-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .login-section h3 {
            color: var(--who-text-primary);
            margin-bottom: 1rem;
        }

        .login-section p {
            color: var(--who-text-secondary);
            margin-bottom: 1rem;
        }

        .authenticated-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .authenticated-section p {
            color: #28a745;
            font-weight: 500;
            margin: 0;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* PAT Login styles */
        .pat-login-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .pat-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .pat-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .pat-input-group label {
            font-weight: 500;
            color: var(--who-text-primary);
        }

        .pat-input {
            padding: 0.75rem;
            border: 1px solid var(--who-border-color);
            border-radius: 6px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }

        .pat-input:focus {
            outline: none;
            border-color: var(--who-blue);
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
        }

        .pat-login-btn {
            background: var(--who-blue);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .pat-login-btn:hover:not(:disabled) {
            background: #0256cc;
        }

        .pat-login-btn:disabled {
            background: var(--who-text-muted);
            cursor: not-allowed;
        }

        .pat-error {
            color: #d73a49;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Main action buttons */
        .main-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .contribute-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .contribute-btn.primary {
            background: #28a745;
            color: white;
        }

        .contribute-btn.primary:hover {
            background: #218838;
            color: white;
            text-decoration: none;
        }

        .contribute-btn.secondary {
            background: #0366d6;
            color: white;
        }

        .contribute-btn.secondary:hover {
            background: #0256cc;
            color: white;
            text-decoration: none;
        }

        .contribute-btn.tertiary {
            background: #6f42c1;
            color: white;
        }

        .contribute-btn.tertiary:hover {
            background: #5a32a3;
            color: white;
            text-decoration: none;
        }

        /* Preview tabs */
        .preview-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--who-border-color);
        }

        .tab-button {
            background: none;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--who-text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            color: var(--who-blue);
        }

        .tab-button.active {
            color: var(--who-blue);
            border-bottom-color: var(--who-blue);
        }

        /* Controls */
        .pr-controls {
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .pr-filter-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pr-filter-section label {
            font-weight: 500;
            color: var(--who-text-primary);
        }

        .filter-select, .sort-select {
            padding: 0.5rem;
            border: 1px solid var(--who-border-color);
            border-radius: 6px;
            background: var(--who-card-bg);
            color: var(--who-text-primary);
            cursor: pointer;
        }

        .pr-search {
            width: 100%;
            max-width: 500px;
            padding: 0.75rem 1rem;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            background: #ffffff;
        }

        .pr-search:focus, .filter-select:focus, .sort-select:focus {
            outline: none;
            border-color: var(--who-blue);
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
        }

        /* Cards */
        .pr-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .preview-card {
            border: 1px solid var(--who-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            background: var(--who-card-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .preview-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border-color: var(--who-blue);
        }

        .pr-card {
            border-left: 4px solid #0366d6;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .item-name {
            margin: 0;
            font-size: 1.2rem;
            color: var(--who-blue);
            font-weight: 600;
            word-break: break-word;
            flex: 1;
            line-height: 1.4;
        }

        .card-badges {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .state-badge, .status-badge {
            background: var(--who-hover-bg);
            color: var(--who-text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .state-badge.open {
            background: #dcfce7;
            color: #166534;
        }

        .state-badge.closed {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.active {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.not-found {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.errored {
            background: #fee2e2;
            color: #991b1b;
        }

        .card-body {
            margin-bottom: 1rem;
        }

        .pr-meta, .item-date {
            color: var(--who-text-secondary);
            font-size: 0.9rem;
            margin: 0 0 1rem 0;
        }

        .pr-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .preview-link, .pr-link, .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
        }

        .preview-link {
            background: #0366d6;
        }

        .preview-link:hover {
            background: #0256cc;
            text-decoration: none;
            color: white;
        }

        .copy-btn {
            background: #28a745;
        }

        .copy-btn:hover {
            background: #218838;
            color: white;
        }

        .pr-link {
            background: #6f42c1;
        }

        .pr-link:hover {
            background: #5a32a3;
        }

        .card-footer {
            border-top: 1px solid #e1e5e9;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .preview-path {
            color: #6a737d;
            font-size: 0.8rem;
            word-break: break-all;
        }

        .no-items {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: #6a737d;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .pagination-btn {
            background: var(--who-hover-bg);
            border: 1px solid var(--who-border-color);
            color: var(--who-blue);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--who-selected-bg);
            border-color: var(--who-blue);
        }

        .pagination-btn:disabled {
            color: var(--who-text-muted);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination-info {
            color: var(--who-text-secondary);
            font-size: 0.9rem;
        }

        /* Discussion Summary Status Bar */
        .discussion-summary-bar {
            background: var(--who-secondary-bg);
            border: 1px solid var(--who-border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .discussion-summary-bar:hover {
            background: var(--who-hover-bg);
            border-color: var(--who-blue);
        }

        .discussion-summary-text {
            color: var(--who-text-primary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .discussion-summary-icon {
            color: var(--who-blue);
            font-weight: bold;
        }

        .discussion-expand-icon {
            color: var(--who-text-secondary);
            transition: transform 0.2s ease;
        }

        .discussion-expand-icon.expanded {
            transform: rotate(90deg);
        }

        /* Expanded Discussion Section */
        .discussion-expanded-section {
            margin-top: 0.5rem;
            border: 1px solid var(--who-border-color);
            border-radius: 8px;
            background: var(--who-card-bg);
            overflow: hidden;
        }

        .discussion-header {
            background: var(--who-secondary-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--who-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .discussion-title {
            font-weight: 600;
            color: var(--who-text-primary);
            margin: 0;
        }

        .discussion-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .discussion-action-btn {
            background: var(--who-blue);
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .discussion-action-btn:hover {
            background: #0256cc;
            color: white;
            text-decoration: none;
        }

        .discussion-action-btn.secondary {
            background: #6f42c1;
        }

        .discussion-action-btn.secondary:hover {
            background: #5a32a3;
        }

        .comment-input-section {
            padding: 1rem;
            border-bottom: 1px solid var(--who-border-color);
            background: var(--who-tertiary-bg);
        }

        .discussion-scroll-area {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Comments */
        .pr-comments-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--who-border-color);
        }

        .pr-comments-section h4 {
            margin: 0 0 1rem 0;
            color: var(--who-text-primary);
            font-size: 1rem;
        }

        .comments-loading {
            color: var(--who-text-secondary);
            font-style: italic;
            padding: 0.5rem;
        }

        .comments-list {
            margin-bottom: 1rem;
        }

        .comment-item {
            background: var(--who-secondary-bg);
            border: 1px solid var(--who-border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .comment-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .comment-author {
            font-weight: 600;
            color: var(--who-blue);
            font-size: 0.9rem;
        }

        .comment-date {
            color: var(--who-text-secondary);
            font-size: 0.8rem;
            margin-left: auto;
        }

        .comment-body {
            color: var(--who-text-primary);
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .no-comments {
            color: var(--who-text-secondary);
            font-style: italic;
            padding: 0.5rem;
            text-align: center;
        }

        .comment-input-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .comment-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--who-border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 60px;
            box-sizing: border-box;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--who-blue);
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
        }

        .submit-comment-btn {
            align-self: flex-start;
            background: var(--who-blue);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .submit-comment-btn:hover:not(:disabled) {
            background: #0256cc;
        }

        .submit-comment-btn:disabled {
            background: var(--who-text-muted);
            cursor: not-allowed;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .branch-listing {
                padding: 1rem;
            }
            
            .pr-cards {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .branch-listing-header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .preview-card {
                padding: 1rem;
            }
            
            .card-header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }

            .card-badges {
                flex-direction: row;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .main-actions {
                flex-direction: column;
                align-items: center;
            }

            .contribute-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }

            .preview-tabs {
                flex-direction: column;
            }

            .tab-button {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid #e1e5e9;
                border-radius: 0;
            }

            .tab-button.active {
                border-bottom-color: #0366d6;
                background: #f8f9fa;
            }

            .pr-actions {
                justify-content: center;
            }

            .pr-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .pr-filter-section {
                justify-content: center;
            }

            .authenticated-section {
                flex-direction: column;
                gap: 0.5rem;
            }

            .pagination {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Simple PAT Login Component
        const PATLogin = ({ onAuthSuccess }) => {
            const [token, setToken] = useState('');
            const [username, setUsername] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!token.trim() || !username.trim()) {
                    setError('Please provide both token and username');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    // Test the token
                    const response = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Invalid token or insufficient permissions');
                    }

                    // Create a mock Octokit instance for compatibility
                    const mockOctokit = { auth: token };
                    onAuthSuccess(token, mockOctokit);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="pat-login-container">
                    <form onSubmit={handleSubmit} className="pat-form">
                        <div className="pat-input-group">
                            <label htmlFor="username">Token Description/Username:</label>
                            <input
                                id="username"
                                type="text"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                placeholder="e.g., my-sgex-token or username"
                                className="pat-input"
                                required
                            />
                        </div>
                        <div className="pat-input-group">
                            <label htmlFor="token">GitHub Personal Access Token:</label>
                            <input
                                id="token"
                                type="password"
                                value={token}
                                onChange={(e) => setToken(e.target.value)}
                                placeholder="ghp_..."
                                className="pat-input"
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            disabled={loading || !token.trim() || !username.trim()}
                            className="pat-login-btn"
                        >
                            {loading ? 'Authenticating...' : 'Login'}
                        </button>
                        {error && <div className="pat-error">{error}</div>}
                    </form>
                </div>
            );
        };

        // Main BranchListing Component
        const BranchListing = () => {
            const [pullRequests, setPullRequests] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [prPage, setPrPage] = useState(1);
            const [prSearchTerm, setPrSearchTerm] = useState('');
            const [prSortBy, setPrSortBy] = useState('updated');
            const [prFilter, setPrFilter] = useState('open');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [githubToken, setGithubToken] = useState(null);
            const [prComments, setPrComments] = useState({});
            const [loadingComments, setLoadingComments] = useState(false);
            const [commentInputs, setCommentInputs] = useState({});
            const [submittingComments, setSubmittingComments] = useState({});
            const [expandedDiscussions, setExpandedDiscussions] = useState({});
            const [discussionSummaries, setDiscussionSummaries] = useState({});
            const [loadingSummaries, setLoadingSummaries] = useState(false);

            const ITEMS_PER_PAGE = 10;

            // GitHub authentication functions
            const handleAuthSuccess = (token, octokitInstance) => {
                setGithubToken(token);
                setIsAuthenticated(true);
                sessionStorage.setItem('github_token', token);
            };

            const handleLogout = () => {
                setGithubToken(null);
                setIsAuthenticated(false);
                sessionStorage.removeItem('github_token');
                setPrComments({});
            };

            // Function to fetch PR comments summary
            const fetchPRCommentsSummary = async (prNumber) => {
                if (!githubToken) return null;
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/litlfred/sgex/issues/${prNumber}/comments`,
                        {
                            headers: {
                                'Authorization': `token ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch comments: ${response.status}`);
                    }
                    
                    const comments = await response.json();
                    if (comments.length === 0) {
                        return { count: 0, lastComment: null };
                    }
                    
                    const lastComment = comments[comments.length - 1];
                    return {
                        count: comments.length,
                        lastComment: {
                            author: lastComment.user.login,
                            created_at: new Date(lastComment.created_at),
                            avatar_url: lastComment.user.avatar_url
                        }
                    };
                } catch (error) {
                    console.error(`Error fetching comment summary for PR ${prNumber}:`, error);
                    return null;
                }
            };

            // Function to fetch all PR comments (for expanded view)
            const fetchAllPRComments = async (prNumber) => {
                if (!githubToken) return [];
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/litlfred/sgex/issues/${prNumber}/comments`,
                        {
                            headers: {
                                'Authorization': `token ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch comments: ${response.status}`);
                    }
                    
                    const comments = await response.json();
                    return comments.map(comment => ({
                        id: comment.id,
                        author: comment.user.login,
                        body: comment.body,
                        created_at: new Date(comment.created_at).toLocaleDateString(),
                        avatar_url: comment.user.avatar_url
                    }));
                } catch (error) {
                    console.error(`Error fetching all comments for PR ${prNumber}:`, error);
                    return [];
                }
            };

            // Function to load discussion summaries for visible PRs
            const loadDiscussionSummaries = useCallback(async (prs) => {
                if (!githubToken || prs.length === 0) return;
                
                setLoadingSummaries(true);
                const summaries = {};
                
                for (const pr of prs) {
                    summaries[pr.number] = await fetchPRCommentsSummary(pr.number);
                }
                
                setDiscussionSummaries(summaries);
                setLoadingSummaries(false);
            }, [githubToken]);

            // Function to toggle discussion expansion
            const toggleDiscussion = async (prNumber) => {
                const isExpanded = expandedDiscussions[prNumber];
                
                if (!isExpanded) {
                    // Load all comments when expanding
                    const comments = await fetchAllPRComments(prNumber);
                    setPrComments(prev => ({ ...prev, [prNumber]: comments }));
                }
                
                setExpandedDiscussions(prev => ({
                    ...prev,
                    [prNumber]: !isExpanded
                }));
            };

            // Function to get discussion summary text
            const getDiscussionSummaryText = (prNumber) => {
                const summary = discussionSummaries[prNumber];
                
                if (loadingSummaries) {
                    return "Loading discussion...";
                }
                
                if (!summary || summary.count === 0) {
                    return "No comments yet";
                }
                
                const { count, lastComment } = summary;
                const timeAgo = lastComment ? getTimeAgo(lastComment.created_at) : '';
                
                return `${count} comment${count > 1 ? 's' : ''}, last by ${lastComment.author} ${timeAgo}`;
            };

            // Helper function to get relative time
            const getTimeAgo = (date) => {
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'today';
                if (diffDays === 1) return '1 day ago';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;
                return `${Math.floor(diffDays / 30)} month${Math.floor(diffDays / 30) > 1 ? 's' : ''} ago`;
            };

            // Function to fetch PR comments
            const fetchPRComments = async (prNumber) => {
                if (!githubToken) return [];
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/litlfred/sgex/issues/${prNumber}/comments`,
                        {
                            headers: {
                                'Authorization': `token ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch comments: ${response.status}`);
                    }
                    
                    const comments = await response.json();
                    return comments.slice(-4).map(comment => ({
                        id: comment.id,
                        author: comment.user.login,
                        body: comment.body.split('\n').slice(0, 2).join('\n').substring(0, 200) + (comment.body.length > 200 ? '...' : ''),
                        created_at: new Date(comment.created_at).toLocaleDateString(),
                        avatar_url: comment.user.avatar_url
                    }));
                } catch (error) {
                    console.error(`Error fetching comments for PR ${prNumber}:`, error);
                    return [];
                }
            };

            // Function to submit a comment
            const submitComment = async (prNumber, commentText) => {
                if (!githubToken || !commentText.trim()) return false;
                
                setSubmittingComments(prev => ({ ...prev, [prNumber]: true }));
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/litlfred/sgex/issues/${prNumber}/comments`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `token ${githubToken}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                body: commentText
                            })
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Failed to submit comment: ${response.status}`);
                    }
                    
                    setCommentInputs(prev => ({ ...prev, [prNumber]: '' }));
                    
                    // Refresh both full comments (if expanded) and summary
                    if (expandedDiscussions[prNumber]) {
                        const updatedComments = await fetchAllPRComments(prNumber);
                        setPrComments(prev => ({ ...prev, [prNumber]: updatedComments }));
                    }
                    
                    // Refresh the discussion summary
                    const updatedSummary = await fetchPRCommentsSummary(prNumber);
                    setDiscussionSummaries(prev => ({ ...prev, [prNumber]: updatedSummary }));
                    
                    return true;
                } catch (error) {
                    console.error(`Error submitting comment for PR ${prNumber}:`, error);
                    return false;
                } finally {
                    setSubmittingComments(prev => ({ ...prev, [prNumber]: false }));
                }
            };

            // Function to load comments for all visible PRs
            const loadCommentsForPRs = useCallback(async (prs) => {
                if (!githubToken || prs.length === 0) return;
                
                setLoadingComments(true);
                const comments = {};
                
                for (const pr of prs) {
                    comments[pr.number] = await fetchPRComments(pr.number);
                }
                
                setPrComments(comments);
                setLoadingComments(false);
            }, [githubToken]);

            // Copy to clipboard function
            const copyToClipboard = async (url, type, name) => {
                try {
                    await navigator.clipboard.writeText(url);
                    console.log(`Copied ${type} URL for ${name} to clipboard`);
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    console.log(`Copied ${type} URL for ${name} to clipboard (fallback)`);
                }
            };

            // Sorting functions
            const sortPRs = (prs, sortBy) => {
                return [...prs].sort((a, b) => {
                    switch (sortBy) {
                        case 'number':
                            return b.number - a.number;
                        case 'alphabetical':
                            return a.title.localeCompare(b.title);
                        case 'updated':
                        default:
                            const dateA = new Date(a.updatedAt);
                            const dateB = new Date(b.updatedAt);
                            return dateB - dateA;
                    }
                });
            };

            // Check for existing authentication on component mount
            useEffect(() => {
                const token = sessionStorage.getItem('github_token');
                if (token) {
                    setGithubToken(token);
                    setIsAuthenticated(true);
                }
            }, []);

            // Fetch data
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setLoading(true);
                        
                        const owner = 'litlfred';
                        const repo = 'sgex';
                        
                        const prState = prFilter === 'all' ? 'all' : prFilter;
                        const prResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/pulls?state=${prState}&sort=updated&per_page=100`);
                        if (!prResponse.ok) {
                            throw new Error(`Failed to fetch pull requests: ${prResponse.status}`);
                        }
                        const prData = await prResponse.json();
                        
                        const formattedPRs = prData.map(pr => {
                            const safeBranchName = pr.head.ref.replace(/\//g, '-');
                            return {
                                id: pr.id,
                                number: pr.number,
                                title: pr.title,
                                state: pr.state,
                                author: pr.user.login,
                                branchName: pr.head.ref,
                                safeBranchName: safeBranchName,
                                url: `./sgex/${safeBranchName}/index.html`,
                                prUrl: pr.html_url,
                                updatedAt: new Date(pr.updated_at).toLocaleDateString(),
                                createdAt: new Date(pr.created_at).toLocaleDateString()
                            };
                        });
                        
                        setPullRequests(formattedPRs);
                        
                        if (githubToken) {
                            await loadDiscussionSummaries(formattedPRs.slice(0, ITEMS_PER_PAGE));
                        }
                    } catch (err) {
                        console.error('Error fetching data:', err);
                        setError(err.message);
                        
                        // Fallback mock data
                        if (err.message.includes('Failed to fetch')) {
                            console.log('Using fallback mock data...');
                            const mockPRs = [
                                {
                                    id: 1,
                                    number: 460,
                                    title: 'Improve multi-page selector landing page for GitHub deployment',
                                    state: 'open',
                                    author: 'copilot',
                                    branchName: 'copilot/fix-459',
                                    safeBranchName: 'copilot-fix-459',
                                    url: './sgex/copilot-fix-459/index.html',
                                    prUrl: 'https://github.com/litlfred/sgex/pull/460',
                                    updatedAt: new Date().toLocaleDateString(),
                                    createdAt: new Date(Date.now() - 86400000).toLocaleDateString()
                                },
                                {
                                    id: 2,
                                    number: 459,
                                    title: 'Add enhanced PR preview functionality',
                                    state: 'open',
                                    author: 'developer',
                                    branchName: 'feature/pr-preview',
                                    safeBranchName: 'feature-pr-preview',
                                    url: './sgex/feature-pr-preview/index.html',
                                    prUrl: 'https://github.com/litlfred/sgex/pull/459',
                                    updatedAt: new Date(Date.now() - 172800000).toLocaleDateString(),
                                    createdAt: new Date(Date.now() - 345600000).toLocaleDateString()
                                }
                            ];
                            setPullRequests(mockPRs);
                            setError(null);
                        }
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, [prFilter, githubToken, loadDiscussionSummaries]);

            // Load summaries when pagination changes
            useEffect(() => {
                if (isAuthenticated && pullRequests.length > 0) {
                    const filtered = pullRequests.filter(pr => 
                        pr.title.toLowerCase().includes(prSearchTerm.toLowerCase()) ||
                        pr.author.toLowerCase().includes(prSearchTerm.toLowerCase())
                    );
                    const sorted = sortPRs(filtered, prSortBy);
                    const paginated = sorted.slice((prPage - 1) * ITEMS_PER_PAGE, prPage * ITEMS_PER_PAGE);
                    loadDiscussionSummaries(paginated);
                }
            }, [prPage, prSearchTerm, prSortBy, pullRequests, isAuthenticated, loadDiscussionSummaries]);

            // Filter and sort PRs
            const filteredPRs = pullRequests.filter(pr => 
                pr.title.toLowerCase().includes(prSearchTerm.toLowerCase()) ||
                pr.author.toLowerCase().includes(prSearchTerm.toLowerCase())
            );
            const sortedPRs = sortPRs(filteredPRs, prSortBy);
            const paginatedPRs = sortedPRs.slice((prPage - 1) * ITEMS_PER_PAGE, prPage * ITEMS_PER_PAGE);
            const totalPRPages = Math.ceil(sortedPRs.length / ITEMS_PER_PAGE);

            if (loading) {
                return (
                    <div className="branch-listing">
                        <h1><img src="./sgex-mascot.png" alt="SGEX Icon" className="sgex-icon" /> SGEX</h1>
                        <p className="subtitle">a collaborative workbench for WHO SMART Guidelines</p>
                        <div className="loading">Loading previews...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="branch-listing">
                        <h1><img src="./sgex-mascot.png" alt="SGEX Icon" className="sgex-icon" /> SGEX</h1>
                        <p className="subtitle">a collaborative workbench for WHO SMART Guidelines</p>
                        <div className="error">
                            <p>Failed to load previews: {error}</p>
                            <p>Please try refreshing the page or check back later.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="branch-listing">
                    <header className="branch-listing-header">
                        <h1><img src="./sgex-mascot.png" alt="SGEX Icon" className="sgex-icon" /> SGEX</h1>
                        <p className="subtitle">a collaborative workbench for WHO SMART Guidelines</p>
                        
                        <div className="prominent-info">
                            <p className="info-text">
                                üêæ This landing page lists all available previews. 
                                Each branch and PR is automatically deployed to its own preview environment.
                            </p>
                        </div>
                        
                        <div className="auth-section">
                            {!isAuthenticated ? (
                                <div className="login-section">
                                    <h3>üîê GitHub Authentication</h3>
                                    <p>Login with your GitHub Personal Access Token to view and add comments to pull requests:</p>
                                    <PATLogin onAuthSuccess={handleAuthSuccess} />
                                </div>
                            ) : (
                                <div className="authenticated-section">
                                    <p>‚úÖ Authenticated - You can now view and add comments to pull requests</p>
                                    <button onClick={handleLogout} className="logout-btn">
                                        Logout
                                    </button>
                                </div>
                            )}
                        </div>
                    </header>

                    <div className="main-actions">
                        <a 
                            href="https://github.com/litlfred/sgex/issues/new" 
                            className="contribute-btn primary"
                            target="_blank"
                            rel="noopener noreferrer"
                        >
                            üêõ Report a Bug
                        </a>
                        <a 
                            href="./sgex/main/docs/" 
                            className="contribute-btn secondary"
                            target="_blank"
                            rel="noopener noreferrer"
                        >
                            üìö Documentation
                        </a>
                        <a 
                            href="https://github.com/litlfred/sgex" 
                            className="contribute-btn tertiary"
                            target="_blank"
                            rel="noopener noreferrer"
                        >
                            üì¶ Source Code
                        </a>
                    </div>

                    <div className="preview-tabs">
                        <button className="tab-button active">
                            üîÑ Pull Request Previews ({sortedPRs.length})
                        </button>
                    </div>

                    <div className="pr-section">
                        <div className="pr-controls">
                            <div className="pr-filter-section">
                                <label htmlFor="pr-filter">Filter PRs:</label>
                                <select
                                    id="pr-filter"
                                    value={prFilter}
                                    onChange={(e) => {
                                        setPrFilter(e.target.value);
                                        setPrPage(1);
                                    }}
                                    className="filter-select"
                                >
                                    <option value="open">Open PRs Only</option>
                                    <option value="closed">Closed PRs Only</option>
                                    <option value="all">All PRs</option>
                                </select>
                            </div>
                            <input
                                type="text"
                                placeholder="Search pull requests by title or author..."
                                value={prSearchTerm}
                                onChange={(e) => {
                                    setPrSearchTerm(e.target.value);
                                    setPrPage(1);
                                }}
                                className="pr-search"
                            />
                            <select
                                value={prSortBy}
                                onChange={(e) => {
                                    setPrSortBy(e.target.value);
                                    setPrPage(1);
                                }}
                                className="sort-select"
                            >
                                <option value="updated">Sort by Recent Updates</option>
                                <option value="number">Sort by PR Number</option>
                                <option value="alphabetical">Sort Alphabetically</option>
                            </select>
                        </div>

                        <div className="pr-cards">
                            {paginatedPRs.length === 0 ? (
                                <div className="no-items">
                                    {prSearchTerm ? (
                                        <p>No pull requests match your search "{prSearchTerm}".</p>
                                    ) : (
                                        <p>No pull request previews available at the moment.</p>
                                    )}
                                </div>
                            ) : (
                                paginatedPRs.map((pr) => (
                                    <div key={pr.id} className="preview-card pr-card">
                                        <div className="card-header">
                                            <h3 className="item-name">#{pr.number}: {pr.title}</h3>
                                            <div className="card-badges">
                                                <span className={`state-badge ${pr.state}`}>
                                                    {pr.state === 'open' ? 'üü¢' : 'üî¥'} {pr.state}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div className="card-body">
                                            <p className="pr-meta">
                                                <strong>Branch:</strong> {pr.branchName} ‚Ä¢ <strong>Author:</strong> {pr.author}
                                            </p>
                                            <p className="item-date">
                                                Created: {pr.createdAt} ‚Ä¢ Updated: {pr.updatedAt}
                                            </p>
                                            
                                            {isAuthenticated && (
                                                <div>
                                                    {/* Discussion Summary Status Bar */}
                                                    <div 
                                                        className="discussion-summary-bar"
                                                        onClick={() => toggleDiscussion(pr.number)}
                                                    >
                                                        <div className="discussion-summary-text">
                                                            <span className="discussion-summary-icon">üí¨</span>
                                                            {getDiscussionSummaryText(pr.number)}
                                                        </div>
                                                        <span className={`discussion-expand-icon ${expandedDiscussions[pr.number] ? 'expanded' : ''}`}>
                                                            ‚ñ∂
                                                        </span>
                                                    </div>

                                                    {/* Expanded Discussion Section */}
                                                    {expandedDiscussions[pr.number] && (
                                                        <div className="discussion-expanded-section">
                                                            <div className="discussion-header">
                                                                <h4 className="discussion-title">Discussion</h4>
                                                                <div className="discussion-actions">
                                                                    <a 
                                                                        href={`https://github.com/litlfred/sgex/pull/${pr.number}/files`}
                                                                        target="_blank"
                                                                        rel="noopener noreferrer"
                                                                        className="discussion-action-btn"
                                                                    >
                                                                        üìÅ View Files
                                                                    </a>
                                                                    <a 
                                                                        href={pr.prUrl}
                                                                        target="_blank"
                                                                        rel="noopener noreferrer"
                                                                        className="discussion-action-btn secondary"
                                                                    >
                                                                        üîó Full Discussion
                                                                    </a>
                                                                </div>
                                                            </div>
                                                            
                                                            {/* Comment Input at Top */}
                                                            <div className="comment-input-section">
                                                                <textarea
                                                                    value={commentInputs[pr.number] || ''}
                                                                    onChange={(e) => setCommentInputs(prev => ({
                                                                        ...prev,
                                                                        [pr.number]: e.target.value
                                                                    }))}
                                                                    placeholder="Add a comment..."
                                                                    className="comment-input"
                                                                    rows={3}
                                                                />
                                                                <button
                                                                    onClick={() => submitComment(pr.number, commentInputs[pr.number])}
                                                                    disabled={!commentInputs[pr.number]?.trim() || submittingComments[pr.number]}
                                                                    className="submit-comment-btn"
                                                                >
                                                                    {submittingComments[pr.number] ? 'Submitting...' : 'Add Comment'}
                                                                </button>
                                                            </div>
                                                            
                                                            {/* Scrollable Comments Area */}
                                                            <div className="discussion-scroll-area">
                                                                {loadingComments ? (
                                                                    <div className="comments-loading">Loading full discussion...</div>
                                                                ) : prComments[pr.number] && prComments[pr.number].length > 0 ? (
                                                                    <div className="comments-list">
                                                                        {prComments[pr.number].map((comment) => (
                                                                            <div key={comment.id} className="comment-item">
                                                                                <div className="comment-header">
                                                                                    <img 
                                                                                        src={comment.avatar_url} 
                                                                                        alt={comment.author} 
                                                                                        className="comment-avatar"
                                                                                    />
                                                                                    <span className="comment-author">{comment.author}</span>
                                                                                    <span className="comment-date">{comment.created_at}</span>
                                                                                </div>
                                                                                <div className="comment-body">{comment.body}</div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                ) : (
                                                                    <div className="no-comments">No comments yet. Be the first to comment!</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            <div className="pr-actions">
                                                <a 
                                                    href={pr.url} 
                                                    className="preview-link"
                                                    rel="noopener noreferrer"
                                                >
                                                    <span>üöÄ View Preview</span>
                                                </a>
                                                
                                                <button 
                                                    className="copy-btn"
                                                    onClick={() => copyToClipboard(pr.url, 'PR', `#${pr.number}`)}
                                                    title="Copy URL to clipboard"
                                                >
                                                    üìã Copy URL
                                                </button>
                                                
                                                <a 
                                                    href={pr.prUrl} 
                                                    className="pr-link"
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    <span>üìã View PR</span>
                                                </a>
                                            </div>
                                        </div>

                                        <div className="card-footer">
                                            <small className="preview-path">
                                                Preview URL: {pr.url}
                                            </small>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {totalPRPages > 1 && (
                            <div className="pagination">
                                <button 
                                    className="pagination-btn"
                                    onClick={() => setPrPage(Math.max(1, prPage - 1))}
                                    disabled={prPage === 1}
                                >
                                    ‚Üê Previous
                                </button>
                                <span className="pagination-info">
                                    Page {prPage} of {totalPRPages} ({sortedPRs.length} total)
                                </span>
                                <button 
                                    className="pagination-btn"
                                    onClick={() => setPrPage(Math.min(totalPRPages, prPage + 1))}
                                    disabled={prPage === totalPRPages}
                                >
                                    Next ‚Üí
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<BranchListing />, document.getElementById('root'));
    </script>
</body>
</html>