<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SGEX Workbench</title>
    <!-- Load SGEX route configuration service -->
    <script>
      // Dynamically determine the correct path for routeConfig.js based on deployment context
      (function() {
        var basePath = '';
        var path = window.location.pathname;
        var pathSegments = path.split('/').filter(Boolean);
        
        // For GitHub Pages deployment (e.g., litlfred.github.io/sgex/)
        if (window.location.hostname.endsWith('.github.io')) {
          if (pathSegments.length > 0 && pathSegments[0] === 'sgex') {
            // For GitHub Pages SGEX deployments
            // Always load routeConfig.js from main deployment path
            // Branch deployments share the same configuration files
            basePath = '/sgex/';
          } else {
            basePath = '/';
          }
        } else {
          // For local development or other deployment types
          // Check if we have /sgex/ prefix for local testing of branch deployments
          if (pathSegments.length > 0 && pathSegments[0] === 'sgex') {
            // Always use /sgex/ base path for consistency
            basePath = '/sgex/';
          } else {
            basePath = '/';
          }
        }
        
        // Load routeConfig.js from the correct base path using synchronous XHR
        // This ensures it loads before the main routing logic executes
        try {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', basePath + 'routeConfig.js', false); // Synchronous request
          xhr.send();
          
          if (xhr.status === 200) {
            // Execute the script content
            eval(xhr.responseText);
            console.log('SGEX route configuration loaded successfully from ' + basePath + 'routeConfig.js');
          } else {
            console.error('Failed to load SGEX route configuration from ' + basePath + 'routeConfig.js: HTTP ' + xhr.status);
            loadViaScriptTag();
          }
        } catch (error) {
          console.error('Error loading SGEX route configuration:', error);
          loadViaScriptTag();
        }
        
        function loadViaScriptTag() {
          // Fallback: try to load via script tag
          var script = document.createElement('script');
          script.src = basePath + 'routeConfig.js';
          script.onerror = function() {
            console.error('Script tag fallback: Failed to load SGEX route configuration from ' + script.src);
          };
          document.head.appendChild(script);
        }
      })();
    </script>
    <script type="text/javascript">
      // SGEX Dynamic URL Routing for GitHub Pages and Local Deployments
      // Supports branch-first URL patterns: /sgex/:branch/:component/:user/:repo/:branch/:asset
      // Uses dynamic route configuration instead of hardcoded component lists
      // Handles both GitHub Pages (/sgex/ prefixed) and local deployment patterns
      // Note: this 404.html file must be at least 512 bytes for it to work
      // with Internet Explorer (it is currently > 512 bytes)

      (function(l) {
        // Main routing function
        function performRouting() {
          // First check if this is an existing redirect to prevent infinite loops
          if (l.search && l.search.indexOf('?/') === 0) {
            console.error('SGEX 404.html: Detected existing redirect, stopping to prevent infinite loop');
            showErrorPage('Redirect Loop Detected', 
              'This URL has already been processed by the routing system but still resulted in a 404. This may indicate a configuration issue.',
              'routing-loop');
            return;
          }

          // Check for branch redirect loops using sessionStorage
          var currentPath = l.pathname;
          var redirectAttempts = JSON.parse(sessionStorage.getItem('sgex-redirect-attempts') || '[]');
          
          // Clean old attempts (older than 30 seconds)
          var now = Date.now();
          redirectAttempts = redirectAttempts.filter(function(attempt) {
            return now - attempt.timestamp < 30000;
          });
          
          // Check if we've already tried this exact path recently (more than 2 times)
          var recentAttempts = redirectAttempts.filter(function(attempt) {
            return attempt.path === currentPath;
          });
          
          if (recentAttempts.length >= 2) {
            console.error('SGEX 404.html: Detected redirect loop for path:', currentPath, 'attempts:', recentAttempts.length);
            
            var pathSegments = currentPath.split('/').filter(Boolean);
            
            // Check if this is a branch deployment failure (optimistic redirect failed)
            if (pathSegments.length >= 3 && pathSegments[0] === 'sgex') {
              var branch = pathSegments[1];
              var component = pathSegments[2];
              
              // Check if this looks like a branch deployment that failed
              if (branch !== 'main' && isValidComponentOrRoute(component, routeConfig)) {
                console.log('SGEX 404.html: Branch deployment not found for branch:', branch);
                showErrorPage(
                  'Branch Deployment Not Found', 
                  'The branch "' + branch + '" does not appear to be deployed. This could mean:\n\n' +
                  '• The branch has not been deployed to GitHub Pages yet\n' +
                  '• The branch deployment is still in progress\n' +
                  '• The branch name was mistyped in the URL\n\n' +
                  'You can try accessing the main deployment instead, or create an issue if you believe this branch should be deployed.',
                  'branch-not-deployed'
                );
                return;
              }
            }
            
            // Enhanced fallback logic: try local branch first, then main
            if (pathSegments.length >= 2 && pathSegments[0] === 'sgex') {
              var branch = pathSegments[1];
              var branchRootPath = '/sgex/' + branch + '/';
              
              // If this is not already a branch root and branch is not 'main'
              if (currentPath !== branchRootPath && branch !== 'main') {
                // Check if we've already tried the branch root
                var branchRootAttempts = redirectAttempts.filter(function(attempt) {
                  return attempt.path === branchRootPath;
                });
                
                if (branchRootAttempts.length < 2) {
                  console.log('SGEX 404.html: Trying local branch fallback first:', branchRootPath);
                  // Try the branch root first
                  l.replace(l.protocol + '//' + l.host + branchRootPath);
                  return;
                } else {
                  console.log('SGEX 404.html: Branch root also failed, falling back to main');
                  // Branch root has also been tried, fall back to main
                  sessionStorage.removeItem('sgex-redirect-attempts');
                  l.replace(l.protocol + '//' + l.host + '/sgex/');
                  return;
                }
              } else {
                // Already at branch root or this is main branch, fall back to main
                console.log('SGEX 404.html: Falling back to main deployment');
                sessionStorage.removeItem('sgex-redirect-attempts');
                l.replace(l.protocol + '//' + l.host + '/sgex/');
                return;
              }
            } else {
              // Clear redirect attempts and fall back to main SGEX root for other cases
              sessionStorage.removeItem('sgex-redirect-attempts');
              redirectToSPA('/sgex/', '');
              return;
            }
          }
          
          // Record this attempt
          redirectAttempts.push({
            path: currentPath,
            timestamp: now
          });
          sessionStorage.setItem('sgex-redirect-attempts', JSON.stringify(redirectAttempts));

          var pathSegments = l.pathname.split('/').filter(Boolean);
          
          // Check if this is GitHub Pages deployment
          var isGitHubPages = l.hostname === 'litlfred.github.io' || l.hostname.endsWith('.github.io');

          if (isGitHubPages) {
            // GitHub Pages deployment - handle /sgex/ prefixed URLs
            handleGitHubPagesDeployment(pathSegments, l);
          } else {
            // Local deployment - handle both /sgex/ prefixed and root-level URLs
            handleLocalDeployment(pathSegments, l);
          }
        }

        // Ensure DOM is loaded before performing routing
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', performRouting);
        } else {
          // DOM already loaded, execute immediately
          performRouting();
        }

        function isValidComponentOrRoute(pathSegment, routeConfig) {
          // Check if it's a valid DAK component
          if (routeConfig && routeConfig.isValidDAKComponent && routeConfig.isValidDAKComponent(pathSegment)) {
            return true;
          }
          
          // Check if it's a valid standard route path
          if (routeConfig && routeConfig.standardComponents) {
            for (var componentName in routeConfig.standardComponents) {
              var component = routeConfig.standardComponents[componentName];
              if (component.routes) {
                for (var i = 0; i < component.routes.length; i++) {
                  var route = component.routes[i];
                  // Handle exact route matches like "/select_profile"
                  if (route.path === '/' + pathSegment) {
                    return true;
                  }
                }
              }
            }
          }
          
          return false;
        }

        function handleGitHubPagesDeployment(pathSegments, l) {
          // GitHub Pages deployment - check URL pattern
          if (pathSegments.length === 0 || pathSegments[0] !== 'sgex') {
            showErrorPage('Invalid URL Pattern', 
              'Expected URL to start with /sgex/ but got: ' + l.pathname,
              'invalid-base-path');
            return;
          }

          if (pathSegments.length === 1) {
            // /sgex/ - redirect to root
            redirectToSPA('/sgex/', '');
            return;
          }

          var secondSegment = pathSegments[1];
          
          // Special case: Documentation routes
          if (secondSegment === 'docs') {
            // /sgex/docs/... - main docs without branch
            handleDocumentationRoute(pathSegments.slice(1), l, '/sgex/');
            return;
          }

          // Check for branch deployment patterns
          if (pathSegments.length === 2) {
            // /sgex/{branch}/ - branch landing page
            var branchPath = '/sgex/' + secondSegment + '/';
            redirectToSPA(branchPath, '');
            return;
          }

          if (pathSegments.length === 3 && pathSegments[2] === 'index.html') {
            // /sgex/{branch}/index.html - redirect to branch root
            var branchPath = '/sgex/' + secondSegment + '/';
            console.log('SGEX Branch Deployment Redirect (index.html):', {
              from: l.pathname,
              to: branchPath,
              branch: secondSegment
            });
            l.replace(l.protocol + '//' + l.host + branchPath);
            return;
          }

          var thirdSegment = pathSegments[2];

          // Special case: Branch-specific documentation
          if (thirdSegment === 'docs') {
            // /sgex/{branch}/docs/... - branch-specific docs
            handleDocumentationRoute(pathSegments.slice(2), l, '/sgex/' + secondSegment + '/');
            return;
          }

          // Check if this looks like a DAK component pattern: /sgex/{component}/{user}/{repo}/...
          if (pathSegments.length >= 4 && isDakComponentPattern(pathSegments)) {
            // Component-first pattern: /sgex/{component}/{user}/{repo}/{branch?}/{asset?}
            handleDAKComponentRoute(pathSegments.slice(1), l, '/sgex/');
            return;
          }

          // Check if this is a valid routing pattern
          var routeConfig = null;
          try {
            routeConfig = typeof window !== 'undefined' && window.getSGEXRouteConfig ? window.getSGEXRouteConfig() : null;
          } catch (error) {
            console.warn('Failed to get route configuration:', error);
          }

          // Check patterns: deployed branch, unknown branch with valid component, or component-first
          if (pathSegments.length >= 3 && routeConfig) {
            var branch = secondSegment;
            var component = pathSegments[2];
            
            // Check if this could be a branch deployment: /sgex/{branch}/{component}/...
            if (isValidComponentOrRoute(component, routeConfig)) {
              // Optimistic approach: assume branch is deployed and try to redirect to it first
              var branchPath = '/sgex/' + branch + '/';
              var routePath = pathSegments.slice(2).join('/');
              
              // Store branch and repo/org context in session storage if available
              storeRouteContext(pathSegments);
              
              // Try to redirect to branch deployment
              // If branch doesn't exist, this will result in another 404 that we'll handle gracefully
              redirectToSPA(branchPath, routePath);
              return;
            }
            }
          }
          
          // Check if this is a component-first pattern: /sgex/{component}/{user}/{repo}/...
          if (pathSegments.length >= 4 && routeConfig && isValidComponentOrRoute(secondSegment, routeConfig)) {
            // Component-first pattern: /sgex/{component}/{user}/{repo}/{branch?}
            // Route to main SPA  
            var routePath = pathSegments.slice(1).join('/'); // Remove 'sgex' prefix
            
            // Store repo/org context in session storage if available
            storeRouteContext(pathSegments);
            
            redirectToSPA('/sgex/', routePath);
            return;
          }
          
          // Check if second segment is just length 2 (likely branch with no component)
          if (pathSegments.length === 2) {
            // /sgex/{branch}/ - redirect to branch root
            var branchPath = '/sgex/' + secondSegment + '/';
            redirectToSPA(branchPath, '');
            return;
          }

          // Unknown pattern - show error
          showErrorPage('Unknown URL Pattern', 
            'The URL pattern is not recognized. Expected either /sgex/:branch/:component or /sgex/:component/:user/:repo (with optional :branch/:asset) but got: ' + l.pathname,
            'unknown-pattern');
        }

        function handleLocalDeployment(pathSegments, l) {
          // Local deployment - support both /sgex/ prefixed and root-level URLs
          var hasStandardPrefix = pathSegments.length > 0 && pathSegments[0] === 'sgex';
          var basePath = hasStandardPrefix ? '/sgex/' : '/';
          
          if (!hasStandardPrefix) {
            // Root-level URLs - redirect to /sgex/ for consistency
            var routePath = pathSegments.join('/');
            redirectToSPA('/sgex/', routePath);
            return;
          }

          // Handle /sgex/ prefixed URLs
          if (pathSegments.length <= 1) {
            // /sgex/ - root path
            redirectToSPA(basePath, '');
            return;
          }

          var firstSegment = pathSegments[1];

          // Special case: Documentation routes
          if (firstSegment === 'docs') {
            // /sgex/docs/... - documentation
            handleDocumentationRoute(pathSegments.slice(1), l, basePath);
            return;
          }

          // Check if this looks like a DAK component pattern: /sgex/{component}/{user}/{repo}/...
          if (pathSegments.length >= 4 && isDakComponentPattern(pathSegments)) {
            // Component pattern: /sgex/{component}/{user}/{repo}/{branch?}/{asset?}
            handleDAKComponentRoute(pathSegments.slice(1), l, basePath);
            return;
          }

          // Check if this is a valid routing pattern
          var routeConfig = null;
          try {
            routeConfig = typeof window !== 'undefined' && window.getSGEXRouteConfig ? window.getSGEXRouteConfig() : null;
          } catch (error) {
            console.warn('Failed to get route configuration:', error);
          }

          // Check patterns: branch with valid component, or component-first
          if (pathSegments.length >= 3 && routeConfig) {
            var branch = firstSegment;
            var component = pathSegments[2];
            
            // Check if this could be a branch deployment: /sgex/{branch}/{component}/...
            if (isValidComponentOrRoute(component, routeConfig)) {
              // Valid component, treat as branch deployment
              var routePath = pathSegments.slice(1).join('/');
              
              // Store repo/org context in session storage if available
              storeRouteContext(pathSegments);
              
              redirectToSPA(basePath, routePath);
              return;
            }
          }
          
          // Check if this is a component-first pattern: /sgex/{component}/{user}/{repo}/...
          if (pathSegments.length >= 4 && routeConfig && isValidComponentOrRoute(firstSegment, routeConfig)) {
            // Component-first pattern: /sgex/{component}/{user}/{repo}/{branch?}
            // Route to SPA
            var routePath = pathSegments.slice(1).join('/');
            
            // Store repo/org context in session storage if available
            storeRouteContext(pathSegments);
            
            redirectToSPA(basePath, routePath);
            return;
          }
          
          // Check if first segment is just length 2 (likely branch with no component)
          if (pathSegments.length === 2) {
            // /sgex/{branch}/ - redirect to root
            redirectToSPA(basePath, '');
            return;
          }

          // Unknown pattern - show error
          showErrorPage('Unknown URL Pattern', 
            'The URL pattern is not recognized. Expected either /sgex/:branch/:component or /sgex/:component/:user/:repo (with optional :branch/:asset) but got: ' + l.pathname,
            'unknown-pattern');
        }

        function handleStandaloneDeployment(pathSegments, l) {
          // Legacy function - kept for backward compatibility
          var routePath = pathSegments.join('/');
          if (routePath) {
            redirectToSPA('/', routePath);
          }
        }

        function handleDocumentationRoute(docSegments, l, basePath) {
          // Handle documentation routing: /docs/{docId?}
          // docSegments = ['docs', 'docId'] or ['docs']
          
          var docId = docSegments.length > 1 ? docSegments[1] : 'overview';
          var routePath = 'docs';
          
          if (docId && docId !== 'overview') {
            routePath += '/' + docId;
          }
          
          console.log('SGEX Documentation Route:', {
            from: l.pathname,
            basePath: basePath,
            docId: docId,
            routePath: routePath
          });
          
          redirectToSPA(basePath, routePath);
        }

        function isDakComponentPattern(pathSegments) {
          // Check if path looks like: /sgex/{component}/{user}/{repo}/...
          // This is a heuristic - if we have at least 4 segments and the pattern looks like a repository,
          // we assume it's a DAK component pattern
          
          if (pathSegments.length < 4) return false;
          
          var component = pathSegments[1];
          var user = pathSegments[2];
          var repo = pathSegments[3];
          
          // Simple heuristics: 
          // - component doesn't look like a branch name (no dots, reasonable length)
          // - user/repo look like GitHub identifiers (alphanumeric, dashes, underscores)
          var isValidComponent = component && component.length > 2 && !component.includes('.');
          var isValidUser = user && /^[a-zA-Z0-9._-]+$/.test(user);
          var isValidRepo = repo && /^[a-zA-Z0-9._-]+$/.test(repo);
          
          return isValidComponent && isValidUser && isValidRepo;
        }

        function handleDAKComponentRoute(componentSegments, l, basePath) {
          // Handle DAK component routing: /{component}/{user}/{repo}/{branch?}/{asset?}
          // Store repo/org context and route to SPA
          
          var component = componentSegments[0];
          var user = componentSegments[1]; 
          var repo = componentSegments[2];
          var branch = componentSegments.length > 3 ? componentSegments[3] : null;
          var asset = componentSegments.length > 4 ? componentSegments[4] : null;
          
          // Store context in session storage
          try {
            if (typeof Storage !== 'undefined') {
              sessionStorage.setItem('sgex_selected_user', user);
              sessionStorage.setItem('sgex_selected_repo', repo);
              if (branch) {
                sessionStorage.setItem('sgex_selected_branch', branch);
              }
            }
          } catch (error) {
            console.warn('Could not store route context in session storage:', error);
          }
          
          var routePath = componentSegments.join('/');
          
          console.log('SGEX DAK Component Route:', {
            from: l.pathname,
            component: component,
            user: user,
            repo: repo,
            branch: branch,
            asset: asset,
            routePath: routePath
          });
          
          redirectToSPA(basePath, routePath);
        }

        function storeRouteContext(pathSegments) {
          // Store route context in session storage for later use
          // Look for patterns that might contain user/repo information
          
          try {
            if (typeof Storage === 'undefined') return;
            
            // For DAK component patterns: /{component}/{user}/{repo}/...
            if (pathSegments.length >= 4 && isDakComponentPattern(pathSegments)) {
              var user = pathSegments[2];
              var repo = pathSegments[3];
              sessionStorage.setItem('sgex_selected_user', user);
              sessionStorage.setItem('sgex_selected_repo', repo);
              
              if (pathSegments.length > 4) {
                sessionStorage.setItem('sgex_selected_branch', pathSegments[4]);
              }
            }
            
            // For branch deployment patterns: /{branch}/{component}/{user}/{repo}/...
            if (pathSegments.length >= 5) {
              var user = pathSegments[3];
              var repo = pathSegments[4];
              if (user && repo && /^[a-zA-Z0-9._-]+$/.test(user) && /^[a-zA-Z0-9._-]+$/.test(repo)) {
                sessionStorage.setItem('sgex_selected_user', user);
                sessionStorage.setItem('sgex_selected_repo', repo);
                
                if (pathSegments.length > 5) {
                  sessionStorage.setItem('sgex_selected_branch', pathSegments[5]);
                }
              }
            }
          } catch (error) {
            console.warn('Could not store route context in session storage:', error);
          }
        }

        function redirectToSPA(basePath, routePath) {
          var newUrl = l.protocol + '//' + l.host + basePath;
          
          // Add route path as query parameter
          if (routePath) {
            newUrl += '?/' + routePath.replace(/&/g, '~and~');
          }
          
          // Preserve existing query parameters
          if (l.search && l.search !== '?/') {
            var existingParams = l.search;
            if (existingParams.startsWith('?')) {
              existingParams = existingParams.substring(1);
            }
            
            if (routePath) {
              newUrl += '&' + existingParams.replace(/&/g, '~and~');
            } else {
              newUrl += '?' + existingParams.replace(/&/g, '~and~');
            }
          }
          
          // Preserve hash
          if (l.hash) {
            newUrl += l.hash;
          }
          
          console.log('SGEX SPA Routing Redirect:', {
            from: l.pathname + l.search + l.hash,
            to: newUrl,
            basePath: basePath,
            routePath: routePath,
            preservedQuery: l.search,
            preservedHash: l.hash
          });
          
          l.replace(newUrl);
        }

        function showErrorPage(title, message, errorCode) {
          var bugReportUrl = 'https://github.com/litlfred/sgex/issues/new?' + 
            'title=' + encodeURIComponent('[URL Routing Error] ' + title) +
            '&body=' + encodeURIComponent(
              'Error Code: ' + errorCode + '\n\n' +
              'URL: ' + l.href + '\n' +
              'Hostname: ' + l.hostname + '\n' +
              'Path: ' + l.pathname + '\n' +
              'Search: ' + l.search + '\n' +
              'Hash: ' + l.hash + '\n\n' +
              'Message: ' + message + '\n\n' +
              'Please describe what you were trying to do when this error occurred:'
            ) +
            '&labels=' + encodeURIComponent('bug,routing');

          var errorHTML = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; text-align: center;">' +
              '<h1 style="color: #d73527;">SGEX URL Routing Error</h1>' +
              '<h2>' + title + '</h2>' +
              '<p style="background: #f5f5f5; padding: 15px; border-radius: 5px; text-align: left;">' + message + '</p>' +
              '<p><strong>Error Code:</strong> ' + errorCode + '</p>' +
              '<div style="margin: 30px 0;">' +
                '<a href="https://litlfred.github.io/sgex/" style="background: #0078d4; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">Go to SGEX Home</a>' +
                '<a href="' + bugReportUrl + '" target="_blank" style="background: #d73527; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 5px;">Report Bug</a>' +
              '</div>' +
              '<p style="color: #666; font-size: 12px;">If you think this is a bug, please use the "Report Bug" button to help us fix it.</p>' +
            '</div>';

          // Ensure DOM is ready before setting innerHTML
          function setErrorHTML() {
            if (document.body) {
              document.body.innerHTML = errorHTML;
            } else {
              // DOM not ready yet, wait for it
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                  document.body.innerHTML = errorHTML;
                });
              } else {
                // DOM should be ready, but body still doesn't exist - create it
                setTimeout(function() {
                  if (document.body) {
                    document.body.innerHTML = errorHTML;
                  } else {
                    // Last resort: create a basic error display
                    document.write('<body>' + errorHTML + '</body>');
                  }
                }, 10);
              }
            }
          }
          
          setErrorHTML();
        }

      })(window.location);
    </script>
  </head>
  <body>
    <!-- This 404.html handles dynamic SPA routing for SGEX -->
    <!-- Supports branch-first patterns: /sgex/:branch/:component/:user/:repo/:branch/:asset -->
    <!-- Works for both GitHub Pages and local deployments (npm install) -->
    <!-- Uses route configuration instead of hardcoded component lists -->
    <!-- Includes proper error handling and bug reporting -->
  </body>
</html>