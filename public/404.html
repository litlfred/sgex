<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SGEX Workbench</title>
    <script type="text/javascript">
      // SGEX GitHub Pages SPA Routing - Hybrid Approach
      // Combines upstream sophisticated routing logic with embedded configuration
      // Eliminates external routeConfig.js dependencies that cause deployment issues
      // Note: this 404.html file must be at least 512 bytes for it to work
      // with Internet Explorer (it is currently > 512 bytes)

      (function(l) {
        // Embedded route configuration (replaces external routeConfig.js)
        function getRouteConfiguration() {
          return {
            deployedBranches: ['main', 'deploy', 'copilot-fix-780'],
            dakComponents: ['dashboard', 'docs', 'core-data-dictionary-viewer', 'business-process-selection'],
            
            isDeployedBranch: function(segment) {
              return this.deployedBranches.indexOf(segment) !== -1;
            },
            
            isValidComponent: function(segment) {
              return this.dakComponents.indexOf(segment) !== -1;
            }
          };
        }

        // Show error page with detailed information
        function showErrorPage(title, message, errorCode) {
          document.body.innerHTML = '<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; border: 1px solid #ddd; background: #f9f9f9;">' +
            '<h2 style="color: #d32f2f;">SGEX Routing Error</h2>' +
            '<h3>' + title + '</h3>' +
            '<p>' + message + '</p>' +
            '<p><strong>Error Code:</strong> ' + errorCode + '</p>' +
            '<p><strong>URL:</strong> ' + l.href + '</p>' +
            '<p><strong>Hostname:</strong> ' + l.hostname + '</p>' +
            '<p><strong>Path:</strong> ' + l.pathname + '</p>' +
            '<p><strong>Search:</strong> ' + l.search + '</p>' +
            '<p><strong>Hash:</strong> ' + l.hash + '</p>' +
            '</div>';
        }

        // Redirect to SPA with proper URL encoding
        function redirectToSPA(basePath, routePath) {
          var newUrl = l.protocol + '//' + l.hostname + (l.port ? ':' + l.port : '') +
            basePath + (routePath ? '?/' + routePath.replace(/&/g, '~and~') : '') +
            (l.search ? (routePath ? '&' : '?') + l.search.slice(1).replace(/&/g, '~and~') : '') +
            l.hash;
          
          console.log('SGEX SPA Redirect:', {
            from: l.pathname,
            to: newUrl,
            basePath: basePath,
            routePath: routePath
          });
          
          l.replace(newUrl);
        }

        // Handle branch deployment pattern: /sgex/:branch/:component/...
        function handleBranchDeployment(pathSegments, l, routeConfig, basePrefix) {
          if (pathSegments.length < 3) {
            // Just /sgex/:branch/ - redirect to branch root
            redirectToSPA(basePrefix + pathSegments[1] + '/', '');
            return;
          }

          var branch = pathSegments[1];
          var component = pathSegments[2];
          
          if (!routeConfig.isValidComponent(component)) {
            showErrorPage('Invalid Component', 
              'Component "' + component + '" is not recognized. Valid components: ' + routeConfig.dakComponents.join(', '),
              'invalid-component');
            return;
          }

          // Build route path from remaining segments
          var routePath = pathSegments.slice(2).join('/');
          redirectToSPA(basePrefix + branch + '/', routePath);
        }

        // Handle component-first pattern: /sgex/:component/:user/:repo/:branch
        function handleComponentFirst(pathSegments, l, basePrefix) {
          var routePath = pathSegments.slice(1).join('/');
          redirectToSPA(basePrefix, routePath);
        }

        // Main routing function
        function performRouting() {
          // First check if this is an existing redirect to prevent infinite loops
          if (l.search && l.search.indexOf('?/') === 0) {
            console.error('SGEX 404.html: Detected existing redirect, stopping to prevent infinite loop');
            showErrorPage('Redirect Loop Detected', 
              'This URL has already been processed by the routing system but still resulted in a 404. This may indicate a configuration issue.',
              'routing-loop');
            return;
          }

          var pathSegments = l.pathname.split('/').filter(Boolean);
          
          // Check if this is GitHub Pages deployment
          var isGitHubPages = l.hostname === 'litlfred.github.io' || l.hostname.endsWith('.github.io');
          var routeConfig = getRouteConfiguration();

          if (isGitHubPages) {
            // GitHub Pages deployment - handle /sgex/ prefixed URLs
            handleGitHubPagesDeployment(pathSegments, l, routeConfig);
          } else {
            // Local deployment - handle both /sgex/ prefixed and root-level URLs
            handleLocalDeployment(pathSegments, l, routeConfig);
          }
        }

        function handleGitHubPagesDeployment(pathSegments, l, routeConfig) {
          // GitHub Pages deployment - check URL pattern
          if (pathSegments.length === 0 || pathSegments[0] !== 'sgex') {
            showErrorPage('Invalid URL Pattern', 
              'Expected URL to start with /sgex/ but got: ' + l.pathname,
              'invalid-base-path');
            return;
          }

          if (pathSegments.length === 1) {
            // Just /sgex/ - redirect to root
            redirectToSPA('/sgex/', '');
            return;
          }

          // Check if second segment is a deployed branch
          var secondSegment = pathSegments[1];
          
          if (routeConfig.isDeployedBranch(secondSegment)) {
            // Branch deployment pattern: /sgex/:branch/:component/...
            handleBranchDeployment(pathSegments, l, routeConfig, '/sgex/');
          } else if (routeConfig.isValidComponent(secondSegment)) {
            // Component-first pattern: /sgex/:component/:user/:repo/:branch
            handleComponentFirst(pathSegments, l, '/sgex/');
          } else {
            // Unknown pattern - show error
            showErrorPage('Unknown URL Pattern', 
              'The URL pattern is not recognized. Expected either /sgex/:branch/:component or /sgex/:component/:user/:repo (with optional :branch/:asset) but got: ' + l.pathname,
              'unknown-pattern');
          }
        }

        function handleLocalDeployment(pathSegments, l, routeConfig) {
          // Local deployment - can be either /sgex/ prefixed or root-level
          if (pathSegments.length > 0 && pathSegments[0] === 'sgex') {
            // /sgex/ prefixed local deployment
            handleGitHubPagesDeployment(pathSegments, l, routeConfig);
          } else {
            // Root-level local deployment
            if (pathSegments.length === 0) {
              redirectToSPA('/', '');
            } else {
              var routePath = pathSegments.join('/');
              redirectToSPA('/', routePath);
            }
          }
        }

        // Ensure DOM is loaded before performing routing
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', performRouting);
        } else {
          // DOM already loaded, execute immediately
          performRouting();
        }

      })(window.location);

    </script>
  </head>
  <body>
    <!-- SGEX GitHub Pages SPA Routing -->
    <!-- Hybrid approach combining upstream sophisticated routing with embedded configuration -->
    <!-- Eliminates external routeConfig.js dependencies while maintaining full functionality -->
    <!-- Supports both branch deployments (/sgex/:branch/:component) and component-first routing (/sgex/:component/:user/:repo) -->
    <!-- Provides detailed error messages for debugging deployment issues -->
    <!-- Compatible with Internet Explorer (>512 bytes) and modern browsers -->
  </body>
</html>